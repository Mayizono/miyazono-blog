<!-- build time:Tue Sep 07 2021 18:28:45 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/5_%E6%97%A5%E6%B4%BB/"><title>| Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"></h1><div class="meta"><span class="item" title="创建时间：2021-08-31 19:33:50"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-31T19:33:50+08:00">2021-08-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>47k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>43 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclga70tsj20zk0m84mr.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipevuctzzj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclx29mstj20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclhfehz7j20zk0m8u0x.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciub8ja1j20zk0m81ky.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/5_%E6%97%A5%E6%B4%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><hr><h2 id="title实时数仓之日活"><a class="anchor" href="#title实时数仓之日活">#</a> title: 实时数仓之日活</h2><h1 id="实时数仓之日活"><a class="anchor" href="#实时数仓之日活">#</a> 实时数仓之日活</h1><h2 id="一-需求概述"><a class="anchor" href="#一-需求概述">#</a> 一、 需求概述</h2><h3 id="11-离线与实时需求"><a class="anchor" href="#11-离线与实时需求">#</a> 1.1 离线与实时需求</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 离线需求：t + 1 </span></pre></td></tr><tr><td data-num="2"></td><td><pre>       a、一般是根据前一日的数据生成报表等数据</pre></td></tr><tr><td data-num="3"></td><td><pre>       b、统计指标、报表繁多</pre></td></tr><tr><td data-num="4"></td><td><pre>       c、但是对时效性不敏感。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 2. 实时需求：t + 0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      a、侧重于对当日数据的实时监控</pre></td></tr><tr><td data-num="7"></td><td><pre>      b、通常业务逻辑相对离线需求简单</pre></td></tr><tr><td data-num="8"></td><td><pre>      c、统计指标也少一些</pre></td></tr><tr><td data-num="9"></td><td><pre>      e、更注重数据的时效性以及用户的交互性。</pre></td></tr></table></figure><h3 id="12-离线处理架构"><a class="anchor" href="#12-离线处理架构">#</a> 1.2 离线处理架构</h3><p>离线分析架构（如 Hive，Map/Reduce，Spark Sql 等）可以满足数据后分析，数据挖掘的应用需求。</p><p>![1594884977794](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233301.png)</p><h3 id="13-实时处理架构"><a class="anchor" href="#13-实时处理架构">#</a> 1.3 实时处理架构</h3><p>对于实时性要求高的应用，如用户即时详单查询，业务量监控等，需要应用实时处理架构。</p><p>![1594884986844](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233307.png)</p><h3 id="14-需求"><a class="anchor" href="#14-需求">#</a> 1.4 需求</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>本次一共有如下<span class="token number">6</span>个需求需要进行实现，那么本案例中只说明<span class="token number">4</span>个需求。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">'需求1'</span>: 当日活跃用户及分时趋势图，昨日对比图<span class="token punctuation">(</span>主讲<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">'需求2'</span>: 当日新增用户数及分时趋势图，昨日对比图</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token string">'需求3'</span>: 当日交易额及分时趋势图，昨日对比图<span class="token punctuation">(</span>主讲<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token string">'需求4'</span>: 当日订单数及分时趋势图，昨日对比图</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token string">'需求5'</span>: 购物券功能风险预警</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token string">'需求6'</span>: 用户购买明细灵活分析功能</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>需求说明：</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">1.</span> sparkStreaming实时消费kakfa中的数据；</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">2.</span> mysql中的业务数据使用cannl实时监控，一旦出现变化的数据，就发送到kafka中。</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">3.</span> sparkstreaming处理后的数据会可以发送到es、hbase、mysql、redis中</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">4.</span> 前端通过可视化软件或者是通过springboot创建接口来实现</pre></td></tr></table></figure><h3 id="15-实现原理"><a class="anchor" href="#15-实现原理">#</a> 1.5 实现原理</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 框架：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   第一部分：模拟数据，代码生成</pre></td></tr><tr><td data-num="3"></td><td><pre>   第二部分：搭建nginx</pre></td></tr><tr><td data-num="4"></td><td><pre>   第三部分<span class="token number">1</span>：搭建日志服务器，并将数据写到kafka中，使用springboot实现</pre></td></tr><tr><td data-num="5"></td><td><pre>   第三部分<span class="token number">2</span>：搭建canal，实时监控mysql中数据的变化，并将变化的数据写到kafka中</pre></td></tr><tr><td data-num="6"></td><td><pre>   第四部分：编辑sparkstreaming代码，实现从kafka中读取数据，并进行数据的处理</pre></td></tr><tr><td data-num="7"></td><td><pre>   第五部分: 处理好的数据写到redis、mysql、es、hbase中。</pre></td></tr><tr><td data-num="8"></td><td><pre>   第六部分：可以mybaits创建接口来实现，也可以通过可视化界面来实现。</pre></td></tr><tr><td data-num="9"></td><td><pre>   </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">-- 2. 不同的需求采用不同的实现原理。</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string">'需求1'</span>: 当日活跃用户及分时趋势图，昨日对比图<span class="token punctuation">(</span>主讲<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    	<span class="token comment">-- 流程：数据模拟 -> nginx -> 日志服务器 -> kafka -> sparkstreaming ->  hbase -> mybaits -> 网页展示（可视化）</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token string">'需求2'</span>: 当日新增用户数及分时趋势图，昨日对比图 <span class="token comment">-- 不讲</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token string">'需求3'</span>: 当日交易额及分时趋势图，昨日对比图</pre></td></tr><tr><td data-num="15"></td><td><pre>    	<span class="token comment">-- 流程：数据模拟 -> nginx -> 日志服务器 -> mysql -> kafka -> sparkstreaming ->  hbase -> mybaits -> 数据展示</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token string">'需求4'</span>: 当日订单数及分时趋势图，昨日对比图  <span class="token comment">-- 不讲</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token string">'需求5'</span>: 购物券功能风险预警</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">-- 流程：数据模拟 -> nginx -> 日志服务器  -> kafka -> sparkstreaming ->  es-> kibana 可视化</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token string">'需求6'</span>: 用户购买明细灵活分析功能</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">-- 3. 本文梳理的过程为：</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     <span class="token number">1.</span> 数据采集：服务器写到kafka中</pre></td></tr><tr><td data-num="23"></td><td><pre>        a、用户行为数据，从模拟数据，到接收到web服务器数据，再从日志服务器到kafka；</pre></td></tr><tr><td data-num="24"></td><td><pre>        b、业务数据采集，从数据库实时采集到kafka中</pre></td></tr><tr><td data-num="25"></td><td><pre>     <span class="token number">2.</span> 实时计算：redis ， hbase <span class="token operator">+</span> phoenix，结果存储到es、mysql、redis、hbase</pre></td></tr><tr><td data-num="26"></td><td><pre>     <span class="token number">3.</span> 数据接口服务开发，为前</pre></td></tr><tr><td data-num="27"></td><td><pre>     <span class="token number">4.</span> Bi、可视化配置</pre></td></tr><tr><td data-num="28"></td><td><pre>     </pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">-- 4. 每一个不同的需求都会有很多的依赖需要添加，那么添加一个依赖，咱们说一个。</span></pre></td></tr></table></figure><h2 id="二-项目准备部分"><a class="anchor" href="#二-项目准备部分">#</a> 二、项目准备部分</h2><p>&lt;img src=&quot;<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233313.png&quot; alt=&quot;1594885004104&quot; style=&quot;zoom:150%;&quot; /&gt;</p><blockquote><p>本次实时项目省略 flume</p></blockquote><h3 id="21-创建gmall0213工程"><a class="anchor" href="#21-创建gmall0213工程">#</a> 2.1 创建 gmall0213 工程</h3><p>创建 maven 项目</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 该工程的有一个主要的任务：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   负责依赖和依赖版本的控制的作用。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 2. 依赖文件说明：</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">1.</span> properties中是定义了一些变量，后续使用时，只需要使用变量的值即可，当需求进行版本升级时，只需要变更变量的值就可以实现。</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token operator">&lt;</span>properties<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token number">2.</span> 属于版本的声明，子模块继承父模块时，则不需要再声明版本，也是用于依赖版本的管理。</pre></td></tr><tr><td data-num="9"></td><td><pre>     <span class="token operator">&lt;</span>dependencyManagement<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token operator">&lt;</span><span class="token operator">/</span>dependencyManagement<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">-- 3. 父工程的作用：依赖版本的管理。</span></pre></td></tr></table></figure><ul><li>添加依赖</li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.version</span><span class="token punctuation">></span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.version</span><span class="token punctuation">></span></span>2.12.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log4j.version</span><span class="token punctuation">></span></span>1.2.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log4j.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slf4j.version</span><span class="token punctuation">></span></span>1.7.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slf4j.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fastjson.version</span><span class="token punctuation">></span></span>1.2.47<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fastjson.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpclient.version</span><span class="token punctuation">></span></span>4.5.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>httpclient.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpmime.version</span><span class="token punctuation">></span></span>4.3.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>httpmime.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">></span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">&lt;!-- 此处放日志包，所有项目都要引用 --></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">&lt;!-- 所有子项目的日志框架 --></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jcl-over-slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;slf4j.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;slf4j.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;slf4j.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">&lt;!-- 具体的日志实现 --></span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;log4j.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.httpcomponents/httpclient --></span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;httpclient.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpmime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;httpmime.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;fastjson.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-core_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spark.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-hive_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spark.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-sql_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spark.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-streaming_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spark.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-streaming-kafka-0-10_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spark.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token comment">&lt;!-- 该插件用于将 Scala 代码编译成 class 文件 --></span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="99"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="100"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.4.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="101"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="102"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    <span class="token comment">&lt;!-- 声明绑定到 maven 的 compile 阶段 --></span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="105"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="106"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="107"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="108"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><ul><li><strong>Maven 整体依赖结构</strong></li></ul><p>![1594812372205](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233329.png)</p><h3 id="22-创建common子模块"><a class="anchor" href="#22-创建common子模块">#</a> 2.2 创建 common 子模块</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 该模块的作用：这个模块内放一些通用代码，各大模块都会使用到的代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 2. 所有模块都会加入 common 模块的依赖</span></pre></td></tr></table></figure><ol><li><p>模块名：gmall-common</p></li><li><p>添加依赖</p></li></ol><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpmime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h2 id="三-模拟数据部分"><a class="anchor" href="#三-模拟数据部分">#</a> 三、模拟数据部分</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 说明：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   该模拟数据部分，在实际开发过程中，是实时的数据，不需要我们处理，但是可以用来做一些数据验证。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 2. 代码：</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   此部分的代码不要求掌握，需要知道含义和逻辑就可以。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 3. 模拟数据发送流程：</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   一共分为三个部分：</pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token number">1.</span> 模拟数据发送日志请求  <span class="token comment">--> 由 Windows idea springboot web 服务器接收并发送到 kafka，落盘日志文件；</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token number">2.</span> springboot 打包 <span class="token operator">-</span><span class="token operator">></span> 部署到linux下 <span class="token operator">-</span><span class="token operator">></span> 模拟数据发送日志请求 <span class="token operator">-</span><span class="token operator">></span> jar程序接收，发送kafka，并落盘数据</pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token number">3.</span> 模拟数据发送日志请求 <span class="token operator">-</span><span class="token operator">></span> nginx <span class="token operator">-</span><span class="token operator">></span> 三台日志服务器 <span class="token operator">-</span><span class="token operator">></span> 三台一起写入kafka，落盘日志文件。</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">-- 4. 该部分属于发送数据，由于不同模式下参数有所差异，届时一一说明</span></pre></td></tr></table></figure><ol><li>模块名：gmall-mock</li><li>添加依赖</li></ol><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall0213<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="31-randomnumutil-工具类"><a class="anchor" href="#31-randomnumutil-工具类">#</a> 3.1 RandomNumUtil 工具类</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 该类的作用：生成随机整数的工具类</span></pre></td></tr></table></figure><ul><li>代码</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Random</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  * 生成随机数据的工具</pre></td></tr><tr><td data-num="6"></td><td><pre>  */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">object</span> RandomNumUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">/* 随机数生成器对象 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token keyword">new</span> Random<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    * 生成随机的整数，区间: [from, to]</pre></td></tr><tr><td data-num="13"></td><td><pre>    *</pre></td></tr><tr><td data-num="14"></td><td><pre>    * @param from</pre></td></tr><tr><td data-num="15"></td><td><pre>    * @param to</pre></td></tr><tr><td data-num="16"></td><td><pre>    * @return</pre></td></tr><tr><td data-num="17"></td><td><pre>    */</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">def</span> randomInt<span class="token punctuation">(</span>from<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">></span> to<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalArgumentException<span class="token punctuation">(</span>s<span class="token string">"from: $from 不能大于 to: $to"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">else</span> random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span>to <span class="token operator">-</span> from <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> from</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    * 创建多个 Int 值</pre></td></tr><tr><td data-num="25"></td><td><pre>    *</pre></td></tr><tr><td data-num="26"></td><td><pre>    * @param from</pre></td></tr><tr><td data-num="27"></td><td><pre>    * @param to</pre></td></tr><tr><td data-num="28"></td><td><pre>    * @param count     创建的 Int 值的顺序</pre></td></tr><tr><td data-num="29"></td><td><pre>    * @param canRepeat 是否允许重复</pre></td></tr><tr><td data-num="30"></td><td><pre>    * @return List [Int] 集合</pre></td></tr><tr><td data-num="31"></td><td><pre>    */</pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">def</span> randomMultiInt<span class="token punctuation">(</span>from<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> canRepeat<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>canRepeat<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">(</span><span class="token number">1</span> to <span class="token namespace">count</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toList<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_ <span class="token keyword">=></span> randomInt<span class="token punctuation">(</span>from<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">val</span> set <span class="token operator">=</span> mutable<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span>set<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        set <span class="token operator">+=</span> randomInt<span class="token punctuation">(</span>from<span class="token punctuation">,</span> to<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      set<span class="token punctuation">.</span>toList</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    * 生成一个随机的 Long 值 范围: [from, to]</pre></td></tr><tr><td data-num="46"></td><td><pre>    *</pre></td></tr><tr><td data-num="47"></td><td><pre>    * @param from</pre></td></tr><tr><td data-num="48"></td><td><pre>    * @param to</pre></td></tr><tr><td data-num="49"></td><td><pre>    * @return</pre></td></tr><tr><td data-num="50"></td><td><pre>    */</pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">def</span> randomLong<span class="token punctuation">(</span>from<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">></span> to<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalArgumentException<span class="token punctuation">(</span>s<span class="token string">"from: $from 不能大于 to: $to"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">else</span> math<span class="token punctuation">.</span>abs<span class="token punctuation">(</span>random<span class="token punctuation">.</span>nextLong<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>to <span class="token operator">-</span> from <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> from</pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="32-radomoptions工具类"><a class="anchor" href="#32-radomoptions工具类">#</a> 3.2 RadomOptions 工具类</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 作用：按照一定的分布生成随机选项的工具类</span></pre></td></tr></table></figure><ul><li>代码</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gmall<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="5"></td><td><pre>  **</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @create 2020-07-21 2:13:32</pre></td></tr><tr><td data-num="8"></td><td><pre>  */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ListBuffer</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  * 根据提供的值和比重，来创建 RandomOptions 对象.</pre></td></tr><tr><td data-num="13"></td><td><pre>  * 然后可以通过 getRandomOption 来获取一个随机的预定义的值</pre></td></tr><tr><td data-num="14"></td><td><pre>  */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">object</span> RandomOptions <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">def</span> apply<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>opts<span class="token operator">:</span> <span class="token punctuation">(</span>T<span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">val</span> randomOptions <span class="token operator">=</span> <span class="token keyword">new</span> RandomOptions<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    randomOptions<span class="token punctuation">.</span>totalWeight <span class="token operator">=</span> opts<span class="token punctuation">.</span>foldLeft<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">.</span>_2<span class="token punctuation">)</span> <span class="token comment">// 计算出来总的比重</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    opts<span class="token punctuation">.</span>foreach <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> weight<span class="token punctuation">)</span> <span class="token keyword">=></span> randomOptions<span class="token punctuation">.</span>options <span class="token operator">++</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> to <span class="token namespace">weight</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_ <span class="token keyword">=></span> value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    randomOptions</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">class</span> RandomOptions<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">var</span> totalWeight<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> _</pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">var</span> options <span class="token operator">=</span> ListBuffer<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    * 获取随机的 Option 的值</pre></td></tr><tr><td data-num="32"></td><td><pre>    *</pre></td></tr><tr><td data-num="33"></td><td><pre>    * @return</pre></td></tr><tr><td data-num="34"></td><td><pre>    */</pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">def</span> getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    options<span class="token punctuation">(</span>RandomNumUtil<span class="token punctuation">.</span>randomInt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> totalWeight <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Scala 会自动识别 apply 方法，所以调用伴生对象的 apply 方法时，apply 方法名可以省略，这里的 <code>RandomOptions</code> 构建对象就是用 apply 的方式</p></blockquote><h3 id="33-loguploader-日志发送工具类"><a class="anchor" href="#33-loguploader-日志发送工具类">#</a> 3.3 LogUploader 日志发送工具类</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>作用：向服务器发送生成的日志的工具类</pre></td></tr></table></figure><ul><li>代码</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gmall<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>OutputStream</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>HttpURLConnection<span class="token punctuation">,</span> URL<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * Author lzc</pre></td></tr><tr><td data-num="8"></td><td><pre>  * Date 2019/5/14 11:25 AM</pre></td></tr><tr><td data-num="9"></td><td><pre>  */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">object</span> LogUploader <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">/* 发送日志 */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">def</span> sendLog<span class="token punctuation">(</span>log<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token comment">// 1. 日志服务器的地址</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token keyword">val</span> logUrl <span class="token operator">=</span> <span class="token keyword">new</span> URL<span class="token punctuation">(</span><span class="token string">"http://localhost:8080/log"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token comment">// 2. 得到一个 HttpURLConnection</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">val</span> conn<span class="token operator">:</span> HttpURLConnection <span class="token operator">=</span> logUrl<span class="token punctuation">.</span>openConnection<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>HttpURLConnection<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token comment">// 3. 设置请求方法 (上传数据一般使用 post 请求)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      conn<span class="token punctuation">.</span>setRequestMethod<span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token comment">// 4. 用来供 server 进行时钟校对的</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      conn<span class="token punctuation">.</span>setRequestProperty<span class="token punctuation">(</span><span class="token string">"clientTime"</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>currentTimeMillis <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token comment">// 5. 允许上传数据</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      conn<span class="token punctuation">.</span>setDoOutput<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">// 6. 设置请求的头信息，post 请求必须这样设置</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      conn<span class="token punctuation">.</span>setRequestProperty<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token comment">// 7. 获取上传用的输出流</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token keyword">val</span> out<span class="token operator">:</span> OutputStream <span class="token operator">=</span> conn<span class="token punctuation">.</span>getOutputStream</pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token comment">// 8. 写出数据</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      out<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"log="</span> <span class="token operator">+</span> log<span class="token punctuation">)</span><span class="token punctuation">.</span>getBytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token comment">// 9. flush</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      out<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token comment">// 10. 关闭资源</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      out<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token comment">// 11. 获取响应码.  (或者获取响应信息也行，否则不会发送请求到服务器)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">val</span> code<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> conn<span class="token punctuation">.</span>getResponseCode</pre></td></tr><tr><td data-num="36"></td><td><pre>      println<span class="token punctuation">(</span>code<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=></span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><strong>Q: 请求方法中 post 和 get 的区别与作用</strong></p><p>![1594730664181](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233345.png)</p><p><strong>Q:post 请求文本信息的说明</strong></p><p>服务器端通常是根据请求头（headers）中的 <code>Content-Type</code> 字段来获知请求中的消息主体是用<strong>何种方式编码</strong>，再对主体进行解析。所以说到 POST 提交数据方案，包含了 Content-Type 和消息主体编码方式两部分</p><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 文本信息上传的设置</span></pre></td></tr><tr><td data-num="2"></td><td><pre>conn<span class="token punctuation">.</span>setRequestProperty<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 提交的的数据，请求 body 中按照 key1=value1&amp;key2=value2 进行编码，key 和 value 都要进行 urlEncode;</span></pre></td></tr></table></figure><p>Q: 响应码的说明</p><p>1XX：临时相应</p><p>2XX：成功相应</p><p>3XX：重定向，（访问的资源路径可能发生改变）</p><p>4XX：客户端错误</p><p>​	400：请求的语法错误</p><p>​	401：没有身份验证，一般账号密码正确可以通过</p><p>​	403：没有权利访问，被服务器拒绝</p><p>​	404：服务器找不到资源，最常见</p><p>5XX：服务器端语法错误</p><p>​	500：服务器未知错误</p><p>​	503：一般是服务器维护，当前无法处理请求</p></blockquote><h3 id="34-jsonmock-生成日志"><a class="anchor" href="#34-jsonmock-生成日志">#</a> 3.4 JsonMock 生成日志</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 作用：生成模拟数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 2. 数据内容说明：</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     <span class="token number">1.</span> json对象</pre></td></tr><tr><td data-num="4"></td><td><pre>     <span class="token number">2.</span> 数据没有写日志生成时间，待收到数据时添加时间戳</pre></td></tr><tr><td data-num="5"></td><td><pre>     <span class="token number">3.</span> 有启动日志和事件日志</pre></td></tr></table></figure><ul><li>代码</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gmall<span class="token punctuation">.</span>mock</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>JSON<span class="token punctuation">,</span> JSONObject<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gmall<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>LogUploader<span class="token punctuation">,</span> RandomNumUtil<span class="token punctuation">,</span> RandomOptions<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">object</span> JsonMock <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">val</span> startupNum <span class="token operator">=</span> <span class="token number">100000</span> <span class="token comment">// 生成的启动日志的记录数</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">val</span> eventNum <span class="token operator">=</span> <span class="token number">200000</span> <span class="token comment">// 生成的事件日志的记录数</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// 操作系统的分布</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">val</span> osOpts <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"ios"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// 日志开始时间</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">var</span> startDate<span class="token operator">:</span> Date <span class="token operator">=</span> _</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// 日志结束时间</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">var</span> endDate<span class="token operator">:</span> Date <span class="token operator">=</span> _</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">// 地理位置分布</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">val</span> areaOpts <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"shanghai"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"guangdong"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"hebei"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"heilongjiang"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"shandong"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"guizhou"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"shangxi"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"sichuan"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"xinjiang"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token comment">// appId</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">val</span> appId <span class="token operator">=</span> <span class="token string">"gmall"</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">//app 的版本分布</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">val</span> versionOpts <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"1.2.0"</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"1.1.2"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"1.1.3"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"1.1.1"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// 用户行为的分布 (事件分布)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">val</span> eventOpts <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"addFavor"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"addComment"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"addCart"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"clickItem"</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">//app 分发渠道分布</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">val</span> channelOpts <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"xiaomi"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"huawei"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"wandoujia"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"360"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"tencent"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"baidu"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"website"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">// 生成模拟数据的时候是否结束退出</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">val</span> quitOpts <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// 模拟出来一条启动日志</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">def</span> initOneStartupLog<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    `logType` string   COMMENT ' 日志类型 ',</pre></td></tr><tr><td data-num="54"></td><td><pre>    `mid` string COMMENT ' 设备唯一标识 ',</pre></td></tr><tr><td data-num="55"></td><td><pre>    `uid` string COMMENT ' 用户标识 ',</pre></td></tr><tr><td data-num="56"></td><td><pre>    `os` string COMMENT ' 操作系统 ', ,</pre></td></tr><tr><td data-num="57"></td><td><pre>    `appId` string COMMENT ' 应用 id', ,</pre></td></tr><tr><td data-num="58"></td><td><pre>    `version` string COMMENT ' 版本号 ',</pre></td></tr><tr><td data-num="59"></td><td><pre>    `ts` bigint COMMENT ' 启动时间 ',    考虑每个终端的时间的不准群性，时间是将来在服务器端来生成</pre></td></tr><tr><td data-num="60"></td><td><pre>    `area` string COMMENT ' 城市 '</pre></td></tr><tr><td data-num="61"></td><td><pre>    `channel` string COMMENT ' 渠道 '</pre></td></tr><tr><td data-num="62"></td><td><pre>     */</pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">val</span> mid<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"mid_"</span> <span class="token operator">+</span> RandomNumUtil<span class="token punctuation">.</span>randomInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">val</span> uid<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token operator">+</span> RandomNumUtil<span class="token punctuation">.</span>randomInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">val</span> os<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> osOpts<span class="token punctuation">.</span>getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">val</span> appId<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appId</pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">val</span> area<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> areaOpts<span class="token punctuation">.</span>getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">val</span> version<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> versionOpts<span class="token punctuation">.</span>getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">val</span> channel<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> channelOpts<span class="token punctuation">.</span>getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">val</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> JSONObject<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"logType"</span><span class="token punctuation">,</span> <span class="token string">"startup"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"mid"</span><span class="token punctuation">,</span> mid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"appId"</span><span class="token punctuation">,</span> appId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"area"</span><span class="token punctuation">,</span> area<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"channel"</span><span class="token punctuation">,</span> channel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token comment">// 返回 json 格式字符串</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    obj<span class="token punctuation">.</span>toJSONString</pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token comment">// 模拟出来一条事件日志  参数: json 格式的启动日志</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">def</span> initOneEventLog<span class="token punctuation">(</span>startupLogJson<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token comment">/*`</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    logType` string   COMMENT ' 日志类型 ',</pre></td></tr><tr><td data-num="88"></td><td><pre>    `mid` string COMMENT ' 设备唯一标识 ',</pre></td></tr><tr><td data-num="89"></td><td><pre>    `uid` string COMMENT ' 用户标识 ',</pre></td></tr><tr><td data-num="90"></td><td><pre>    `os` string COMMENT ' 操作系统 ',</pre></td></tr><tr><td data-num="91"></td><td><pre>    `appId` string COMMENT ' 应用 id',</pre></td></tr><tr><td data-num="92"></td><td><pre>    `area` string COMMENT ' 地区 ' ,</pre></td></tr><tr><td data-num="93"></td><td><pre>    `eventId` string COMMENT ' 事件 id',</pre></td></tr><tr><td data-num="94"></td><td><pre>    `pageId` string COMMENT ' 当前页 ',</pre></td></tr><tr><td data-num="95"></td><td><pre>    `nextPageId` string COMMENT ' 跳转页 ',</pre></td></tr><tr><td data-num="96"></td><td><pre>    `itemId` string COMMENT ' 商品编号 ',</pre></td></tr><tr><td data-num="97"></td><td><pre>    `ts` bigint COMMENT ' 时间 '</pre></td></tr><tr><td data-num="98"></td><td><pre>     */</pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token keyword">val</span> startupLogObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>startupLogJson<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token keyword">val</span> eventLogObj <span class="token operator">=</span> <span class="token keyword">new</span> JSONObject<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"logType"</span><span class="token punctuation">,</span> <span class="token string">"event"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"mid"</span><span class="token punctuation">,</span> startupLogObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"mid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> startupLogObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">,</span> startupLogObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"appId"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"area"</span><span class="token punctuation">,</span> startupLogObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"area"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"eventId"</span><span class="token punctuation">,</span> eventOpts<span class="token punctuation">.</span>getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"pageId"</span><span class="token punctuation">,</span> RandomNumUtil<span class="token punctuation">.</span>randomInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"nextPageId"</span><span class="token punctuation">,</span> RandomNumUtil<span class="token punctuation">.</span>randomInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">,</span> RandomNumUtil<span class="token punctuation">.</span>randomInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    eventLogObj<span class="token punctuation">.</span>toJSONString</pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token comment">// 开始生成日志</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token keyword">def</span> generateLog<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">0</span> to <span class="token namespace">startupNum</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>_ <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>      <span class="token comment">// 生成一条启动日志</span></pre></td></tr><tr><td data-num="119"></td><td><pre>      <span class="token keyword">val</span> oneStartupLog<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> initOneStartupLog<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="120"></td><td><pre>      <span class="token comment">// 发送启动日志</span></pre></td></tr><tr><td data-num="121"></td><td><pre>      LogUploader<span class="token punctuation">.</span>sendLog<span class="token punctuation">(</span>oneStartupLog<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="122"></td><td><pre>      <span class="token comment">// 模拟出来多条事件日志</span></pre></td></tr><tr><td data-num="123"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>quitOpts<span class="token punctuation">.</span>getRandomOption<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token comment">// 生成一条事件日志</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token keyword">val</span> oneEventLog<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> initOneEventLog<span class="token punctuation">(</span>oneStartupLog<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token comment">// 发送事件日志</span></pre></td></tr><tr><td data-num="127"></td><td><pre>        LogUploader<span class="token punctuation">.</span>sendLog<span class="token punctuation">(</span>oneEventLog<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="129"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>      Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token comment">// 测试</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    generateLog<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="四-数据采集部分"><a class="anchor" href="#四-数据采集部分">#</a> 四、数据采集部分</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 说明：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   日志服务器我们使用springboot来实现，待流程疏通以后，我们再使用nginx来实现负载均衡。</pre></td></tr></table></figure><ul><li>流程</li></ul><p>![1594730753932](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233358.png)</p><h3 id="41-spring-boot简介"><a class="anchor" href="#41-spring-boot简介">#</a> 4.1 spring boot 简介</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. Spring boot 好处</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">1.</span> 内嵌 Tomcat<span class="token punctuation">,</span> 不再需要外部的 Tomcat</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2.</span> 不再需要那些千篇一律，繁琐的 xml 文件。</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token number">3.</span> 更方便的和各个第三方工具（ mysql<span class="token punctuation">,</span>redis<span class="token punctuation">,</span>elasticsearch<span class="token punctuation">,</span>dubbo 等等整合），而只要维护一个配置文件即可</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 2. 配置文件说明</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token number">1.</span>springboot 实际上就是把以前需要用户手工配置的部分，全部作为默认项。除非用户需要额外更改不然不用配置。</pre></td></tr><tr><td data-num="7"></td><td><pre>	 这就是所谓的: <span class="token string">'约定大于配置'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token number">2.</span>如果需要特别配置的时候，去修改<span class="token string">'application.properties'</span></pre></td></tr></table></figure><h3 id="42-spring-boot搭建"><a class="anchor" href="#42-spring-boot搭建">#</a> 4.2 spring boot 搭建</h3><h4 id="421-创建子模块-gmall-logger"><a class="anchor" href="#421-创建子模块-gmall-logger">#</a> 4.2.1 创建子模块 gmall-logger</h4><p>作用：日志采集服务器的创建</p><p>![1594730896851](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233418.png)</p><p>&lt;img src=&quot;<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200720193239.png&quot; alt=&quot;image-20200720193025377&quot; style=&quot;zoom: 67%;&quot; /&gt;</p><p>&lt;img src=&quot;<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200720193432.png&quot; alt=&quot;image-20200720193432593&quot; style=&quot;zoom:50%;&quot; /&gt;</p><p>![1594730921222](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233432.png)</p><blockquote><p>收到的消息要发往 kafka 集群，需要配置 kafka 依赖</p></blockquote><h4 id="422-模块依赖说明"><a class="anchor" href="#422-模块依赖说明">#</a> 4.2.2 模块依赖说明</h4><ol><li>修改依赖关系</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 依赖的操作：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token number">1.</span> 把该子项目依赖的父工程来替换成我们自己的父工程</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">2.</span> 在我们的父工程中添加子项目</pre></td></tr></table></figure><ul><li>把该子项目依赖的父工程来替换成我们自己的父工程</li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall0213<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><ul><li>在我们的父工程中添加子项目，并将上面创建时的父依赖作为父工程的父依赖</li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.1.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-mock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-logger<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><ol start="2"><li>logger 模块添加 gmall-commo 依赖</li></ol><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="43-controller的创建"><a class="anchor" href="#43-controller的创建">#</a> 4.3 Controller 的创建</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 服务器的需求：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       <span class="token number">1.</span> 给日志添加时间</pre></td></tr><tr><td data-num="3"></td><td><pre>       <span class="token number">2.</span> 日志数据落盘，为离线需求做准备</pre></td></tr><tr><td data-num="4"></td><td><pre>       <span class="token number">3.</span> 日志发往kafka中。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 2. 在 gmall-logger 创建一个类：LoggerController, 用来处理 http 请求</span></pre></td></tr></table></figure><ol><li>测试是否能接收到并处理网页的请求</li></ol><ul><li>创建 LoggerController 类，并加上注解如下 3 个注解。</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Controller</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggerController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>在网页：localhost:8080/log 访问时，会返回”ok“</li></ul><p>![image-20200722015707810](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722015715.png)</p><ol start="2"><li>测试通过模拟数据，是否能接收到数据</li></ol><ul><li>模拟数据发送的地址为：&quot;<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDgwL2xvZw==">http://localhost:8080/log</span>&quot;</li></ul><p>![image-20200722015834774](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722015834.png)</p><ul><li>LoggerController 代码</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Controller</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggerController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span>  <span class="token comment">// 将请求改成 postMapping</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> log<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 加上参数注解，如果参数的名称和请求参数一致，可以省略这个注解</span></pre></td></tr><tr><td data-num="6"></td><td><pre>       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印请求的数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>打开模拟数据，再打开服务器。能收到请求的数据</li></ul><p>![image-20200722021843525](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722021843.png)</p><h4 id="431-日志落盘"><a class="anchor" href="#431-日志落盘">#</a> 4.3.1 日志落盘</h4><ul><li>log4j 实现日志落盘</li></ul><p>添加 log4j.properties 文件</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.MyConsole</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.ConsoleAppender</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.MyConsole.target</span><span class="token punctuation">=</span><span class="token attr-value">System.err</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.MyConsole.layout</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.PatternLayout</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.MyConsole.layout.ConversionPattern</span><span class="token punctuation">=</span><span class="token attr-value">%d&#123;yyyy-MM-dd HH:mm:ss&#125; %6p (%c:%M) - %m%n </span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.File</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.DailyRollingFileAppender</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.File.file</span><span class="token punctuation">=</span><span class="token attr-value">/opt/module/gmall/gmall.log</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.File.DatePattern</span><span class="token punctuation">=</span><span class="token attr-value">'.'yyyy-MM-dd</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.File.layout</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.PatternLayout</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token attr-name">log4j.appender.atguigu.File.layout.ConversionPattern</span><span class="token punctuation">=</span><span class="token attr-value">%m%n</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token attr-name">log4j.logger.com.orange.lin.gmalllogger.LoggerController</span><span class="token punctuation">=</span><span class="token attr-value">info,atguigu.File,atguigu.MyConsole</span></pre></td></tr></table></figure><ul><li>排除 spring-boot 默认支持的 logging</li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- 去除 logging--></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">&lt;!-- 添加 spring log4j 支持 --></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h4 id="432-发送到kafka"><a class="anchor" href="#432-发送到kafka">#</a> 4.3.2 发送到 kafka</h4><ul><li>在文件 Application.properties 中添加 kafka 配置</li></ul><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8081</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#kafka 配置</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">spring.kafka.bootstrap-servers</span><span class="token punctuation">=</span><span class="token attr-value">hadoop109:9092,hadoop110:9092,hadoop111:9092</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">spring.kafka.producer.key-serializer</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.kafka.common.serialization.StringSerializer</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">spring.kafka.producer.value-serializer</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.kafka.common.serialization.StringSerializer</span></pre></td></tr></table></figure><blockquote><p>该配置指定了 kafka 集群的地址和端口，key 和 value 的序列化</p></blockquote><ul><li>在 gmall-common 子模块创建存放 topic 主题名字的类</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="6"></td><td><pre> * @creat 2020-07-14-10:06</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Constant</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> STARTUP_TOPIC <span class="token operator">=</span><span class="token string">"startup_topic"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> EVENT_TOPIC<span class="token operator">=</span><span class="token string">"event_topic"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="433-业务实现"><a class="anchor" href="#433-业务实现">#</a> 4.3.3 业务实现</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmalllogger</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span></span><span class="token class-name">Constant</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">KafkaAutoConfiguration</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span></span><span class="token class-name">JsonObjectDeserializer</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">KafkaTemplate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sound<span class="token punctuation">.</span>midi<span class="token punctuation">.</span></span><span class="token class-name">Soundbank</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="20"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="21"></td><td><pre> * @creat 2020-07-13-20:01</pre></td></tr><tr><td data-num="22"></td><td><pre> */</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">//    @RequestMapping(value = "/log", method = RequestMethod.POST)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//    @ResponseBody  // 表示返回值是一个 字符串，而不是 页面名</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggerController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token comment">// 表示 post 上传 web 服务器 /log 时，执行的动作</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">//1. 给日志添加一个时间戳</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        log<span class="token operator">=</span><span class="token function">addTS</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 2. 数据落盘 (为离线数据做准备)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token function">saveToDisk</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 3. 把数据写入到 kafka, 需要写入到 topic</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token function">sendToKafka</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">// 可以对类成员变量、方法及构造函数进行标注，让 spring 完成 bean 自动装配的工作。</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">//@Autowired 默认是按照类去匹配，配合 @Qualifier 指定按照名称去装配 bean</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token class-name">KafkaTemplate</span> kafka<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>     * 日志发往 kafka</pre></td></tr><tr><td data-num="47"></td><td><pre>     * 不同的日志写到不同的 topic</pre></td></tr><tr><td data-num="48"></td><td><pre>     * @param log</pre></td></tr><tr><td data-num="49"></td><td><pre>     */</pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendToKafka</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token comment">// 为了避免除了 type 字段外的字符串出现相同字符串，加上 "" 判定</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\"startup\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            kafka<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>STARTUP_TOPIC<span class="token punctuation">,</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            kafka<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>EVENT_TOPIC<span class="token punctuation">,</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggerController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveToDisk</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="65"></td><td><pre>     * 添加时间戳</pre></td></tr><tr><td data-num="66"></td><td><pre>     * @param log</pre></td></tr><tr><td data-num="67"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="68"></td><td><pre>     */</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addTS</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="44-linux部署"><a class="anchor" href="#44-linux部署">#</a> 4.4 Linux 部署</h3><p>目的：把数据采集部署到 Linux 服务器</p><ul><li>修改日志存放目录为 linux 下的目录</li><li>打包项目，将日志服务器的 jar 包上传</li><li>启动日志采集服务器</li></ul><blockquote><p>// 方式一<br>java -jar xxxx.jar<br>//jar 中必须配置了 main-class</p><p>// 方式二<br>java -cp gmall-logger-0.0.1-SNAPSHOT.jar org.springframework.boot.loader.JarLauncher</p><p>两种方式的说明：</p><p>java -jar 命令执行时会运用到目录 <code>META-INF\MANIFEST.MF</code> 文件，在该文件中，有一个叫 <code>Main－Class</code> 的参数，它说明了 java -jar 命令执行的类。</p><p>![1594732961560](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233507.png)</p><p>java -cp 和 -classpath 一样，是指定类运行所依赖其他类的路径，通常是类库，jar 包之类，需要全路径到 jar 包，window 上分号 “;”</p><p><em>分隔，linux 上是分号 “:” 分隔。不支持通配符，需要列出所有 jar 包，用一点 “.” 代表当前路径。</em></p></blockquote><h2 id="五-负载均衡nginx的使用"><a class="anchor" href="#五-负载均衡nginx的使用">#</a> 五、 负载均衡 Nginx 的使用</h2><blockquote><p>该部分从属于数据采集部分，主要作用为实现三台数采服务器的负载均衡，因涉及新的技术 ---Nginx，所以单独成为一个 part</p></blockquote><p>![1594748402220](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233514.png)</p><h3 id="51-nginx概述"><a class="anchor" href="#51-nginx概述">#</a> 5.1 Nginx 概述</h3><p>Nginx (读作 “engine x”), 是一个高性能的 HTTP 和反向代理服务器，特点是占有内存少，并发能力强</p><ul><li>与 tomcat 的关系</li></ul><p>除了 tomcat 以外， apache,nginx,jboss,jetty 等都是 http 服务器。</p><p>nginx 和 apache 只支持静态页面和 CGI 协议的动态语言，比如 perl 、 php 等， 但是 nginx 不支持 java 。</p><p>Java 程序只能通过与 tomcat 配合完成。 nginx 与 tomcat 配合，为 tomcat 集群提供反向代理服务、负载均衡等服务</p><h4 id="511-nginx三大功能"><a class="anchor" href="#511-nginx三大功能">#</a> 5.1.1 Nginx 三大功能</h4><h5 id="反向代理"><a class="anchor" href="#反向代理">#</a> 反向代理</h5><ul><li>正向代理</li></ul><p>![1594748623769](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233520.png)</p><blockquote><p>服务器代理用户的请求，从用户的角度看，没法直接获取请求，需要通过代理<br>特点：代理用户，用户清楚知道访问哪台服务器</p></blockquote><ul><li>反向代理</li></ul><p>![1594748632948](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233526.png)</p><blockquote><p>反向代理：服务器代理真正服务器，用户不确定去哪台真实服务器，</p></blockquote><h5 id="负载均衡"><a class="anchor" href="#负载均衡">#</a> 负载均衡</h5><p>・轮询（默认） 每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，则自动剔除故障机器，使用户访问不受影响</p><p>・weight 指定轮询权重，weight 值越大，分配到的几率就越高，主要用于后端每台服务器性能不均衡的情况。</p><p>・备机模式 平时不工作，只有其他 down 机的时候才会开始工作</p><p>・公平模式 (第三方) 更智能的一个负载均衡算法，此算法可以根据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。如果想要使用此调度算法，需要 Nginx 的 upstream_fair 模块。</p><h5 id="动静分离"><a class="anchor" href="#动静分离">#</a> 动静分离</h5><p>![1594748722077](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233531.png)</p><h3 id="52-nginx安装"><a class="anchor" href="#52-nginx安装">#</a> 5.2 Nginx 安装</h3><ul><li>yum 安装依赖包</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> yum -y <span class="token function">install</span>    openssl openssl-devel pcre pcre-devel    zlib zlib-devel gcc gcc-c++</pre></td></tr></table></figure><ul><li>下载 Nginx</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>/opt/software » <span class="token function">wget</span> http://nginx.org/download/nginx-1.12.2.tar.gz</pre></td></tr></table></figure><ul><li>解压</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">tar</span> -zxvf nginx-1.12.2.tar.gz -C /opt/module</pre></td></tr></table></figure><ul><li>编译和安装</li></ul><p>进入解压缩的目录</p><p>为了防止出现权限问题，建议切换到 root 用户</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./configure   --prefix<span class="token operator">=</span>/usr/local/webserver/nginx</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></pre></td></tr></table></figure><ul><li><strong>启停 Nginx</strong></li></ul><p>进入目录: /usr/local/webserver/nginx</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>启动 nginx: sbin/nginx</pre></td></tr><tr><td data-num="2"></td><td><pre>关闭 nginx: sbin/nginx -s stop</pre></td></tr><tr><td data-num="3"></td><td><pre>重新加载: sbin/nginx -s reload</pre></td></tr></table></figure><blockquote><p>注意：</p><ul><li>Nginx 默认使用的是 80 端口，由于非 root 用户不能使用 1024 以内的端口，所以建议使用 root 用户启动 Nginx</li><li>如果使用普通用户启动 Nginx, 需要先执行下面的命令来突破上面的限制:</li></ul><pre><code>sudo setcap cap_net_bind_service=+eip /usr/local/webserver/nginx
</code></pre></blockquote><ul><li>查看 Nginx 进程</li></ul><p>![1594748930149](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233543.png)</p><p>通过网页访问: <span class="exturl" data-url="aHR0cDovL2hhZG9vcDEwOQ==">http://hadoop109</span></p><p>![1594748945767](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233548.png)</p><h3 id="53-配置负载均衡"><a class="anchor" href="#53-配置负载均衡">#</a> 5.3 配置负载均衡</h3><h4 id="531-nginx配置修改"><a class="anchor" href="#531-nginx配置修改">#</a> 5.3.1 Nginx 配置修改</h4><ul><li>修改 /usr/local/webserver/nginx/conf/nginx.conf</li></ul><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">http</span> <span class="token attr-value">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    .....</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">    # 配置上游服务器：其实就被代理的服务器，springboot</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">    upstream</span> <span class="token attr-value">logserver&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">        server</span> <span class="token attr-value">hadoop109:8081 weight=1;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token attr-name">        server</span> <span class="token attr-value">hadoop110:8081 weight=1;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">        server</span> <span class="token attr-value">hadoop111:8081 weight=1;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token attr-name">    server</span> <span class="token attr-value">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">        listen</span> <span class="token attr-value">      80;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token attr-name">        server_name</span> <span class="token attr-value"> logserver;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token attr-name">        location</span> <span class="token attr-value">/ &#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token attr-name">            root</span> <span class="token attr-value">  html;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token attr-name">            index</span> <span class="token attr-value"> index.html index.htm;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">            # 配置代理</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token attr-name">            proxy_pass</span> <span class="token attr-value">http://logserver;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token attr-name">            proxy_connect_timeout</span> <span class="token attr-value">10;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>        ...</pre></td></tr><tr><td data-num="23"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="24"></td><td><pre>&#125;</pre></td></tr></table></figure><blockquote><p><strong>Q：为什么不配置日志服务器端口为 8080</strong></p><p>在 kafka 启动消费数据前要先打开 zookeeper 集群，在 zookeeper3.5.0 之后的版本中，集群打开后会默认占用 8080 端口</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 module<span class="token punctuation">]</span>$ jps</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">13317</span> Jps</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">13229</span> QuorumPeerMain</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 module<span class="token punctuation">]</span>$ <span class="token function">netstat</span> -tunlp <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">8080</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>Not all processes could be identified, non-owned process info</pre></td></tr><tr><td data-num="6"></td><td><pre> will not be shown, you would have to be root to see it all.<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::8080                 :::*                    LISTEN      <span class="token number">13229</span>/java</pre></td></tr></table></figure><p>通过观察日志可以发现确实启动了一个叫 adminServer 的服务</p><p>![1594749317598](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233556.png)</p><p>这是一个内嵌的 jetty 服务。如果想在 zookeeper 上解决这个问题，有以下三种方法</p><pre><code>（1）.删除jetty。
（2）修改端口。
修改方法的方法有两种，一种是在启动脚本中增加 -Dzookeeper.admin.serverPort=你的端口号.一种是在zoo.cfg中增加admin.serverPort=没有被占用的端口号
（3）停用这个服务，在启动脚本中增加”-Dzookeeper.admin.enableServer=false”
</code></pre><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">netstat</span> -tunlp<span class="token operator">|</span><span class="token function">grep</span> 端口号 查看占用端口的进程</pre></td></tr></table></figure></blockquote><h4 id="532-日志采集服务器群起脚本制作"><a class="anchor" href="#532-日志采集服务器群起脚本制作">#</a> 5.3.2 日志采集服务器群起脚本制作</h4><p>分别在 3 个节点启动 jar 比较麻烦，制作统一启动脚本.</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token shebang important">#!/bin/bash</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token string">"start"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> hadoop201 hadoop202 hadoop203</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">do</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token builtin class-name">echo</span> <span class="token string">"========启动日志服务: <span class="token variable">$i</span>==============="</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token function">ssh</span> <span class="token variable">$i</span>  <span class="token string">"source /etc/profile ; java -jar /opt/module/gmall/gmall-logger-1.0-SNAPSHOT.jar >/dev/null 2>&amp;1  &amp;"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">done</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string">"stop"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> hadoop201 hadoop202 hadoop203</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">do</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token builtin class-name">echo</span> <span class="token string">"========关闭日志服务: <span class="token variable">$i</span>==============="</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">"ps -ef|grep gmall-logger-1.0-SNAPSHOT.jar | grep -v grep|awk '&#123;print \<span class="token variable">$2</span>&#125;'|xargs kill"</span> <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">done</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    </pre></td></tr><tr><td data-num="20"></td><td><pre>    *<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token builtin class-name">echo</span> 启动姿势不对, 请使用参数 start 启动日志服务, 使用参数 stop 停止服务</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">esac</span></pre></td></tr></table></figure><h4 id="533-其他操作"><a class="anchor" href="#533-其他操作">#</a> 5.3.3 其他操作</h4><ul><li>分发启动采集服务器 jar 包到其余设备</li><li>给编写好的脚本增加执行权限</li><li>启动 Nginx</li><li>启动脚本</li></ul><blockquote><p>脚本编写的注意事项：</p><p>如果在 windows 环境下编写脚本后复制到 linux 系统中出现如下报错：</p><pre><code>bad interpreter:
/bin/bash^M: no such file or directory
</code></pre><p>是因为在 window 下写的脚本回车的时候使用的是 \r\n, 而在 linux 使用 \n 就可以了，所在每行的末尾多了一个 \r.</p><p>使用下面的命令去掉行尾的 \r:</p><pre><code>sed -i -e 's/\r$//' gmall_cluster
</code></pre></blockquote><ul><li>测试日志生成能否在集群中生成落盘日志与控制台打印</li></ul><hr><h2 id="六-实时处理部分-sparkstreaming重要"><a class="anchor" href="#六-实时处理部分-sparkstreaming重要">#</a> 六、实时处理部分 -- SparkStreaming（重要）</h2><p>![1594749834377](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233605.png)</p><h3 id="61-日活指标分析"><a class="anchor" href="#61-日活指标分析">#</a> 6.1 日活指标分析</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 什么叫日活</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">1.</span> 通常: 打开应用的用户即为活跃用户，不考虑用户的使用情况。每天一台设备打开多次会被计为一个活跃用户。</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2.</span> 游戏用户: 每天打开<span class="token operator">/</span>登录游戏的用户数（针对游戏DAU的定义）</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">-- 2. 需求：当日活跃用户及分时趋势图，昨日对比图</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 3. 思路： </span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token number">1.</span> 使用sparkSteaming动态读取kafka中的数据</pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token number">2.</span> 获取数据以后，对数据进行处理：</pre></td></tr><tr><td data-num="8"></td><td><pre>         a、</pre></td></tr></table></figure><p>什么叫日活:</p><ol><li></li></ol><p>我们采用第一种日活的定义，日活 (DAU) 统计思路:</p><ol><li><p>从 kafka 读取用户启动日志</p></li><li><p>当天只保留用户的第一次启动记录，过滤掉其他启动记录：借助于 Redis</p></li><li><p>然后把第一次启动记录保存在 hbase 以供其他应用查询</p></li></ol><p><strong>整体思路：</strong></p><p>![1594750032810](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233611.png)</p><h3 id="62-实时处理模块的创建"><a class="anchor" href="#62-实时处理模块的创建">#</a> 6.2 实时处理模块的创建</h3><p>作用：实现具体需求</p><p>模块名：mall-realtime</p><h4 id="依赖导入"><a class="anchor" href="#依赖导入">#</a> 依赖导入</h4><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>realtime-gmall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-realtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-core_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-streaming_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-streaming-kafka-0-10_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.phoenix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>phoenix-spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.0.0-HBase-2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token comment">&lt;!-- 用于项目的打包插件 --></span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">></span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="58"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="62"></td><td><pre>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="63"></td><td><pre>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="63-从kafka中消费数据"><a class="anchor" href="#63-从kafka中消费数据">#</a> 6.3 从 Kafka 中消费数据</h3><h4 id="631-配置"><a class="anchor" href="#631-配置">#</a> 6.3.1 配置</h4><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">kafka.servers</span><span class="token punctuation">=</span><span class="token attr-value">hadoop102:9092,hadoop103:9092,hadoop104:9092</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">group.id</span><span class="token punctuation">=</span><span class="token attr-value">bigdata</span></pre></td></tr></table></figure><blockquote><p>kafka 的配置转移到配置文件，不采用硬编码</p><p><code>kafka.servers</code> 配置该项时，赋值给 <code>bootstrap.servers</code> ，用以指明 kafka 集群的服务器地址，此外还有一种旧版的写法如下：</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">kafka.broker.list</span><span class="token punctuation">=</span><span class="token attr-value">hadoop102:9092,hadoop103:9092,hadoop104:9092</span></pre></td></tr></table></figure><p>0.8 以前的 kafka，消费的进度 (offset) 是写在 zk 中的，所以 consumer 需要知道 zk 的地址。这个方案有性能问题，0.9 的时候整体大改了一次，brokers 接管了消费进度，consumer 不再需要和 zookeeper 通信了，所以就用 bootstrap-server 了。</p><p>![1594815191018](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233620.png)</p></blockquote><h4 id="532-消费kafka工具类的编写"><a class="anchor" href="#532-消费kafka工具类的编写">#</a> 5.3.2 消费 Kafka 工具类的编写</h4><h5 id="读取配置"><a class="anchor" href="#读取配置">#</a> 读取配置</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InputStream</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="8"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="9"></td><td><pre> * @creat 2020-07-15-8:50</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">object</span> ConfigUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> is<span class="token operator">:</span> InputStream <span class="token operator">=</span> ClassLoader<span class="token punctuation">.</span>getSystemResourceAsStream<span class="token punctuation">(</span><span class="token string">"config.properties"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  properties<span class="token punctuation">.</span>load<span class="token punctuation">(</span>is<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">def</span> getProperty<span class="token punctuation">(</span>fileName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    properties<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    println<span class="token punctuation">(</span>getProperty<span class="token punctuation">(</span><span class="token string">"config.properties"</span><span class="token punctuation">,</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="消费kafka数据"><a class="anchor" href="#消费kafka数据">#</a> 消费 kafka 数据</h5><p>采用 Direct 方式消费 kafka 数据，目前 receiver 方式已经过时</p><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>KafkaUtils</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>LocationStrategies<span class="token punctuation">.</span>PreferConsistent</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>ConsumerStrategies<span class="token punctuation">.</span>Subscribe</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="11"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="12"></td><td><pre> * @creat 2020-07-14-19:20</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">object</span> MyKafkaUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">val</span> kafkaParams<span class="token operator">:</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span>Object<span class="token punctuation">]</span><span class="token operator">=</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span>Object<span class="token punctuation">]</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token string">"bootstrap.servers"</span><span class="token operator">-></span>ConfigUtil<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">"config.properties"</span><span class="token punctuation">,</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token string">"key.deserializer"</span> <span class="token operator">-></span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token string">"value.deserializer"</span> <span class="token operator">-></span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token string">"group.id"</span><span class="token operator">-></span>ConfigUtil<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">"config.properties"</span><span class="token punctuation">,</span><span class="token string">"group.id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token string">"auto.offset.reset"</span><span class="token operator">-></span><span class="token string">"latest"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token string">"enable.auto.commit"</span><span class="token operator">-></span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token operator">:</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">def</span> getKafkaStream<span class="token punctuation">(</span>ssc<span class="token operator">:</span>StreamingContext<span class="token punctuation">,</span>topic<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      ssc<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      PreferConsistent<span class="token punctuation">,</span> <span class="token comment">// 标配</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token comment">/*</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      LocationStrategies</pre></td></tr><tr><td data-num="32"></td><td><pre>        preferConsistent: 平均分配，每个分区的数据量平均</pre></td></tr><tr><td data-num="33"></td><td><pre>        PreferBroker: 如果 kafka 和 executor 都在同一台设备，使用 PreferBroker，（不需要网络传输）</pre></td></tr><tr><td data-num="34"></td><td><pre>        PreferFixed：有数据倾斜时需要选这个</pre></td></tr><tr><td data-num="35"></td><td><pre>       */</pre></td></tr><tr><td data-num="36"></td><td><pre>      Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Set<span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><strong>Q：receiver 和 Direct 两种消费 kafka 数据的区别</strong></p><p>Receiver 接收方式：</p><p>方法： <code>KafkaUtils.createDstream</code></p><p>Receiver 作为常驻的 Task 运行在 Executor 等待数据，但是一个 Receiver 效率低，需要开启多个，再手动合并数据 (union)，再进行处理，很麻烦<br>Receiver 哪台机器挂了，可能会丢失数据，所以需要开启 WAL (预写日志) 保证数据安全，那么效率又会降低！<br>Receiver 方式是通过 zookeeper 来连接 kafka 队列，调用 Kafka 高阶 API，offset 存储在 zookeeper，由 Receiver 维护。<br>spark 在消费的时候为了保证数据不丢也会在 Checkpoint 中存一份 offset，可能会出现数据不一致<br>所以不管从何种角度来说，Receiver 模式都不适合在开发中使用了，已经淘汰了</p><p>Direct 直连方式：</p><p>方法： <code>KafkaUtils.createDirectStream</code></p><p>Direct 方式是直接连接 kafka 分区来获取数据，从每个分区直接读取数据大大提高了并行能力<br>Direct 方式调用 Kafka 低阶 API (底层 API)，offset 自己存储和维护，默认由 Spark 维护在 checkpoint 中，消除了与 zk 不一致的情况<br>当然也可以自己手动维护，把 offset 存在 mysql、redis 中<br>所以基于 Direct 模式可以在开发中使用，且借助 Direct 模式的特点 + 手动操作可以保证数据的 Exactly once 精准一次</p><p><strong>总结：</strong></p><p><strong>Receiver 接收方式</strong><br>多个 Receiver 接受数据效率高，但有丢失数据的风险<br>开启日志（WAL）可防止数据丢失，但写两遍数据效率低。<br>Zookeeper 维护 offset 有重复消费数据可能。<br>使用高层次的 API<br><strong>Direct 直连方式</strong><br>不使用 Receiver，直接到 kafka 分区中读取数据<br>不使用日志（WAL）机制<br>Spark 自己维护 offset<br>使用低层次的 API</p></blockquote><h3 id="64-流的获取与数据结构调整"><a class="anchor" href="#64-流的获取与数据结构调整">#</a> 6.4 流的获取与数据结构调整</h3><p>目的：从 kafka 消费得到的日志数据为 json 字符串，需要转换为结构化的 json 对象</p><h4 id="641-样例类生成"><a class="anchor" href="#641-样例类生成">#</a> 6.4.1 样例类生成</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="8"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="9"></td><td><pre> * @creat 2020-07-15-11:24</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">case</span> <span class="token keyword">class</span> StartupLog<span class="token punctuation">(</span>mid<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                      uid<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                      appId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                      area<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                      os<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                      channel<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                      logType<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                      version<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                      ts<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                      <span class="token keyword">var</span> logDate<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>   <span class="token comment">// 年月日  2020-07-15</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                      <span class="token keyword">var</span> logHour<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>   <span class="token comment">// 小时  10</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> date <span class="token operator">=</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span>ts<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  logDate <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>date<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  logHour <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"HH"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>date<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Q: 为什么 logDate 和 logHour 声明为 var，且先赋值为 null</p><p>时间数据需要通过日志的 ts 时间戳转化得到，无法直接通过 json 字符串转化得到，需要在构造函数时通过获取的 ts 时间戳来进行格式化</p></blockquote><h4 id="642-流的获取与转化"><a class="anchor" href="#642-流的获取与转化">#</a> 6.4.2 流的获取与转化</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="6"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="7"></td><td><pre> * @creat 2020-07-14-19:16</pre></td></tr><tr><td data-num="8"></td><td><pre> */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">object</span> DauApp <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 实现处理模块</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//TODO 1. 创建 StreamingContext</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"DauApp"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">//TODO 2. 获取流</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span> Constant<span class="token punctuation">.</span>STARTUP_TOPIC<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 2.1 把每个 json 字符串的数据，父封装到一个样例类对象中</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">val</span> startupLogStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>json <span class="token keyword">=></span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>json<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>使用 sparkStream 至少需要 2 个核心，一个是采集器 executor 另一个是 driver</p></blockquote><h3 id="65-数据流的清洗与过滤"><a class="anchor" href="#65-数据流的清洗与过滤">#</a> 6.5 数据流的清洗与过滤</h3><h4 id="651-日活业务的思路分析"><a class="anchor" href="#651-日活业务的思路分析">#</a> 6.5.1 日活业务的思路分析</h4><p>日活定义：当天内有活跃的设备<br>需要考虑的点：当天同一台设备多次登录 --&gt; 去重</p><p>sparkstreaming 处理数据是一个批次一个批次处理的，如果使用 filter 直接去重，那么无法过滤整天的数据。会导致数据错误，其次去重要考虑批次问题。</p><h5 id="跨批次去重"><a class="anchor" href="#跨批次去重">#</a> 跨批次去重</h5><ul><li>方式一：updateStateByKey</li></ul><p>作用说明：用于记录历史记录，给定一个由 (键，事件) 对构成的 DStream，并传递一个指定如何根据新的事件更新每个键对应状态的函数，它可以构建出一个新的 DStream，其内部数据为 (键，状态) 对</p><blockquote><p>注意：使用 updateStateByKey 需要对检查点目录进行配置，会使用检查点来保存临时状态。</p><p>![1594864315561](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233636.png)</p><p>使用 updateStateByKey 虽然可以实现状态的更新，但是使用有状态转换涉及到 checkpoint 的设置，需要使用 HDFS 来进行分布式存储，不同批次的用户数据都会存在于 HDFS 中，导致 HDFS 小文件过多</p></blockquote><ul><li>方式二：黑名单</li></ul><blockquote><p>黑名单方式需要利用外部存储结构，如 MySQL、Redis</p><p>MySQL 的响应比较慢，此外对于日活的数据的统计更关注的是当天的情况，之前的数据没有保留的必要，redis 有过期数据的方式可以自动删除无用数据，MySQL 需要自己创建程序来周期型的删除，比较麻烦</p><p>使用 redis 的方式效率更好，响应速度更快</p><p><strong>本次案例选用 redis</strong></p></blockquote><h5 id="redis过滤机制的构建"><a class="anchor" href="#redis过滤机制的构建">#</a> redis 过滤机制的构建</h5><ul><li>创建 Redis 客户端的位置</li></ul><p>![1594865818206](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233644.png)</p><blockquote><p>分析：</p><p><strong>客户端的创建如果放在位置 1：</strong></p><p>程序无法执行，原因是数据库对象的连接一般都是安全连接，表示客户端与服务端建立的信任关系，如果把数据库对象序列化后交给别的 executor 执行，这种操作就不是安全操作了。</p><p><strong>客户端的创建如果放在位置 3：</strong></p><p>当把客户端连接放在该位置时，每个 RDD 的操作都会创建连接，导致性能严重下降</p><p><strong>综上，选择位置 2，该位置每个批次的数据获取一个连接对象进行黑名单判定</strong></p></blockquote><p>当选择位置 2 作为创建客户端的操作时，就表示要将按批次处理的 DStream 转换为单个 RDD 来进行操作，因此需要选择 transform 转换因子</p><blockquote><p>如果直接对 Dstream 使用 map、filter 转换算子，那么客户端创建的位置选择只有 1 和 3。</p></blockquote><h5 id="同批次去重"><a class="anchor" href="#同批次去重">#</a> 同批次去重</h5><ul><li>同一批次的跨天问题</li></ul><p>以 15 号为例，该批次横跨了 15 号和 16 号，某一条数据流过来后，是拿 16 号的黑名单列表来判定该数据是否应该被过滤，当 16 号的黑名单数据没有相应设备 id 时，这一批次的数据无法过滤</p><ul><li>在设备的首次启动时，如果同一个批次有设备的多次启动记录，则无法过滤</li></ul><blockquote><p>使用 group by 按设备 id 分组后，按时间排序取最新的数据的方式过滤</p></blockquote><h5 id="整体去重思路"><a class="anchor" href="#整体去重思路">#</a> 整体去重思路</h5><p>![1594870909711](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233733.png)</p><h4 id="652-代码实现"><a class="anchor" href="#652-代码实现">#</a> 6.5.2 代码实现</h4><h5 id="redis客户端工具类的编写"><a class="anchor" href="#redis客户端工具类的编写">#</a> Redis 客户端工具类的编写</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>JedisPool<span class="token punctuation">,</span> JedisPoolConfig<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="7"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="8"></td><td><pre> * @creat 2020-07-15-11:31</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">object</span> RedisUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">val</span> conf <span class="token operator">=</span><span class="token keyword">new</span> JedisPoolConfig</pre></td></tr><tr><td data-num="12"></td><td><pre>  conf<span class="token punctuation">.</span>setMaxTotal<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  conf<span class="token punctuation">.</span>setMaxIdle<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  conf<span class="token punctuation">.</span>setMinIdle<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  conf<span class="token punctuation">.</span>setBlockWhenExhausted<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  conf<span class="token punctuation">.</span>setMaxWaitMillis<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  conf<span class="token punctuation">.</span>setTestOnCreate<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  conf<span class="token punctuation">.</span>setTestOnBorrow<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  conf<span class="token punctuation">.</span>setTestOnReturn<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">val</span> pool<span class="token operator">=</span><span class="token keyword">new</span> JedisPool<span class="token punctuation">(</span>conf<span class="token punctuation">,</span><span class="token string">"hadoop109"</span><span class="token punctuation">,</span><span class="token number">8000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">def</span> getClient<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    pool<span class="token punctuation">.</span>getResource</pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token comment">// 测试</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">val</span> client<span class="token operator">=</span>getClient<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    client<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"k2"</span><span class="token punctuation">,</span><span class="token string">"redis"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>使用从线程池获取连接的方式</p><p>注意：主机名和端口号实际上应该通过配置文件编写，否则端口和主机名会被写死</p></blockquote><h5 id="redis的kv键值设计"><a class="anchor" href="#redis的kv键值设计">#</a> Redis 的 KV 键值设计</h5><table><thead><tr><th><strong>key</strong></th><th><strong>value</strong></th></tr></thead><tbody><tr><td><strong>dau:2019-01-22</strong></td><td>设备 id</td></tr></tbody></table><blockquote><p>redis 只需要对设备 id 进行判断，因为数据判断按天统计指标，需要加上时间，时间为设备启动日志的时间，Dau 为启动日志的主题名称</p></blockquote><h5 id="去重代码实现"><a class="anchor" href="#去重代码实现">#</a> 去重代码实现</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>StartupLog</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>MyKafkaUtil<span class="token punctuation">,</span> RedisUtil<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>SparkConf<span class="token punctuation">,</span> rdd<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Jedis</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="19"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="20"></td><td><pre> * @creat 2020-07-14-19:16</pre></td></tr><tr><td data-num="21"></td><td><pre> */</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">object</span> DauApp <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 实现处理模块</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">//TODO 1. 创建 StreamingContext</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"DauApp"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">//TODO 2. 获取流</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span> Constant<span class="token punctuation">.</span>STARTUP_TOPIC<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 2.1 把每个 json 字符串的数据，父封装到一个样例类对象中</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">val</span> startupLogStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>json <span class="token keyword">=></span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>json<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">//TODO 3. 去重  过滤掉一件启动的那些设备的记录  从 redis 去读取已经启动过的设备的 id</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">//TODO=============</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">val</span> filteredStartupLogStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span> <span class="token operator">=</span> startupLogStream<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">val</span> client<span class="token operator">:</span> Jedis <span class="token operator">=</span> RedisUtil<span class="token punctuation">.</span>getClient<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">val</span> mids<span class="token operator">:</span> util<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token punctuation">.</span>smembers<span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>STARTUP_TOPIC <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">val</span> midsBD<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>util<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>mids<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token comment">// 条件成立则保留，不成立则过滤</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      rdd</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>StartupLog <span class="token keyword">=></span> <span class="token operator">!</span>midsBD<span class="token punctuation">.</span>value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>StartupLog<span class="token punctuation">.</span>mid<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">.</span>map<span class="token punctuation">(</span>log <span class="token keyword">=></span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>mid<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token keyword">case</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> logs<span class="token punctuation">)</span> <span class="token keyword">=></span></pre></td></tr><tr><td data-num="50"></td><td><pre>            logs<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>ts<span class="token punctuation">)</span><span class="token punctuation">.</span>head</pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">//TODO 3. 开启流</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">//TODO 4. 阻止 main 进程退出</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="66-保存到hbase与加入过滤用黑名单"><a class="anchor" href="#66-保存到hbase与加入过滤用黑名单">#</a> 6.6 保存到 HBase 与加入过滤用黑名单</h3><blockquote><p>使用 Phoenix 对 HBase 进行 SQL 化操作</p></blockquote><h4 id="661-建表"><a class="anchor" href="#661-建表">#</a> 6.6.1 建表</h4><ul><li>Phoenix 登录</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>/opt/module/phoenix/bin/sqlline.py hadoop109,hadoop110,hadoop111:2181</pre></td></tr></table></figure><ul><li>建表</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> gmall2020_dau</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>              mid <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>              uid <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>              appid <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>              area <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>              os <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>              ch <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>              <span class="token keyword">type</span> <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              vs <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>              logDate <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>              logHour <span class="token keyword">varchar</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>              ts <span class="token keyword">bigint</span></pre></td></tr><tr><td data-num="14"></td><td><pre>              <span class="token keyword">CONSTRAINT</span> dau_pk <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>mid<span class="token punctuation">,</span> logDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="662-依赖增加"><a class="anchor" href="#662-依赖增加">#</a> 6.6.2 依赖增加</h4><p>在 pom.xml 中</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.phoenix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>phoenix-spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.14.2-HBase-1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-sql_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h4 id="663-实现代码完整业务代码"><a class="anchor" href="#663-实现代码完整业务代码">#</a> 6.6.3 实现代码 (完整业务代码)</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>StartupLog</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>MyKafkaUtil<span class="token punctuation">,</span> RedisUtil<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>SparkConf<span class="token punctuation">,</span> rdd<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Jedis</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="19"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="20"></td><td><pre> * @creat 2020-07-14-19:16</pre></td></tr><tr><td data-num="21"></td><td><pre> */</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">object</span> DauApp <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 实现处理模块</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">//TODO 1. 创建 StreamingContext</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"DauApp"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">//TODO 2. 获取流</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span> Constant<span class="token punctuation">.</span>STARTUP_TOPIC<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 2.1 把每个 json 字符串的数据，父封装到一个样例类对象中</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">val</span> startupLogStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>json <span class="token keyword">=></span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>json<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">//TODO 3. 去重  过滤掉一件启动的那些设备的记录  从 redis 去读取已经启动过的设备的 id</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">//TODO=============</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">val</span> filteredStartupLogStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span> <span class="token operator">=</span> startupLogStream<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">val</span> client<span class="token operator">:</span> Jedis <span class="token operator">=</span> RedisUtil<span class="token punctuation">.</span>getClient<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">val</span> mids<span class="token operator">:</span> util<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token punctuation">.</span>smembers<span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>STARTUP_TOPIC <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">val</span> midsBD<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>util<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>mids<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token comment">// 条件成立则保留，不成立则过滤</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      rdd</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>StartupLog <span class="token keyword">=></span> <span class="token operator">!</span>midsBD<span class="token punctuation">.</span>value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>StartupLog<span class="token punctuation">.</span>mid<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">.</span>map<span class="token punctuation">(</span>log <span class="token keyword">=></span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>mid<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token keyword">case</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> logs<span class="token punctuation">)</span> <span class="token keyword">=></span></pre></td></tr><tr><td data-num="50"></td><td><pre>            logs<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>ts<span class="token punctuation">)</span><span class="token punctuation">.</span>head</pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    filteredStartupLogStream<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>      rdd<span class="token punctuation">.</span>foreachPartition<span class="token punctuation">(</span><span class="token punctuation">(</span>logs<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>StartupLog<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">val</span> client<span class="token operator">:</span> Jedis <span class="token operator">=</span> RedisUtil<span class="token punctuation">.</span>getClient</pre></td></tr><tr><td data-num="58"></td><td><pre>        logs<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>log <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          client<span class="token punctuation">.</span>sadd<span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>STARTUP_TOPIC <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> log<span class="token punctuation">.</span>logDate<span class="token punctuation">,</span> log<span class="token punctuation">.</span>mid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>phoenix<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>_</pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token comment">//</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      rdd<span class="token punctuation">.</span>saveToPhoenix<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token string">"GMALL_DAU"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        Seq<span class="token punctuation">(</span><span class="token string">"MID"</span><span class="token punctuation">,</span> <span class="token string">"UID"</span><span class="token punctuation">,</span> <span class="token string">"APPID"</span><span class="token punctuation">,</span> <span class="token string">"AREA"</span><span class="token punctuation">,</span> <span class="token string">"OS"</span><span class="token punctuation">,</span> <span class="token string">"CHANNEL"</span><span class="token punctuation">,</span> <span class="token string">"LOGTYPE"</span><span class="token punctuation">,</span> <span class="token string">"VERSION"</span><span class="token punctuation">,</span> <span class="token string">"TS"</span><span class="token punctuation">,</span> <span class="token string">"LOGDATE"</span><span class="token punctuation">,</span> <span class="token string">"LOGHOUR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        zkUrl <span class="token operator">=</span> Some<span class="token punctuation">(</span><span class="token string">"hadoop109,hadoop110,hadoop111:2181"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    filteredStartupLogStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token comment">//3.2</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">//TODO 3. 开启流</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">//TODO 4. 阻止 main 进程退出</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><code>saveToPhoenix</code> 需要传入表名、表结构的字段名（需要一一对应），还需要传入 <code>zookeeper</code> 的集群地址</p><p>Q: 为什么需要传入 zookeeper 的集群 URL？</p><p>HBase 的写流程中，连接 HBase 的客户端需要先访问 zookeeper 获取 Hbase：meta 位于哪个 <code>region Server</code> ，然后再访问对应的 <code>Region Server</code> 获取 meta 表，进而根据 meta 表找到目标 table（写操作的目的地）</p></blockquote><h2 id="7-日活数据查询接口"><a class="anchor" href="#7-日活数据查询接口">#</a> 7 日活数据查询接口</h2><h3 id="71-访问路径"><a class="anchor" href="#71-访问路径">#</a> 7.1 访问路径</h3><table><thead><tr><th>日活总数</th><th><span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDcwL3JlYWx0aW1lLXRvdGFsP2RhdGU9MjAyMC0wMi0xOQ==">http://localhost:8070/realtime-total?date=2020-02-19</span></th></tr></thead><tbody><tr><td><strong>分时统计</strong></td><td><span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDcwL3JlYWx0aW1lLWhvdXJzP2lkPWRhdSZhbXA7ZGF0ZT0yMDIwLTAyLTE5">http://localhost:8070/realtime-hours?id=dau&amp;date=2020-02-19</span></td></tr></tbody></table><blockquote><p>设置 web 服务器访问的端口：8070，请求获取的方式为 get</p></blockquote><h3 id="72-请求的数据格式"><a class="anchor" href="#72-请求的数据格式">#</a> 7.2 请求的数据格式</h3><table><thead><tr><th>总数</th><th>[{&quot;id&quot;:&quot;dau&quot;,&quot;name&quot;:&quot;新增日活&quot;,&quot;value&quot;:1200}, {&quot;id&quot;:&quot;new_mid&quot;,&quot;name&quot;:&quot;新增设备&quot;,&quot;value&quot;:233}]</th></tr></thead><tbody><tr><td>分时 统计</td><td>{&quot;yesterday&quot;:{&quot;11&quot;:383,&quot;12&quot;:123,&quot;17&quot;:88,&quot;19&quot;:200 }, &quot;today&quot;:{&quot;12&quot;:38,&quot;13&quot;:1233,&quot;17&quot;:123,&quot;19&quot;:688 }}</td></tr></tbody></table><h3 id="73-工程搭建"><a class="anchor" href="#73-工程搭建">#</a> 7.3 工程搭建</h3><h4 id="731-创建工程"><a class="anchor" href="#731-创建工程">#</a> 7.3.1 创建工程</h4><p>![1594878229857](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233805.png)</p><p>![1594878250584](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233819.png)</p><p>选择 mybatis、JDBC、和 Spring Web 组件</p><p>![1594878303946](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233825.png)</p><h4 id="732-配置文件"><a class="anchor" href="#732-配置文件">#</a> 7.3.2 配置文件</h4><h5 id="子模块gmall-publisher依赖配置"><a class="anchor" href="#子模块gmall-publisher依赖配置">#</a> 子模块 <code>gmall-publisher</code> 依赖配置</h5><ul><li>修改父依赖</li><li>增加 phoenix 查询所需要的工具 jar 包</li><li>增加 hadoop 依赖</li></ul><blockquote><p>解决网页打开异常</p></blockquote><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>realtime-gmall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-publisher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>gmall-publisher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.junit.vintage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit-vintage-engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">&lt;!--phoenix--></span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.phoenix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>phoenix-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.0.0-HBase-2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token comment">&lt;!--phoenix 用到的工具包 --></span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>20.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hadoop-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.junit.jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit-jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="80"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="父依赖配置"><a class="anchor" href="#父依赖配置">#</a> 父依赖配置</h5><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre>...</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-mock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-logger<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-realtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-publisher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>...</pre></td></tr></table></figure><h5 id="gmall-publisher配置文件"><a class="anchor" href="#gmall-publisher配置文件">#</a> <code>gmall-publisher</code> 配置文件</h5><p>application.properties</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#mybatis 配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8070</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#logging.level.root=error</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># jdbc</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.phoenix.jdbc.PhoenixDriver</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:phoenix:hadoop109,hadoop110,hadoop111:2181</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># mybatis</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 做映射的时候会在 resources/mapper 目录找对应的 xml 文件</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">mybatis.mapperLocations</span><span class="token punctuation">=</span><span class="token attr-value">classpath:mapper/*.xml</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 字段名是否自动从下划线映射到驼峰命名  一般都是使用 true</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token attr-name">mybatis.configuration.map-underscore-to-camel-case</span><span class="token punctuation">=</span><span class="token attr-value">true</span></pre></td></tr></table></figure><h3 id="74-代码实现"><a class="anchor" href="#74-代码实现">#</a> 7.4 代码实现</h3><h4 id="741-mvc分层设计"><a class="anchor" href="#741-mvc分层设计">#</a> 7.4.1 MVC 分层设计</h4><table><thead><tr><th>控制层</th><th>PublisherController</th><th>实现接口的 web 发布</th></tr></thead><tbody><tr><td>服务层</td><td>PublisherService</td><td>数据业务查询 interface</td></tr><tr><td>PublisherServiceImpl</td><td>业务查询的实现类</td><td></td></tr><tr><td>数据层</td><td>DauMapper</td><td>数据层查询的 interface</td></tr><tr><td>DauMapper.xml</td><td>数据层查询的实现配置</td><td></td></tr><tr><td>主程序</td><td>GmallPublisherApplication</td><td>增加扫描包</td></tr></tbody></table><blockquote><p>本项目 module 结构：</p><p>![1594878918146](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233836.png)</p></blockquote><h4 id="742-gmallpublisherapplication程序入口"><a class="anchor" href="#742-gmallpublisherapplication程序入口">#</a> 7.4.2 GmallPublisherApplication（程序入口）</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">MapperScan</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.orange.lin.gmallpublisher.mapper"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GmallPublisherApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GmallPublisherApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>在 SpringBoot 中集成 MyBatis，可以在 mapper 接口上添加 @Mapper 注解，将 mapper 注入到 Spring, 但是如果每一个 mapper 都添加 @mapper 注解会很麻烦，这时可以使用 @MapperScan 注解来扫描包。</p><p><strong>@MapperScan (&quot;com.demo.mapper&quot;)：扫描指定包中的接口</strong></p><p><strong>注意扫描的是包</strong></p></blockquote><h4 id="743-mapper数据层"><a class="anchor" href="#743-mapper数据层">#</a> 7.4.3 Mapper 数据层</h4><h5 id="mapper层接口类"><a class="anchor" href="#mapper层接口类">#</a> Mapper 层接口类</h5><pre><code>package com.orange.lin.gmallpublisher.mapper;

import java.util.List;
import java.util.Map;

/**
 * @author oranglzc
 * @Description:
 * @creat 2020-07-15-15:49
 */
public interface DauMapper &#123;

    //得到总的日活
    Long getDau(String date);

    //得到日活分时
    List&lt;Map&lt;String,Object&gt;&gt; getHourDau(String date);
&#125;

</code></pre><h5 id="数据层返回值类型的确定"><a class="anchor" href="#数据层返回值类型的确定">#</a> 数据层返回值类型的确定</h5><ul><li><p>对于日活来说，查询后的结果是一个聚合值，返回的是一个 Long 型的</p></li><li><p>对于日活分时统计结果来说，返回的是一个表结构，涉及到表结构 --&gt;java 数据类型的转化</p></li></ul><blockquote><p>因此在 xml 配置中，不可以使用 <code>resultType</code> 直接指定返回值类型</p><pre><code>    +----------+-----------+
    | LOGHOUR  | COUNT(1)  |
    +----------+-----------+
    | 10       | 44        |
    | 15       | 140       |
    +----------+-----------+
对于返回的表结果集，使用list表示整个表，每一行数据为一个map，map中有2个K-V键值对表示，分别是字段名-&gt;值
</code></pre><p>使用 resultMap 表示返回的类型是 list，通过</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hourDauList<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.util.Map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>指明包含的关系是 map</p></blockquote><h5 id="数据层xml配置"><a class="anchor" href="#数据层xml配置">#</a> 数据层 xml 配置</h5><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">SYSTEM</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> <span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">&lt;!--namespace 对应前面定义的接口 --></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.orange.lin.gmallpublisher.mapper.DauMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">&lt;!-- 对应前面接口中的方法，标签内写响应的查询语句，查询的接口会赋值给这个方法的返回值 --></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getDau<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        select count(1) from gmall_dau where logdate=#&#123;date&#125;</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getHourDau<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hourDauList<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        select LOGHOUR, COUNT(*) COUNT from GMALL_DAU where LOGDATE=#&#123;date&#125; group by LOGHOUR</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hourDauList<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.util.Map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><blockquote><p>mybatis 会通过 XML 的配置和接口类定义的抽象方法自动获取包含结果集的实现类，用户字需要通过接口函数确定方法名和数据返回结果，通过 xml 配置文件指定接口类地址、方法名和 sql 语句即可</p><p>变量的写法： #{}</p></blockquote><h4 id="744-service服务层"><a class="anchor" href="#744-service服务层">#</a> 7.4.4 Service 服务层</h4><h5 id="service层接口类"><a class="anchor" href="#service层接口类">#</a> service 层接口类</h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="9"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="10"></td><td><pre> * @creat 2020-07-15-16:04</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PublisherService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 获取总得日活</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Long</span> <span class="token function">getDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>       <span class="token comment">/*</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        数据层</pre></td></tr><tr><td data-num="18"></td><td><pre>        // List (Map ("loghour": "10", count: 100), Map,.....)</pre></td></tr><tr><td data-num="19"></td><td><pre>        List&lt;Map&lt;String, Object>> getHourDau (String date);</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        //  Map ("10"->100, "11"->200. "12"->100)</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">getHourDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="service层实现类"><a class="anchor" href="#service层实现类">#</a> service 层实现类</h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">DauMapper</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="13"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="14"></td><td><pre> * @creat 2020-07-15-16:05</pre></td></tr><tr><td data-num="15"></td><td><pre> */</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublisherServiceImp</span> <span class="token keyword">implements</span> <span class="token class-name">PublisherService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">DauMapper</span> dau<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> dau<span class="token punctuation">.</span><span class="token function">getDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  数据层</pre></td></tr><tr><td data-num="28"></td><td><pre>  // List (Map ("loghour": "10", count: 100), Map,.....)</pre></td></tr><tr><td data-num="29"></td><td><pre>  List&lt;Map&lt;String, Object>> getHourDau (String date);</pre></td></tr><tr><td data-num="30"></td><td><pre>  select LOGHOUR, count (*) COUNT from GMALL_DAU where LOGDATE=#&#123;date &#125; group by LOGHOUR</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  //  Map ("10"->100, "11"->200. "12"->100)</pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>	*/</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">getHourDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> hourDau <span class="token operator">=</span> dau<span class="token punctuation">.</span><span class="token function">getHourDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">:</span> hourDau<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token class-name">String</span> key <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"LOGHOUR"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token class-name">Long</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"COUNT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>数据结构的转化，将表结构的关系（原本的数据只是存在于同一个 map 中），需要转化成 value 与 value 的一一对应关系</p></blockquote><h4 id="745-controller控制层"><a class="anchor" href="#745-controller控制层">#</a> 7.4.5 controller 控制层</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PublisherService</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">it<span class="token punctuation">.</span>unimi<span class="token punctuation">.</span>dsi<span class="token punctuation">.</span>fastutil<span class="token punctuation">.</span></span><span class="token class-name">Hash</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="15"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="16"></td><td><pre> * @creat 2020-07-15-16:07</pre></td></tr><tr><td data-num="17"></td><td><pre> */</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> publisherController <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">PublisherService</span> service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    1.	日活总数:</pre></td></tr><tr><td data-num="25"></td><td><pre>http://localhost:8070/realtime-total?date=2020-02-11</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    2.	日活总数</pre></td></tr><tr><td data-num="28"></td><td><pre>[&#123;"id":"dau","name":"新增日活","value":1200&#125;,</pre></td></tr><tr><td data-num="29"></td><td><pre>&#123;"id":"new_mid","name":"新增设备","value":233&#125; ]</pre></td></tr><tr><td data-num="30"></td><td><pre>    */</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/realtime-total"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span>  <span class="token class-name">String</span> <span class="token function">realtimeTotal</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">Long</span> dau <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">//json 字符串先用 java 的数据结构表示，最后使用 json 序列化工具直接转成 json 字符串</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"dau"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"新增日活"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> dau<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"new_mid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"新增设备"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token string">"233"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    </pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    </pre></td></tr><tr><td data-num="57"></td><td><pre>	1.	日活分时统计</pre></td></tr><tr><td data-num="58"></td><td><pre>http://localhost:8070/realtime-hour?id=dau&amp;date=2020-07-15</pre></td></tr><tr><td data-num="59"></td><td><pre>    2.	日活分时统计</pre></td></tr><tr><td data-num="60"></td><td><pre>&#123;"yesterday":&#123;"11":383,"12":123,"17":88,"19":200&#125;,</pre></td></tr><tr><td data-num="61"></td><td><pre>"today":&#123;"12":38,"13":1233,"17":123,"19":688 &#125;&#125;</pre></td></tr><tr><td data-num="62"></td><td><pre>    */</pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/realtime-hour"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRealTimeHour</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dau"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> today <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getHourDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> yesterday <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getHourDau</span><span class="token punctuation">(</span><span class="token function">getYesterday</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span> <span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"today"</span><span class="token punctuation">,</span> today<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yesterday"</span><span class="token punctuation">,</span> yesterday<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token keyword">return</span>  <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="80"></td><td><pre>     * 返回昨天的年月日</pre></td></tr><tr><td data-num="81"></td><td><pre>     *</pre></td></tr><tr><td data-num="82"></td><td><pre>     * @param date</pre></td></tr><tr><td data-num="83"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="84"></td><td><pre>     */</pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getYesterday</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="8-可视化展示"><a class="anchor" href="#8-可视化展示">#</a> 8 可视化展示</h2><p>无</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-08-31 19:41:37" itemprop="dateModified" datetime="2021-08-31T19:41:37+08:00">2021-08-31</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Miyazono 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Miyazono 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Miyazono 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/5_%E6%97%A5%E6%B4%BB/">https://github.com/Mayizono/miyazono.github.io/big-data/flink/5_日活/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/big-data/hadoop/hadoop/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicli3sbvtj20zk0m8x6p.jpg" title="未命名"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#title%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E4%B9%8B%E6%97%A5%E6%B4%BB"><span class="toc-number">1.</span> <span class="toc-text">title: 实时数仓之日活</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E4%B9%8B%E6%97%A5%E6%B4%BB"><span class="toc-number"></span> <span class="toc-text">实时数仓之日活</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E9%9C%80%E6%B1%82%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">一、 需求概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E7%A6%BB%E7%BA%BF%E4%B8%8E%E5%AE%9E%E6%97%B6%E9%9C%80%E6%B1%82"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 离线与实时需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E7%A6%BB%E7%BA%BF%E5%A4%84%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 离线处理架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-%E5%AE%9E%E6%97%B6%E5%A4%84%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 实时处理架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-%E9%9C%80%E6%B1%82"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 实现原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E9%A1%B9%E7%9B%AE%E5%87%86%E5%A4%87%E9%83%A8%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text">二、项目准备部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E5%88%9B%E5%BB%BAgmall0213%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 创建 gmall0213 工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E5%88%9B%E5%BB%BAcommon%E5%AD%90%E6%A8%A1%E5%9D%97"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 创建 common 子模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E6%A8%A1%E6%8B%9F%E6%95%B0%E6%8D%AE%E9%83%A8%E5%88%86"><span class="toc-number">3.</span> <span class="toc-text">三、模拟数据部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-randomnumutil-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 RandomNumUtil 工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-radomoptions%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 RadomOptions 工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-loguploader-%E6%97%A5%E5%BF%97%E5%8F%91%E9%80%81%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 LogUploader 日志发送工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-jsonmock-%E7%94%9F%E6%88%90%E6%97%A5%E5%BF%97"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 JsonMock 生成日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E9%83%A8%E5%88%86"><span class="toc-number">4.</span> <span class="toc-text">四、数据采集部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-spring-boot%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 spring boot 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-spring-boot%E6%90%AD%E5%BB%BA"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 spring boot 搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#421-%E5%88%9B%E5%BB%BA%E5%AD%90%E6%A8%A1%E5%9D%97-gmall-logger"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 创建子模块 gmall-logger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#422-%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 模块依赖说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-controller%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 Controller 的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#431-%E6%97%A5%E5%BF%97%E8%90%BD%E7%9B%98"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 日志落盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#432-%E5%8F%91%E9%80%81%E5%88%B0kafka"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2 发送到 kafka</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#433-%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.3.3.</span> <span class="toc-text">4.3.3 业务实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#44-linux%E9%83%A8%E7%BD%B2"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 Linux 部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1nginx%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">五、 负载均衡 Nginx 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-nginx%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 Nginx 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#511-nginx%E4%B8%89%E5%A4%A7%E5%8A%9F%E8%83%BD"><span class="toc-number">5.1.1.</span> <span class="toc-text">5.1.1 Nginx 三大功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">动静分离</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-nginx%E5%AE%89%E8%A3%85"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 Nginx 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#53-%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 配置负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#531-nginx%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 Nginx 配置修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#532-%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BE%A4%E8%B5%B7%E8%84%9A%E6%9C%AC%E5%88%B6%E4%BD%9C"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 日志采集服务器群起脚本制作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#533-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="toc-number">5.3.3.</span> <span class="toc-text">5.3.3 其他操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E5%AE%9E%E6%97%B6%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-sparkstreaming%E9%87%8D%E8%A6%81"><span class="toc-number">6.</span> <span class="toc-text">六、实时处理部分 -- SparkStreaming（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E6%97%A5%E6%B4%BB%E6%8C%87%E6%A0%87%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 日活指标分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-%E5%AE%9E%E6%97%B6%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 实时处理模块的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E5%AF%BC%E5%85%A5"><span class="toc-number">6.2.1.</span> <span class="toc-text">依赖导入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-%E4%BB%8Ekafka%E4%B8%AD%E6%B6%88%E8%B4%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 从 Kafka 中消费数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#631-%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.1.</span> <span class="toc-text">6.3.1 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#532-%E6%B6%88%E8%B4%B9kafka%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%9A%84%E7%BC%96%E5%86%99"><span class="toc-number">6.3.2.</span> <span class="toc-text">5.3.2 消费 Kafka 工具类的编写</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">读取配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9kafka%E6%95%B0%E6%8D%AE"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">消费 kafka 数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-%E6%B5%81%E7%9A%84%E8%8E%B7%E5%8F%96%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%B0%83%E6%95%B4"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 流的获取与数据结构调整</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#641-%E6%A0%B7%E4%BE%8B%E7%B1%BB%E7%94%9F%E6%88%90"><span class="toc-number">6.4.1.</span> <span class="toc-text">6.4.1 样例类生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#642-%E6%B5%81%E7%9A%84%E8%8E%B7%E5%8F%96%E4%B8%8E%E8%BD%AC%E5%8C%96"><span class="toc-number">6.4.2.</span> <span class="toc-text">6.4.2 流的获取与转化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#65-%E6%95%B0%E6%8D%AE%E6%B5%81%E7%9A%84%E6%B8%85%E6%B4%97%E4%B8%8E%E8%BF%87%E6%BB%A4"><span class="toc-number">6.5.</span> <span class="toc-text">6.5 数据流的清洗与过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#651-%E6%97%A5%E6%B4%BB%E4%B8%9A%E5%8A%A1%E7%9A%84%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">6.5.1.</span> <span class="toc-text">6.5.1 日活业务的思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%A8%E6%89%B9%E6%AC%A1%E5%8E%BB%E9%87%8D"><span class="toc-number">6.5.1.1.</span> <span class="toc-text">跨批次去重</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redis%E8%BF%87%E6%BB%A4%E6%9C%BA%E5%88%B6%E7%9A%84%E6%9E%84%E5%BB%BA"><span class="toc-number">6.5.1.2.</span> <span class="toc-text">redis 过滤机制的构建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%89%B9%E6%AC%A1%E5%8E%BB%E9%87%8D"><span class="toc-number">6.5.1.3.</span> <span class="toc-text">同批次去重</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%8E%BB%E9%87%8D%E6%80%9D%E8%B7%AF"><span class="toc-number">6.5.1.4.</span> <span class="toc-text">整体去重思路</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#652-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.5.2.</span> <span class="toc-text">6.5.2 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7%E7%B1%BB%E7%9A%84%E7%BC%96%E5%86%99"><span class="toc-number">6.5.2.1.</span> <span class="toc-text">Redis 客户端工具类的编写</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redis%E7%9A%84kv%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.5.2.2.</span> <span class="toc-text">Redis 的 KV 键值设计</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.5.2.3.</span> <span class="toc-text">去重代码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#66-%E4%BF%9D%E5%AD%98%E5%88%B0hbase%E4%B8%8E%E5%8A%A0%E5%85%A5%E8%BF%87%E6%BB%A4%E7%94%A8%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">6.6.</span> <span class="toc-text">6.6 保存到 HBase 与加入过滤用黑名单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#661-%E5%BB%BA%E8%A1%A8"><span class="toc-number">6.6.1.</span> <span class="toc-text">6.6.1 建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#662-%E4%BE%9D%E8%B5%96%E5%A2%9E%E5%8A%A0"><span class="toc-number">6.6.2.</span> <span class="toc-text">6.6.2 依赖增加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#663-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%8C%E6%95%B4%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">6.6.3.</span> <span class="toc-text">6.6.3 实现代码 (完整业务代码)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%97%A5%E6%B4%BB%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.</span> <span class="toc-text">7 日活数据查询接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 访问路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 请求的数据格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">7.3.</span> <span class="toc-text">7.3 工程搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#731-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">7.3.1.</span> <span class="toc-text">7.3.1 创建工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#732-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.3.2.</span> <span class="toc-text">7.3.2 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%90%E6%A8%A1%E5%9D%97gmall-publisher%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.2.1.</span> <span class="toc-text">子模块 gmall-publisher 依赖配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%88%B6%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.2.2.</span> <span class="toc-text">父依赖配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#gmall-publisher%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.3.2.3.</span> <span class="toc-text">gmall-publisher 配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.4.</span> <span class="toc-text">7.4 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#741-mvc%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="toc-number">7.4.1.</span> <span class="toc-text">7.4.1 MVC 分层设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#742-gmallpublisherapplication%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3"><span class="toc-number">7.4.2.</span> <span class="toc-text">7.4.2 GmallPublisherApplication（程序入口）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#743-mapper%E6%95%B0%E6%8D%AE%E5%B1%82"><span class="toc-number">7.4.3.</span> <span class="toc-text">7.4.3 Mapper 数据层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mapper%E5%B1%82%E6%8E%A5%E5%8F%A3%E7%B1%BB"><span class="toc-number">7.4.3.1.</span> <span class="toc-text">Mapper 层接口类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B1%82%E8%BF%94%E5%9B%9E%E5%80%BC%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%A1%AE%E5%AE%9A"><span class="toc-number">7.4.3.2.</span> <span class="toc-text">数据层返回值类型的确定</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B1%82xml%E9%85%8D%E7%BD%AE"><span class="toc-number">7.4.3.3.</span> <span class="toc-text">数据层 xml 配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#744-service%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="toc-number">7.4.4.</span> <span class="toc-text">7.4.4 Service 服务层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#service%E5%B1%82%E6%8E%A5%E5%8F%A3%E7%B1%BB"><span class="toc-number">7.4.4.1.</span> <span class="toc-text">service 层接口类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#service%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">7.4.4.2.</span> <span class="toc-text">service 层实现类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#745-controller%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">7.4.5.</span> <span class="toc-text">7.4.5 controller 控制层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B1%95%E7%A4%BA"><span class="toc-number">8.</span> <span class="toc-text">8 可视化展示</span></a></li></ol></li></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">23</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/amehime" title="https:&#x2F;&#x2F;github.com&#x2F;amehime" class="item github"><i class="ic i-github"></i></a> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9hbWVoaW1l" title="https:&#x2F;&#x2F;twitter.com&#x2F;amehime"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyODg2ODIz" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;12886823"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9hbWVoaW1l" title="https:&#x2F;&#x2F;about.me&#x2F;amehime"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/7_%E5%AE%9E%E6%97%B6%E9%A2%84%E8%AD%A6/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flume/" title="分类于 Flume">Flume</a></div><span><a href="/big-data/flume/Flume/" title="Flume基础学习">Flume基础学习</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/4.%20Spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E2%80%94%E2%80%94%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/3.Spark%E7%BC%96%E7%A8%8B2/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/7.SparkStreaming/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/hive/" title="分类于 Hive">Hive</a></div><span><a href="/big-data/hive/HQL%E7%BB%83%E4%B9%A0%E9%A2%98/" title="HQL练习题">HQL练习题</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/2_Canal/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/5_%E6%97%A5%E6%B4%BB/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/kafka/" title="分类于 Kafka">Kafka</a></div><span><a href="/big-data/kafka/Kafka%E6%80%BB%E7%BB%93/" title="Kafka学习">Kafka学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/zookeeper/" title="分类于 Zookeeper">Zookeeper</a></div><span><a href="/big-data/zookeeper/zookeeper%E6%80%BB%E7%BB%93/" title="zookeeper总结">zookeeper总结</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">324k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:54</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"big-data/flink/5_日活/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->