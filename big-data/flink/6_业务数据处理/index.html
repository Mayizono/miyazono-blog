<!-- build time:Thu Sep 09 2021 14:14:16 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/6_%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/"><title>| Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"></h1><div class="meta"><span class="item" title="创建时间：2021-08-31 18:42:03"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-31T18:42:03+08:00">2021-08-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>21k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>19 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicivghyooj20zk0m8dir.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclfw2t96j20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeyhsblkj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclhfehz7j20zk0m8u0x.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipexbei4hj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/6_%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><h1 id="实时数仓二-业务数据处理"><a class="anchor" href="#实时数仓二-业务数据处理">#</a> 实时数仓（二） 业务数据处理</h1><hr><h2 id="1-业务数据处理架构"><a class="anchor" href="#1-业务数据处理架构">#</a> 1. 业务数据处理架构</h2><p>![1594980972405](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233018.png)</p><blockquote><p>业务数据，比如用户的订单，支付等操作会存储在 Mysql 中。为便于 SparkStreaming 对这些业务数据实时分析处理，这些数据一般也会再存储到 Kafka 中.</p></blockquote><h2 id="2-canal的使用"><a class="anchor" href="#2-canal的使用">#</a> 2. Canal 的使用</h2><h3 id="21-canal概述"><a class="anchor" href="#21-canal概述">#</a> 2.1 Canal 概述</h3><p>从 Mysql 到 Kafka 的过程中，如果每次都是全表扫描进行数据的转移，则非常耗时，并且也会对 Mysql 造成性能的影响.</p><p>最好的办法是使用专门的工具能够实时的监控 Mysql 数据的变化.</p><p>Canal 就是一个我们想要的工具.</p><p><strong>Canal 的作用就是实时同步 Mysql</strong></p><h3 id="22-canal工作原理"><a class="anchor" href="#22-canal工作原理">#</a> 2.2 Canal 工作原理</h3><h4 id="221-mysql主从复制机制"><a class="anchor" href="#221-mysql主从复制机制">#</a> 2.2.1 MySql 主从复制机制</h4><h5 id="主从复制原理"><a class="anchor" href="#主从复制原理">#</a> 主从复制原理</h5><p>![1594981217507](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233015.png)</p><p>MySQL 复制过程分成三步：<br>1 master 将改变记录到<strong>二进制日志（binary log）</strong>。这些<strong>记录过程叫做二进制日志事件</strong>，binary log events；<br>2 slave 将 master 的 binary log events 拷贝到它的中继日志（relay log）；<br>3 slave 重做中继日志中的事件，将改变应用到自己的数据库中。 <strong>MySQL 复制是异步的且串行化的</strong></p><blockquote><p>Q：如何理解 MySQL 的复制是异步的</p><p>MySQL 的复制机制是异步的是说当客户端往主库中插入数据后，<strong>只要主库接收数据后持久化到磁盘上，保证了数据的安全性后就返回给客户端确认相应</strong>。<strong>而从库数据有没有复制，数据复制有没有成功，客户端是不关心的</strong>。比如说你的应用程序写入数据是到主库的，而查询数据是从从库查询的，那么就可能会出现查询不到数据的结果。因为从库不一定会那么快从主库把数据读取过来，或者复制数据失败，这就是异步带来的不一致性。而同步就是客户端往主库插入数据，直到从库把数据安全复制过来之后才会返回结果给客户端。可想而知，异步带来的是性能的提升，而同步会降低数据的写入效率。</p></blockquote><h5 id="复制的原则"><a class="anchor" href="#复制的原则">#</a> 复制的原则</h5><ul><li>每个 slave 只有一个 master</li><li>每个 slave 只能有一个唯一的服务器 ID</li><li>每个 master 可以有多个 salve</li></ul><h4 id="2-22-binary-log的理解"><a class="anchor" href="#2-22-binary-log的理解">#</a> 2 2.2 Binary log 的理解</h4><p>MySQL 的二进制日志可以说是 MySQL 最重要的日志了，它记录了所有的 DDL 和 DML (除了数据查询语句) 语句，以事件形式记录，还包含语句所执行的消耗的时间，MySQL 的二进制日志是事务安全型的。</p><p>一般来说开启 binlog 日志大概会有 1% 的性能损耗。 binlog 日志有两个最重要的使用场景:</p><ol><li><p><strong>主从复制</strong>，MySQL Replication 在 Master 端开启 binlog，Mster 把它的二进制日志传递给 slaves 来达到 master-slave 数据一致的目的。</p></li><li><p><strong>数据恢复</strong>，通过使用 mysql binlog 工具来使恢复数据。</p></li></ol><h5 id="binlog格式"><a class="anchor" href="#binlog格式">#</a> binlog 格式</h5><p>binlog 有 3 种格式: STATEMENT, ROW, MIXED</p><ol><li><strong>statement</strong></li></ol><p>语句级别，binlog 会记录每次执行的写操作的语句，注意记录的是语句，slave 会自己重新执行写操作的语句，从而达到与 master 的一致.</p><p>但是有可能会出现主从不一致的情况：比如存储当前时间戳，存储一个随机值等.</p><ul><li><p>优点： 节省空间</p></li><li><p>缺点： 有可能造成数据不一致。</p></li></ul><ol start="2"><li><strong>row</strong></li></ol><p>行级， binlog 会记录每次操作后每行记录的变化。</p><ul><li><p>优点：保持数据的绝对一致性。因为不管 sql 是什么，引用了什么函数，他只记录执行后的效果。</p></li><li><p>缺点：占用较大空间。 如果一条语句执行之后导致很多行发生了变化，则会产生很多条记录</p></li></ul><ol start="3"><li><strong>mixed</strong></li></ol><p>statement 的升级版，一定程度上解决了因为一些情况而造成的 statement 模式不一致问题</p><ul><li>在某些情况下会按照 ROW 的方式进行处理</li></ul><pre><code> 1. 当函数中包含 UUID() 时
 2. 包含 AUTO_INCREMENT 字段的表被更新时
 3. 执行 INSERT DELAYED 语句时；
 4. 用 UDF 时； 
</code></pre><ul><li>优点：节省空间，同时兼顾了一定的一致性。</li><li>缺点：还有些极个别情况依旧会造成不一致，另外 statement 和 mixed 对于需要对 binlog 的监控的情况都不方便。</li></ul><blockquote><p>由于 canal 是监控的数据的变化，所以 binlog 的格式需要设置成 row 格式</p></blockquote><h4 id="223-canal工作原理"><a class="anchor" href="#223-canal工作原理">#</a> 2.2.3 Canal 工作原理</h4><p>Canal 的工作原理很简单， 就是把自己伪装成 slave，假装从 master 复制数据 。</p><p>![1594982449078](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233039.png)</p><blockquote><ol><li><p>canal 模拟 mysql slave 的交互协议，伪装自己为 mysql slave，向 mysql master 发送 dump 协议</p></li><li><p>mysql master 收到 dump 请求，开始推送 binary log 给 slave (也就是 canal)</p></li><li><p>canal 解析 binary log 对象 (原始为 byte 流)</p></li></ol></blockquote><h3 id="23-mysql配置"><a class="anchor" href="#23-mysql配置">#</a> 2.3 MySQL 配置</h3><h4 id="231-赋予权限"><a class="anchor" href="#231-赋予权限">#</a> 2.3.1 赋予权限</h4><p>赋权限 (可以省略，后面都是使用的 root 用户)</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> canal<span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'canal'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="232-开启binlog"><a class="anchor" href="#232-开启binlog">#</a> 2.3.2 开启 binlog</h4><p>打开文件 /etc/my.cnf, 如果没有就创建一个</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">server-id</span><span class="token punctuation">=</span> <span class="token attr-value">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">log-bin</span><span class="token punctuation">=</span> <span class="token attr-value">mysql-bin</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">binlog_format</span><span class="token punctuation">=</span> <span class="token attr-value">row</span></pre></td></tr></table></figure><h4 id="233-重启mysql使binlog生效"><a class="anchor" href="#233-重启mysql使binlog生效">#</a> 2.3.3 重启 mysql 使 binlog 生效</h4><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl restart mysqld</pre></td></tr></table></figure><p>检查 binlog 是否生效</p><p>![1594982896903](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233046.png)</p><h4 id="234-数据准备"><a class="anchor" href="#234-数据准备">#</a> 2.3.4 数据准备</h4><blockquote><p>注意该步不是主从配置的必要配置，只是该项目的数据准备</p></blockquote><ul><li>创建数据库</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">database</span> gmall <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span></pre></td></tr></table></figure><p>![1594982990975](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233054.png)</p><ul><li>执行脚本</li><li>数据插入</li></ul><p>上个步骤 中的 sql 脚本执行完毕之后，部分表中已经插入了数据，但是和订单相关的表中没有数据。可以执行存储过程来插入数据.</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 日期  订单个数 用户数 是否删除以前的数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">call</span> init_data<span class="token punctuation">(</span><span class="token string">"2019-05-16"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr></table></figure><blockquote><p>该操作模拟了数据生成到 mysql 的步骤，后续通过该命令手动给 mysql 数据库添加业务数据后完成下一步的操作</p></blockquote><h3 id="24-canal部署"><a class="anchor" href="#24-canal部署">#</a> 2.4 Canal 部署</h3><h4 id="241-canal下载"><a class="anchor" href="#241-canal下载">#</a> 2.4.1 canal 下载</h4><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.2/canal.deployer-1.1.2.tar.gz</pre></td></tr></table></figure><h4 id="242-解压"><a class="anchor" href="#242-解压">#</a> 2.4.2 解压</h4><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> /opt/module/canal</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">tar</span> -zxvf canal.deployer-1.1.2.tar.gz -C /opt/module/canal</pre></td></tr></table></figure><h4 id="243-配置"><a class="anchor" href="#243-配置">#</a> 2.4.3 配置</h4><h5 id="通用配置"><a class="anchor" href="#通用配置">#</a> 通用配置</h5><p><strong>conf/canal.properties canal 的通用配置，主要关注下 canal.port, 默认是 11111</strong></p><p>![1594983169281](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233102.png)</p><blockquote><p>canal.port：canal 客户端与 canal 连接的默认端口号</p></blockquote><h5 id="实例配置"><a class="anchor" href="#实例配置">#</a> 实例配置</h5><p><strong>conf/example/instance.properties instance.properties 是针对要追踪的 mysql 的实例配置</strong></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#################################################</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">## mysql serverId , v1.0.26+ will autoGen</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># slaveId 必须配置，不能和 mysql 的 id 重复</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">canal.instance.mysql.slaveId</span><span class="token punctuation">=</span><span class="token attr-value">100</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># enable gtid use true/false</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token attr-name">canal.instance.gtidon</span><span class="token punctuation">=</span><span class="token attr-value">false</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># position info</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># mysql 的位置信息</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">canal.instance.master.address</span><span class="token punctuation">=</span><span class="token attr-value">hadoop201:3306</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token attr-name">canal.instance.master.journal.name</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token attr-name">canal.instance.master.position</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token attr-name">canal.instance.master.timestamp</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token attr-name">canal.instance.master.gtid</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># rds oss binlog</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token attr-name">canal.instance.rds.accesskey</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token attr-name">canal.instance.rds.secretkey</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token attr-name">canal.instance.rds.instanceId</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># table meta tsdb info</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token attr-name">canal.instance.tsdb.enable</span><span class="token punctuation">=</span><span class="token attr-value">true</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">#canal.instance.tsdb.url=jdbc:mysql://127.0.0.1:3306/canal_tsdb</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#canal.instance.tsdb.dbUsername=canal</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#canal.instance.tsdb.dbPassword=canal</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">#canal.instance.standby.address =</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#canal.instance.standby.journal.name =</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#canal.instance.standby.position =</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">#canal.instance.standby.timestamp =</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#canal.instance.standby.gtid=</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># username/password</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># 用户名和密码</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token attr-name">canal.instance.dbUsername</span><span class="token punctuation">=</span><span class="token attr-value">root</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token attr-name">canal.instance.dbPassword</span><span class="token punctuation">=</span><span class="token attr-value">aaa</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token attr-name">canal.instance.connectionCharset</span> <span class="token punctuation">=</span> <span class="token attr-value">UTF-8</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token attr-name">canal.instance.defaultDatabaseName</span> <span class="token attr-value">=</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># enable druid Decrypt database password</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token attr-name">canal.instance.enableDruid</span><span class="token punctuation">=</span><span class="token attr-value">false</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">#canal.instance.pwdPublicKey=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5/zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2/JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ==</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># table regex</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># db.table</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token attr-name">canal.instance.filter.regex</span><span class="token punctuation">=</span><span class="token attr-value">.*\\..*</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment"># table black regex</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token attr-name">canal.instance.filter.black.regex</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment"># mq config</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token attr-name">canal.mq.topic</span><span class="token punctuation">=</span><span class="token attr-value">example</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token attr-name">canal.mq.partition</span><span class="token punctuation">=</span><span class="token attr-value">0</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># hash partition config</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">#canal.mq.partitionsNum=3</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">#canal.mq.partitionHash=mytest.person:id,mytest.role:id</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">#################################################</span></pre></td></tr></table></figure><blockquote><p>canal.instance.mysql.slaveId 不能和 mysql 主机相同</p><p>canal.instance.master.address：master 的地址</p><p>canal.instance.dbUsername/canal.instance.dbPassword：连接主机的验证信息</p><p>canal.instance.defaultDatabaseName：默认不写</p><p>canal.instance.filter.regex：以正则表达式说明要追踪哪些数据库下的哪些表</p><pre><code>在java中 . ---&gt; 匹配任意一个字符  如果需要一个普通的 . 需要加\.
		\ ---&gt; 如果需要一个普通\，需要加\，即\\
.*\\..*:表示追踪任意库下的任意表
</code></pre></blockquote><h4 id="244-启停与查看"><a class="anchor" href="#244-启停与查看">#</a> 2.4.4 启停与查看</h4><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#启动</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bin/startup.sh</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#停止</span></pre></td></tr><tr><td data-num="4"></td><td><pre>bin/stop.sh</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#查看</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 logs<span class="token punctuation">]</span>$ ll</pre></td></tr><tr><td data-num="8"></td><td><pre>总用量 <span class="token number">8</span></pre></td></tr><tr><td data-num="9"></td><td><pre>drwxrwxr-x <span class="token number">2</span> atguigu atguigu <span class="token number">4096</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">10</span>:40 canal</pre></td></tr><tr><td data-num="10"></td><td><pre>drwxrwxr-x <span class="token number">2</span> atguigu atguigu <span class="token number">4096</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">12</span>:50 example</pre></td></tr></table></figure><blockquote><p>![1594983308873](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233111.png)</p></blockquote><h2 id="3-项目工程部分"><a class="anchor" href="#3-项目工程部分">#</a> 3. 项目工程部分</h2><p>业务数据处理部分仍从属于实时数仓一中的大项目中，属于项目的一个 module，依赖关系需要继承于父工程</p><h3 id="31-父工程依赖"><a class="anchor" href="#31-父工程依赖">#</a> 3.1 父工程依赖</h3><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre>...</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-mock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-logger<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-realtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-publisher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>gmall-canal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>...</pre></td></tr></table></figure><h2 id="4-数据采集部分-canal"><a class="anchor" href="#4-数据采集部分-canal">#</a> 4 数据采集部分 - canal</h2><p>功能：完成从 Canal 中读取数据，然后发送的 Kafka 中</p><p>模块名: <code>gmall-canal</code></p><p>![1594988340781](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233118.png)</p><h3 id="41-canal读取数据"><a class="anchor" href="#41-canal读取数据">#</a> 4.1 canal 读取数据</h3><h4 id="411-依赖添加"><a class="anchor" href="#411-依赖添加">#</a> 4.1.1 依赖添加</h4><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>realtime-gmall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-canal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.otter/canal.client --></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">&lt;!--canal 客户端，从 canal 服务器读取数据 --></span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.otter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>canal.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients --></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">&lt;!-- kafka 客户端 --></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.orange.lin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h4 id="412-kafka生产者工具类"><a class="anchor" href="#412-kafka生产者工具类">#</a> 4.1.2 kafka 生产者工具类</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>KafkaProducer<span class="token punctuation">,</span> ProducerRecord<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="9"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="10"></td><td><pre> * @creat 2020-07-17-14:02</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">object</span> MyKafkaUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">val</span> pros <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  pros<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"hadoop109:9092,hadoop110:9092,hadoop111:9092"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  pros<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span><span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  pros<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span><span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">val</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>pros<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer</pre></td></tr><tr><td data-num="20"></td><td><pre>spring.kafka.producer.value-serializer=org.apache.kafka.common.serialization.StringSerializer</pre></td></tr><tr><td data-num="21"></td><td><pre>   */</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">def</span> sendToKafka<span class="token punctuation">(</span>topic<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>content<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token keyword">new</span> ProducerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="42-canal读取客户端并发送数据到kafka"><a class="anchor" href="#42-canal读取客户端并发送数据到kafka">#</a> 4.2 canal 读取客户端并发送数据到 Kafka</h3><ul><li>客户端读取数据的流程<ol><li>创建连接 cannal 的对象</li><li>连接 canal</li><li>订阅数据</li><li>解析数据（从 canal 对数据的包装类中解析出数据）</li><li>继续回到第四步，重复获取数据（实时框架一般不会停止</li></ol></li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>InetSocketAddress</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSONObject</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>CanalConnector<span class="token punctuation">,</span> CanalConnectors<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span>CanalEntry<span class="token punctuation">.</span><span class="token punctuation">&#123;</span>EntryType<span class="token punctuation">,</span> EventType<span class="token punctuation">,</span> RowChange<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>CanalEntry<span class="token punctuation">,</span> Message<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span></span>ByteString</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="15"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="16"></td><td><pre> * @creat 2020-07-17-10:51</pre></td></tr><tr><td data-num="17"></td><td><pre> */</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">object</span> CanalClient <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">def</span> handleData<span class="token punctuation">(</span>rowDatas<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>RowData<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                 tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                 eventType<span class="token operator">:</span> CanalEntry<span class="token punctuation">.</span>EventType<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tableName<span class="token operator">==</span><span class="token string">"order_info"</span><span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      eventType<span class="token operator">==</span>EventType<span class="token punctuation">.</span>INSERT<span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      rowDatas<span class="token operator">!=</span><span class="token keyword">null</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token operator">&amp;&amp;</span>rowDatas<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token comment">// 变化后的列</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token comment">//mysql 中的一行数据 对应 kafka 中的 一条</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>rowData<span class="token keyword">&lt;-</span>rowDatas<span class="token punctuation">.</span>asScala<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token keyword">val</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> JSONObject<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token keyword">val</span> columnsList<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>Column<span class="token punctuation">]</span> <span class="token operator">=</span> rowData<span class="token punctuation">.</span>getAfterColumnsList</pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>column<span class="token keyword">&lt;-</span>columnsList<span class="token punctuation">.</span>asScala<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">// id: 100  total_amount: 1000.2</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">val</span> key<span class="token operator">=</span>column<span class="token punctuation">.</span>getName</pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">val</span> value<span class="token operator">=</span>column<span class="token punctuation">.</span>getValue</pre></td></tr><tr><td data-num="37"></td><td><pre>            obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">//          println(obj.toJSONString) //test</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token comment">// 4. 解析后的数据，组成 json 字符串，写入到 kafka</span></pre></td></tr><tr><td data-num="41"></td><td><pre>          MyKafkaUtil<span class="token punctuation">.</span>sendToKafka<span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>ORDER_INFO_TOPIC<span class="token punctuation">,</span>obj<span class="token punctuation">.</span>toJSONString<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// 1. 连接 canal</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">val</span> connector<span class="token operator">:</span> CanalConnector <span class="token operator">=</span> CanalConnectors<span class="token punctuation">.</span>newSingleConnector<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token keyword">new</span> InetSocketAddress<span class="token punctuation">(</span><span class="token string">"hadoop109"</span><span class="token punctuation">,</span> <span class="token number">11111</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token string">"example"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">// 连接 canal 服务器</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 2. 拉取数据</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// 2.1 订阅想读的数据</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    connector<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span><span class="token string">"gmall0213.*"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">// 2.2 拉取</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token comment">// 100 表示最多拉取由于 100 条 sql 导致变化的数据.</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token comment">// 所有的数据封装到一个 Message 中</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token keyword">val</span> message<span class="token operator">:</span> Message <span class="token operator">=</span> connector<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token comment">// 3. 解析数据</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token keyword">val</span> entries<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>Entry<span class="token punctuation">]</span> <span class="token operator">=</span> message<span class="token punctuation">.</span>getEntries</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token comment">// 解析数据</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>entry <span class="token keyword">&lt;-</span> entries<span class="token punctuation">.</span>asScala<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>          <span class="token comment">//entry 类型必须是行变化</span></pre></td></tr><tr><td data-num="74"></td><td><pre>          <span class="token comment">//entry 的类型必须是 ROWDATA</span></pre></td></tr><tr><td data-num="75"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            entry<span class="token punctuation">.</span>hasEntryType <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            entry<span class="token punctuation">.</span>getEntryType <span class="token operator">==</span> EntryType<span class="token punctuation">.</span>ROWDATA<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token keyword">val</span> value<span class="token operator">:</span> ByteString <span class="token operator">=</span> entry<span class="token punctuation">.</span>getStoreValue</pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">val</span> rowChange<span class="token operator">:</span> RowChange <span class="token operator">=</span> RowChange<span class="token punctuation">.</span>parseFrom<span class="token punctuation">(</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token comment">// 所有行变化的数据</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token keyword">val</span> rowDatasList<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>RowData<span class="token punctuation">]</span> <span class="token operator">=</span> rowChange<span class="token punctuation">.</span>getRowDatasList</pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>            handleData<span class="token punctuation">(</span>rowDatasList<span class="token punctuation">,</span>entry<span class="token punctuation">.</span>getHeader<span class="token punctuation">.</span>getTableName<span class="token punctuation">,</span>rowChange<span class="token punctuation">.</span>getEventType<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="85"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 没有拉取到数据</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        println<span class="token punctuation">(</span><span class="token string">"没有抓取到数据......,3S之后重新抓取"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token comment">// 休眠 3 秒后继续拉取数据</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>![1594988792335](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233129.png)</p><p>StoreValue 是 Entry 的一个属性</p><p>RowChange：多行数据的变化，不包含事务、心跳等变化</p><p>RowData：一行数据，里面有列信息</p><p>列信息里：有列名和列值</p></blockquote><h2 id="5-实时处理部分-sparkstreaming重要"><a class="anchor" href="#5-实时处理部分-sparkstreaming重要">#</a> 5 实时处理部分 -- SparkStreaming（重要）</h2><p>![1594990105699](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233136.png)</p><p>该部分从属于实时数仓一中的实时处理模块，属于同一 module 下的多个指标</p><h3 id="51-从kafka消费流"><a class="anchor" href="#51-从kafka消费流">#</a> 5.1 从 Kafka 消费流</h3><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>OrderInfo</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>MyKafkaUtil</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="11"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="12"></td><td><pre> * @creat 2020-07-17-15:56</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">object</span>  OrderApp <span class="token keyword">extends</span> BaseApp <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 获取流</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">val</span> ds<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>Constant<span class="token punctuation">.</span>ORDER_INFO_TOPIC<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="52-数据结构转换与脱敏"><a class="anchor" href="#52-数据结构转换与脱敏">#</a> 5.2 数据结构转换与脱敏</h3><h4 id="样例类的生成"><a class="anchor" href="#样例类的生成">#</a> 样例类的生成</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="5"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="6"></td><td><pre> * @creat 2020-07-17-16:06</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">case</span> <span class="token keyword">class</span> OrderInfo<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                     province_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                     <span class="token keyword">var</span> consignee<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                     order_comment<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                     <span class="token keyword">var</span> consignee_tel<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                     order_status<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                     payment_way<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                     user_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                     img_url<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                     total_amount<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                     expire_time<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                     delivery_address<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                     create_time<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                     operate_time<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                     tracking_no<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                     parent_order_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                     out_trade_no<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                     trade_body<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                     <span class="token keyword">var</span> create_date<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                     <span class="token keyword">var</span> create_hour<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">//2020-07-17 03:18:55</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  create_date<span class="token operator">=</span>create_time<span class="token punctuation">.</span>substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  create_hour<span class="token operator">=</span>create_time<span class="token punctuation">.</span>substring<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// 敏感信息脱敏 -- 姓名</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  consignee<span class="token operator">=</span>consignee<span class="token punctuation">.</span>substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"**"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// 手机号码</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  consignee_tel<span class="token operator">=</span>consignee_tel<span class="token punctuation">.</span>replaceAll<span class="token punctuation">(</span><span class="token string">"(\\d&#123;3&#125;)\\d&#123;4&#125;(\\d&#123;4&#125;)"</span><span class="token punctuation">,</span><span class="token string">"$1****$2"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>在样例类中脱敏数据，对用户姓名、手机号码等信息进行脱敏</p></blockquote><h4 id="数据结构转化"><a class="anchor" href="#数据结构转化">#</a> 数据结构转化</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>OrderInfo</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>MyKafkaUtil</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="11"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="12"></td><td><pre> * @creat 2020-07-17-15:56</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">object</span>  OrderApp <span class="token keyword">extends</span> BaseApp <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 获取流</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">val</span> ds<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>Constant<span class="token punctuation">.</span>ORDER_INFO_TOPIC<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 结构转化</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">val</span> orderInfoStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span> <span class="token operator">=</span> ds<span class="token punctuation">.</span>map<span class="token punctuation">(</span>jsonStr<span class="token keyword">=></span>JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span>classOf<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="53-流的输出-hbase"><a class="anchor" href="#53-流的输出-hbase">#</a> 5.3 流的输出 - HBase</h3><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>OrderInfo</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>MyKafkaUtil</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="11"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="12"></td><td><pre> * @creat 2020-07-17-15:56</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">object</span>  OrderApp <span class="token keyword">extends</span> BaseApp <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 获取流</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">val</span> ds<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>Constant<span class="token punctuation">.</span>ORDER_INFO_TOPIC<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 结构转化</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">val</span> orderInfoStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span> <span class="token operator">=</span> ds<span class="token punctuation">.</span>map<span class="token punctuation">(</span>jsonStr<span class="token keyword">=></span>JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span>classOf<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 把数据写入 HBase</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    orderInfoStream<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd<span class="token keyword">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>phoenix<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>_</pre></td></tr><tr><td data-num="24"></td><td><pre>      rdd<span class="token punctuation">.</span>saveToPhoenix<span class="token punctuation">(</span><span class="token string">"GMALL_ORDER_INFO"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        Seq<span class="token punctuation">(</span><span class="token string">"ID"</span><span class="token punctuation">,</span> <span class="token string">"PROVINCE_ID"</span><span class="token punctuation">,</span> <span class="token string">"CONSIGNEE"</span><span class="token punctuation">,</span> <span class="token string">"ORDER_COMMENT"</span><span class="token punctuation">,</span> <span class="token string">"CONSIGNEE_TEL"</span><span class="token punctuation">,</span> <span class="token string">"ORDER_STATUS"</span><span class="token punctuation">,</span> <span class="token string">"PAYMENT_WAY"</span><span class="token punctuation">,</span> <span class="token string">"USER_ID"</span><span class="token punctuation">,</span> <span class="token string">"IMG_URL"</span><span class="token punctuation">,</span> <span class="token string">"TOTAL_AMOUNT"</span><span class="token punctuation">,</span> <span class="token string">"EXPIRE_TIME"</span><span class="token punctuation">,</span> <span class="token string">"DELIVERY_ADDRESS"</span><span class="token punctuation">,</span> <span class="token string">"CREATE_TIME"</span><span class="token punctuation">,</span> <span class="token string">"OPERATE_TIME"</span><span class="token punctuation">,</span> <span class="token string">"TRACKING_NO"</span><span class="token punctuation">,</span> <span class="token string">"PARENT_ORDER_ID"</span><span class="token punctuation">,</span> <span class="token string">"OUT_TRADE_NO"</span><span class="token punctuation">,</span> <span class="token string">"TRADE_BODY"</span><span class="token punctuation">,</span> <span class="token string">"CREATE_DATE"</span><span class="token punctuation">,</span> <span class="token string">"CREATE_HOUR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        zkUrl <span class="token operator">=</span> Option<span class="token punctuation">(</span><span class="token string">"hadoop109,hadoop110,hadoop111:2181"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="6-数据查询接口"><a class="anchor" href="#6-数据查询接口">#</a> 6 数据查询接口</h2><p>需求 1：销售总额 sum (total_amount)</p><p>需求 2：分时销售总额 ，（按小时分组后求取 sum）</p><h3 id="61-模块从属说明"><a class="anchor" href="#61-模块从属说明">#</a> 6.1 模块从属说明</h3><p>该查询接口与实时数仓一同属与 <code>gmall-publisher</code> ，属于一个查询接口下的多个指标</p><h3 id="62-mapper数据层"><a class="anchor" href="#62-mapper数据层">#</a> 6.2 Mapper 数据层</h3><h4 id="621-mapper层接口类"><a class="anchor" href="#621-mapper层接口类">#</a> 6.2.1 Mapper 层接口类</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="8"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="9"></td><td><pre> * @creat 2020-07-17-16:29</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderMapper</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 当日的销售总额</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">Double</span> <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 当日销售额的时分统计</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getHourAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="622-数据层xml文件"><a class="anchor" href="#622-数据层xml文件">#</a> 6.2.2 数据层 XML 文件</h4><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">SYSTEM</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> <span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">&lt;!--namespace 对应前面定义的接口 --></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.orange.lin.gmallpublisher.mapper.OrderMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">&lt;!-- 对应前面接口中的方法，标签内写响应的查询语句，查询的接口会赋值给这个方法的返回值 --></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getTotalAmount<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Double<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        select sum(TOTAL_AMOUNT) from GMALL_ORDER_INFO where CREATE_DATE=#&#123;date &#125;</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getHourAmount<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hourOrderList<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        select CREATE_HOUR,sum(TOTAL_AMOUNT) SUM from GMALL_ORDER_INFO where CREATE_DATE=#&#123;date&#125; group by CREATE_HOUR</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hourOrderList<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.util.Map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="63-service服务层"><a class="anchor" href="#63-service服务层">#</a> 6.3 Service 服务层</h3><h4 id="631-service层接口"><a class="anchor" href="#631-service层接口">#</a> 6.3.1 Service 层接口</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="9"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="10"></td><td><pre> * @creat 2020-07-15-16:04</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PublisherService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 获取总得日活</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Long</span> <span class="token function">getDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>       <span class="token comment">/*</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        数据层</pre></td></tr><tr><td data-num="18"></td><td><pre>        // List (Map ("loghour": "10", count: 100), Map,.....)</pre></td></tr><tr><td data-num="19"></td><td><pre>        List&lt;Map&lt;String, Object>> getHourDau (String date);</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        //  Map ("10"->100, "11"->200. "12"->100)</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">getHourDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//==========================================</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 销售总额</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token class-name">Double</span> <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">// 分时销售总额</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Double</span><span class="token punctuation">></span></span><span class="token function">getHourAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="632-service层实现类"><a class="anchor" href="#632-service层实现类">#</a> 6.3.2 Service 层实现类</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">DauMapper</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">OrderMapper</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="15"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="16"></td><td><pre> * @creat 2020-07-15-16:05</pre></td></tr><tr><td data-num="17"></td><td><pre> */</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublisherServiceImp</span> <span class="token keyword">implements</span> <span class="token class-name">PublisherService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">DauMapper</span> dau<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> dau<span class="token punctuation">.</span><span class="token function">getDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  数据层</pre></td></tr><tr><td data-num="31"></td><td><pre>  // List (Map ("loghour": "10", count: 100), Map,.....)</pre></td></tr><tr><td data-num="32"></td><td><pre>  List&lt;Map&lt;String, Object>> getHourDau (String date);</pre></td></tr><tr><td data-num="33"></td><td><pre>  select LOGHOUR, count (*) COUNT from GMALL_DAU where LOGDATE=#&#123;date &#125; group by LOGHOUR</pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  //  Map ("10"->100, "11"->200. "12"->100)</pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>*/</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">getHourDau</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> hourDau <span class="token operator">=</span> dau<span class="token punctuation">.</span><span class="token function">getHourDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">:</span> hourDau<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token class-name">String</span> key <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"LOGHOUR"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token class-name">Long</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"COUNT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">// 以上为日活指标</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">//========================================</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token class-name">OrderMapper</span> order<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Double</span> <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token class-name">Double</span> result <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">></span></span> <span class="token function">getHourAmount</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> hourAmount <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getHourAmount</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">></span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">:</span> hourAmount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token class-name">String</span> key <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"CREATE_HOUR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"SUM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="64-controller控制层"><a class="anchor" href="#64-controller控制层">#</a> 6.4 controller 控制层</h3><blockquote><p>补充显示销售总额部分以及分时统计部分</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>orange<span class="token punctuation">.</span>lin<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PublisherService</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">it<span class="token punctuation">.</span>unimi<span class="token punctuation">.</span>dsi<span class="token punctuation">.</span>fastutil<span class="token punctuation">.</span></span><span class="token class-name">Hash</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre> * @author oranglzc</pre></td></tr><tr><td data-num="15"></td><td><pre> * @Description:</pre></td></tr><tr><td data-num="16"></td><td><pre> * @creat 2020-07-15-16:07</pre></td></tr><tr><td data-num="17"></td><td><pre> */</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> publisherController <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">PublisherService</span> service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/realtime-total"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span>  <span class="token class-name">String</span> <span class="token function">realtimeTotal</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 日活相关</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">Long</span> dau <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">//json 字符串先用 java 的数据结构表示，最后使用 json 序列化工具直接转成 json 字符串</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"dau"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"新增日活"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> dau<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"new_mid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"新增设备"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token string">"233"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// 销售总额</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">//&#123;"id":"order_amount","name":"新增交易额","value":1000.2&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"order_amount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"新增交易额"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/realtime-hour"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRealTimeHour</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dau"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> today <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getHourDau</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> yesterday <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getHourDau</span><span class="token punctuation">(</span><span class="token function">getYesterday</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            &#123;"yesterday":&#123;"11":383,"12":123,"17":88,"19":200 &#125;,</pre></td></tr><tr><td data-num="61"></td><td><pre>                "today":&#123;"12":38,"13":1233,"17":123,"19":688 &#125;&#125;</pre></td></tr><tr><td data-num="62"></td><td><pre>             */</pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span> <span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"today"</span><span class="token punctuation">,</span> today<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yesterday"</span><span class="token punctuation">,</span> yesterday<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"order_amount"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">></span></span> today <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getHourAmount</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">></span></span> yesterday <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getHourAmount</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span> <span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Double</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"today"</span><span class="token punctuation">,</span> today<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yesterday"</span><span class="token punctuation">,</span> yesterday<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token keyword">return</span>  <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="83"></td><td><pre>     * 返回昨天的年月日</pre></td></tr><tr><td data-num="84"></td><td><pre>     *</pre></td></tr><tr><td data-num="85"></td><td><pre>     * @param date</pre></td></tr><tr><td data-num="86"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="87"></td><td><pre>     */</pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getYesterday</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="96"></td><td><pre>1.	日活总数:</pre></td></tr><tr><td data-num="97"></td><td><pre>http://localhost:8070/realtime-total?date=2020-02-11</pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>2.	日活分时统计</pre></td></tr><tr><td data-num="100"></td><td><pre>http://localhost:8070/realtime-hour?id=dau&amp;date=2020-07-15</pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>1.	日活总数</pre></td></tr><tr><td data-num="103"></td><td><pre>[&#123;"id":"dau","name":"新增日活","value":1200&#125;,</pre></td></tr><tr><td data-num="104"></td><td><pre>&#123;"id":"new_mid","name":"新增设备","value":233&#125; ]</pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>2.	日活分时统计</pre></td></tr><tr><td data-num="108"></td><td><pre>&#123;"yesterday":&#123;"11":383,"12":123,"17":88,"19":200 &#125;,</pre></td></tr><tr><td data-num="109"></td><td><pre>"today":&#123;"12":38,"13":1233,"17":123,"19":688 &#125;&#125;</pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre> */</pre></td></tr></table></figure><h2 id="7-数据可视化"><a class="anchor" href="#7-数据可视化">#</a> 7 数据可视化</h2><p>无</p><h2 id="8-数据完整启动流程"><a class="anchor" href="#8-数据完整启动流程">#</a> 8 数据完整启动流程</h2><ol><li>启动 HDFS、Zookeeper、Kafka、HBase</li><li>启动 publisher 数据接口</li><li>启动 OrderApp 流处理</li><li>启动 Canal 客户端接收业务数据后作为 Kafka 集群生产者</li><li>启动 mysql 客户端，选中相应数据库，使用存储过程</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">call</span> init_data<span class="token punctuation">(</span><span class="token string">"2019-05-16"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ol start="6"><li>启动数据可视化工具（可选）</li></ol><blockquote><p>重读第四步，观察数据变化</p><p>![1594991582828](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233152.png)</p></blockquote><h2 id="补充-正则表达式"><a class="anchor" href="#补充-正则表达式">#</a> 补充 正则表达式</h2><pre><code>grep -e 使用扩展正则表达式

</code></pre><h3 id="通配符"><a class="anchor" href="#通配符">#</a> 通配符</h3><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">touch</span> a</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">touch</span> ab</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">touch</span> abc</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">touch</span> xyz</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ ll</pre></td></tr><tr><td data-num="6"></td><td><pre>总用量 <span class="token number">4</span></pre></td></tr><tr><td data-num="7"></td><td><pre>-rw-rw-r--  <span class="token number">1</span> atguigu atguigu    <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 a</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-rw-r--  <span class="token number">1</span> atguigu atguigu    <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 ab</pre></td></tr><tr><td data-num="9"></td><td><pre>-rw-rw-r--  <span class="token number">1</span> atguigu atguigu    <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 abc</pre></td></tr><tr><td data-num="10"></td><td><pre>drwxrwxr-x. <span class="token number">2</span> atguigu atguigu <span class="token number">4096</span> <span class="token number">7</span>月  <span class="token number">15</span> <span class="token number">16</span>:43 bin</pre></td></tr><tr><td data-num="11"></td><td><pre>-rw-rw-r--  <span class="token number">1</span> atguigu atguigu    <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 xyz</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#1. 找出文件名以 a 开头的</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> -l a*</pre></td></tr><tr><td data-num="16"></td><td><pre>-rw-rw-r-- <span class="token number">1</span> atguigu atguigu <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 a</pre></td></tr><tr><td data-num="17"></td><td><pre>-rw-rw-r-- <span class="token number">1</span> atguigu atguigu <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 ab</pre></td></tr><tr><td data-num="18"></td><td><pre>-rw-rw-r-- <span class="token number">1</span> atguigu atguigu <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 abc</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># * ：0 - 多个任意字符</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#2. 找出文件名以 a 开头的，文件名只有 2 个字符的</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> -l ./a?</pre></td></tr><tr><td data-num="23"></td><td><pre>-rw-rw-r-- <span class="token number">1</span> atguigu atguigu <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 ab</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">#3. 找出文件名以 a 开头的，文件名只有 3 个字符的</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>atguigu@hadoop109 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> -l a??</pre></td></tr><tr><td data-num="26"></td><td><pre>-rw-rw-r-- <span class="token number">1</span> atguigu atguigu <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">17</span> <span class="token number">19</span>:29 abc</pre></td></tr></table></figure><h3 id="匹配操作符"><a class="anchor" href="#匹配操作符">#</a> 匹配操作符</h3><p>![1594985763967](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233204.png)</p><blockquote><p>**<a href=""> 字符匹配：**</a></p><p>[1249a]：匹配到中括号内任意一个单个字符计算命中</p><p>[^12] ：^ 表示取反，只要不包含 1 和 2，就可以匹配上</p><p>[a-k] ：给定一个序列，满足序列内的单个字符即可匹配</p><p>注意该匹配是单字符的匹配</p><p><strong>位置匹配</strong>：</p><p>行位置：</p><p><code>^x</code> : 以 x 为首</p><p><code>x$</code> : 以 x 结尾</p><p>单词边界</p><p><code>\&lt;abc</code> ：以 abc 结尾</p><p>\：只为了转义</p></blockquote><h3 id="重复操作符"><a class="anchor" href="#重复操作符">#</a> 重复操作符</h3><p>作用：不会操作数据，只会让前面匹配重复</p><p>![1594986519951](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233212.png)</p><p>正则表达式</p><p>分为基本正则表达式和扩展正则表达式</p><pre><code>grep basic  
grep只能匹配基本正则表达式

如果grep需要使用扩展正则表达式
需要使用转义\或者 是-e 表示匹配扩展正则表达式

</code></pre><pre><code>. : 匹配操作符，匹配任意单个字符
* ：重复操作符，重复0-多次

.* :表示匹配0-多次的任意个字符  ===通配符 *
</code></pre><p>​</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-08-31 19:38:30" itemprop="dateModified" datetime="2021-08-31T19:38:30+08:00">2021-08-31</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Miyazono 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Miyazono 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Miyazono 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/6_%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/">https://github.com/Mayizono/miyazono.github.io/big-data/flink/6_业务数据处理/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/big-data/flink/4_Kibana/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeun65urj20zk0m81ii.jpg" title="未命名"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div><div class="item right"><a href="/big-data/flink/7_%E5%AE%9E%E6%97%B6%E9%A2%84%E8%AD%A6/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipet4bz0yj20zk0m8e81.jpg" title="未命名"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E4%BA%8C-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">实时数仓（二） 业务数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">1. 业务数据处理架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-canal%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2. Canal 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-canal%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 Canal 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-canal%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 Canal 工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#221-mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">2.2.1 MySql 主从复制机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text">主从复制原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E5%8E%9F%E5%88%99"><span class="toc-number">1.2.2.1.2.</span> <span class="toc-text">复制的原则</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-22-binary-log%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2 2.2 Binary log 的理解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#binlog%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text">binlog 格式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#223-canal%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">2.2.3 Canal 工作原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-mysql%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 MySQL 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#231-%E8%B5%8B%E4%BA%88%E6%9D%83%E9%99%90"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.3.1 赋予权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#232-%E5%BC%80%E5%90%AFbinlog"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.3.2 开启 binlog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#233-%E9%87%8D%E5%90%AFmysql%E4%BD%BFbinlog%E7%94%9F%E6%95%88"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">2.3.3 重启 mysql 使 binlog 生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#234-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">2.3.4 数据准备</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-canal%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 Canal 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#241-canal%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">2.4.1 canal 下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#242-%E8%A7%A3%E5%8E%8B"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">2.4.2 解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#243-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">2.4.3 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.3.1.</span> <span class="toc-text">通用配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.3.2.</span> <span class="toc-text">实例配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#244-%E5%90%AF%E5%81%9C%E4%B8%8E%E6%9F%A5%E7%9C%8B"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">2.4.4 启停与查看</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E9%83%A8%E5%88%86"><span class="toc-number">1.3.</span> <span class="toc-text">3. 项目工程部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E7%88%B6%E5%B7%A5%E7%A8%8B%E4%BE%9D%E8%B5%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 父工程依赖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E9%83%A8%E5%88%86-canal"><span class="toc-number">1.4.</span> <span class="toc-text">4 数据采集部分 - canal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-canal%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 canal 读取数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#411-%E4%BE%9D%E8%B5%96%E6%B7%BB%E5%8A%A0"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">4.1.1 依赖添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#412-kafka%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">4.1.2 kafka 生产者工具类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-canal%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B9%B6%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E5%88%B0kafka"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 canal 读取客户端并发送数据到 Kafka</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E6%97%B6%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-sparkstreaming%E9%87%8D%E8%A6%81"><span class="toc-number">1.5.</span> <span class="toc-text">5 实时处理部分 -- SparkStreaming（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-%E4%BB%8Ekafka%E6%B6%88%E8%B4%B9%E6%B5%81"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 从 Kafka 消费流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%BD%AC%E6%8D%A2%E4%B8%8E%E8%84%B1%E6%95%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 数据结构转换与脱敏</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B7%E4%BE%8B%E7%B1%BB%E7%9A%84%E7%94%9F%E6%88%90"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">样例类的生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%BD%AC%E5%8C%96"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">数据结构转化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#53-%E6%B5%81%E7%9A%84%E8%BE%93%E5%87%BA-hbase"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 流的输出 - HBase</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.6.</span> <span class="toc-text">6 数据查询接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E6%A8%A1%E5%9D%97%E4%BB%8E%E5%B1%9E%E8%AF%B4%E6%98%8E"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 模块从属说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-mapper%E6%95%B0%E6%8D%AE%E5%B1%82"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 Mapper 数据层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#621-mapper%E5%B1%82%E6%8E%A5%E5%8F%A3%E7%B1%BB"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">6.2.1 Mapper 层接口类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#622-%E6%95%B0%E6%8D%AE%E5%B1%82xml%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">6.2.2 数据层 XML 文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-service%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 Service 服务层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#631-service%E5%B1%82%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">6.3.1 Service 层接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#632-service%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">6.3.2 Service 层实现类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-controller%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 controller 控制层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text">7 数据可视化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.8.</span> <span class="toc-text">8 数据完整启动流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.9.</span> <span class="toc-text">补充 正则表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="toc-number">1.9.1.</span> <span class="toc-text">通配符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">1.9.2.</span> <span class="toc-text">匹配操作符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%A4%8D%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">1.9.3.</span> <span class="toc-text">重复操作符</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">24</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/amehime" title="https:&#x2F;&#x2F;github.com&#x2F;amehime" class="item github"><i class="ic i-github"></i></a> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9hbWVoaW1l" title="https:&#x2F;&#x2F;twitter.com&#x2F;amehime"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyODg2ODIz" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;12886823"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9hbWVoaW1l" title="https:&#x2F;&#x2F;about.me&#x2F;amehime"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/big-data/flink/4_Kibana/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/big-data/flink/7_%E5%AE%9E%E6%97%B6%E9%A2%84%E8%AD%A6/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/3_ElasticSearch/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/6_%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flume/" title="分类于 Flume">Flume</a></div><span><a href="/big-data/flume/Flume/" title="Flume基础学习">Flume基础学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/zookeeper/" title="分类于 Zookeeper">Zookeeper</a></div><span><a href="/big-data/zookeeper/zookeeper%E6%80%BB%E7%BB%93/" title="zookeeper总结">zookeeper总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/hive/" title="分类于 Hive">Hive</a></div><span><a href="/big-data/hive/HQL%E4%BC%81%E4%B8%9A%E9%9D%A2%E8%AF%95%E4%B8%8A%E7%BA%BF%E4%BA%BA%E6%95%B0/" title="HQL企业之在线人数">HQL企业之在线人数</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flink/" title="分类于 Flink">Flink</a></div><span><a href="/big-data/flink/2_Canal/" title="CDC Canal的使用">CDC Canal的使用</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/Day10-%E7%BB%A7%E6%89%BF/" title="Java基础--继承">Java基础--继承</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/4_Kibana/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/6.SparkSQL/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/2.Spark%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BC%96%E7%A8%8B/" title="未命名">未命名</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">335k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:05</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"big-data/flink/6_业务数据处理/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->