<!-- build time:Wed Sep 29 2021 21:12:09 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/"><title>| Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"></h1><div class="meta"><span class="item" title="创建时间：2021-08-31 18:42:03"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-31T18:42:03+08:00">2021-08-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>23k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>21 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclwuom7cj20zk0m8dvn.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclgrvbd6j20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclimtf7dj20zk0m8qav.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclxfdlttj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giph47e9vtj20zk0m8x6l.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicitht3xtj20zk0m8k5v.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><h1 id="模块总结"><a class="anchor" href="#模块总结">#</a> 模块总结</h1><hr><h2 id="一-业务数据如何到mysql中"><a class="anchor" href="#一-业务数据如何到mysql中">#</a> 一、业务数据如何到 mysql 中</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>在mysql中创建对应的数据表，然后使用自定义一个函数，自动生成数据。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 参数为：日期  订单个数 用户数 是否删除以前的数据</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">call</span> init_data<span class="token punctuation">(</span><span class="token string">"2019-05-16"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="二-canal监控mysql数据发送到kafka"><a class="anchor" href="#二-canal监控mysql数据发送到kafka">#</a> 二、canal 监控 mysql 数据发送到 kafka</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>InetSocketAddress<span class="token punctuation">,</span> SocketAddress<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSONObject</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>CanalConnector<span class="token punctuation">,</span> CanalConnectors<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span>CanalEntry<span class="token punctuation">.</span><span class="token punctuation">&#123;</span>EventType<span class="token punctuation">,</span> RowChange<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>CanalEntry<span class="token punctuation">,</span> Message<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span></span>ByteString</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConversions<span class="token punctuation">.</span>_</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  * @Description 创建 canal 的客户端</pre></td></tr><tr><td data-num="15"></td><td><pre>  **</pre></td></tr><tr><td data-num="16"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="17"></td><td><pre>  * @create 2020-07-17 15:38:41</pre></td></tr><tr><td data-num="18"></td><td><pre>  */</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">object</span> CanalClient <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    * 解析数据</pre></td></tr><tr><td data-num="23"></td><td><pre>    * @param rowDatas 表示一个 sql 语句导致改变的数据，有多行数据</pre></td></tr><tr><td data-num="24"></td><td><pre>    * @param TableName 表示这些数据的所在的表</pre></td></tr><tr><td data-num="25"></td><td><pre>    * @param eventType 表示 sql 语句的类型，有 insert、upda 等</pre></td></tr><tr><td data-num="26"></td><td><pre>    */</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">def</span> handleData<span class="token punctuation">(</span>rowDatas<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>RowData<span class="token punctuation">]</span><span class="token punctuation">,</span> TableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> eventType<span class="token operator">:</span> CanalEntry<span class="token punctuation">.</span>EventType<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 我们只想获取 order_info 表中的数据，其他表的数据不想处理，同时只想获取新增的数据，新增的数据表示新增的订单的数据</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>TableName<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"order_info"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> eventType <span class="token operator">==</span> EventType<span class="token punctuation">.</span>INSERT <span class="token operator">&amp;&amp;</span> rowDatas <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>rowDatas<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     </pre></td></tr><tr><td data-num="31"></td><td><pre>      handleMysqlDataToKafka<span class="token punctuation">(</span>rowDatas<span class="token punctuation">,</span>Constant<span class="token punctuation">.</span>TOPIC_ORDER_INFO<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      </pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>TableName<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"order_detail"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> eventType <span class="token operator">==</span> EventType<span class="token punctuation">.</span>INSERT <span class="token operator">&amp;&amp;</span> rowDatas <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>rowDatas<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      </pre></td></tr><tr><td data-num="35"></td><td><pre>      handleMysqlDataToKafka<span class="token punctuation">(</span>rowDatas<span class="token punctuation">,</span>Constant<span class="token punctuation">.</span>TOPIC_ORDER_DETAIL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      </pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    * 解析 mysql 变化的数据，并写到 kafka 中</pre></td></tr><tr><td data-num="43"></td><td><pre>    * @param rowDatas 表示一个 sql 语句导致改变的数据，有多行数据</pre></td></tr><tr><td data-num="44"></td><td><pre>    * @param topic kafka 的 topic</pre></td></tr><tr><td data-num="45"></td><td><pre>    */</pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">def</span> handleMysqlDataToKafka<span class="token punctuation">(</span>rowDatas<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>RowData<span class="token punctuation">]</span><span class="token punctuation">,</span>topic<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 遍历多行数据，获取一条一条的数据</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>rowdata <span class="token keyword">&lt;-</span> rowDatas<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token comment">// 每一条数据由很多列组成。获取了这一行数据的多列，getAfterColumnsList，表示获取变化后的数据</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token keyword">val</span> columnsList<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>Column<span class="token punctuation">]</span> <span class="token operator">=</span> rowdata<span class="token punctuation">.</span>getAfterColumnsList</pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token comment">// 创建一个 json 对象，来接收这一行的数据，mysql 中的一行数据到 kafka 中保存为一条 json 数据</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">val</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> JSONObject<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token comment">// 遍历这些列</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span>column <span class="token keyword">&lt;-</span> columnsList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">// 获取列名</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">val</span> key<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> column<span class="token punctuation">.</span>getName</pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 获取这一列的值</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> column<span class="token punctuation">.</span>getValue</pre></td></tr><tr><td data-num="59"></td><td><pre>        obj<span class="token punctuation">.</span>put<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      <span class="token comment">// println(obj)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token comment">// 将 json 数据转换为字符串</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token keyword">val</span> context<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span>toJSONString</pre></td></tr><tr><td data-num="64"></td><td><pre>      println<span class="token punctuation">(</span>context<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token comment">// 将获取的数据发往 kafka 中，指明发往哪个 topic 中和发送什么数据</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      KafkaUtils<span class="token punctuation">.</span>sentToKafka<span class="token punctuation">(</span>topic<span class="token punctuation">,</span> context<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">// 11111 是 canal 的端口</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">var</span> address<span class="token operator">:</span> SocketAddress <span class="token operator">=</span><span class="token keyword">new</span> InetSocketAddress<span class="token punctuation">(</span><span class="token string">"hadoop105"</span><span class="token punctuation">,</span><span class="token number">11111</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token comment">// 1. 连接 canal，"example" 是 /opt/module/canal/conf/example,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token comment">// 1.1 在该目录下有一个配置文件，配置文件中记录了需要监控的 mysql 地址和数据库，当前是监控 gmall0213 数据库下所有的表</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">val</span> connector<span class="token operator">:</span> CanalConnector <span class="token operator">=</span> CanalConnectors<span class="token punctuation">.</span>newSingleConnector<span class="token punctuation">(</span>address<span class="token punctuation">,</span><span class="token string">"example"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">// 1.2 连接 canal</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token comment">// 2. 拉取数据</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">// 2.1 canal 客户端订阅 canal 的数据，订阅 canal 监控的 gmall0213 数据库下的所有的表</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    connector<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span><span class="token string">"gmall0213.*"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token comment">// 死循环来不断拉取数据</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token comment">/*</span></pre></td></tr><tr><td data-num="84"></td><td><pre>       1. canal 的客户端获取 canal 监控的数据</pre></td></tr><tr><td data-num="85"></td><td><pre>       2. 100 表示最多由 100 条 sql 导致改变的数据，这 100 条数据封装成一个 message 信息</pre></td></tr><tr><td data-num="86"></td><td><pre>       3. 使用死循环来不断的拉取数据</pre></td></tr><tr><td data-num="87"></td><td><pre>        */</pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token keyword">val</span> message<span class="token operator">:</span> Message <span class="token operator">=</span> connector<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token comment">// 一个 message 封装了多个 entry，获取 entry</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token keyword">val</span> entries<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>Entry<span class="token punctuation">]</span> <span class="token operator">=</span> message<span class="token punctuation">.</span>getEntries</pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token comment">// 一条 entry 表示一条 sql 导致的数据的变化</span></pre></td></tr><tr><td data-num="93"></td><td><pre>      <span class="token comment">// 如果拉取的数据不为空，那么继续解析数据，如果拉取到的数据为空，那么就等 3 秒再拉数据</span></pre></td></tr><tr><td data-num="94"></td><td><pre>      <span class="token comment">//  同时进行非空判断，来避免空指针的问题。</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token keyword">if</span><span class="token punctuation">(</span>entries<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entries<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token comment">// 遍历 entries，获取一个一个 entry</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      <span class="token keyword">for</span><span class="token punctuation">(</span>entry <span class="token keyword">&lt;-</span> entries<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token comment">// 对一个 entry 进行非空判断和 entry 的类型进行判断</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>hasEntryType <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>getEntryType <span class="token operator">==</span> CanalEntry<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ROWDATA <span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>          <span class="token comment">// 一个 entry 是一个 sql 语句导致的变化的数据，一个 entry 封装成了一个 storevalue，获取 storevalue</span></pre></td></tr><tr><td data-num="101"></td><td><pre>          <span class="token keyword">val</span> storeValue<span class="token operator">:</span> ByteString <span class="token operator">=</span> entry<span class="token punctuation">.</span>getStoreValue</pre></td></tr><tr><td data-num="102"></td><td><pre>          <span class="token comment">// 一个 storeValue 封装成一个 rowchange, 一个 rowchange 表示这个 sql 语句变化的多行数据</span></pre></td></tr><tr><td data-num="103"></td><td><pre>          <span class="token keyword">val</span> rowChange<span class="token operator">:</span> RowChange <span class="token operator">=</span> RowChange<span class="token punctuation">.</span>parseFrom<span class="token punctuation">(</span>storeValue<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="104"></td><td><pre>          <span class="token comment">// 获取多行数据</span></pre></td></tr><tr><td data-num="105"></td><td><pre>          <span class="token keyword">val</span> rowDatas<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>CanalEntry<span class="token punctuation">.</span>RowData<span class="token punctuation">]</span> <span class="token operator">=</span> rowChange<span class="token punctuation">.</span>getRowDatasList</pre></td></tr><tr><td data-num="106"></td><td><pre>          <span class="token comment">// 封装一个方法，来处理一个 sql 语句导致变化的多行数据</span></pre></td></tr><tr><td data-num="107"></td><td><pre>          <span class="token comment">//rowdatas 表示多行数据</span></pre></td></tr><tr><td data-num="108"></td><td><pre>          <span class="token comment">//entry.getHeader.getTableName: 表示 canal 是监控 gmall2013 数据库中的所有表</span></pre></td></tr><tr><td data-num="109"></td><td><pre>          <span class="token comment">//rowChange.getEventType: 表示数据被改变的方式，有 insert，update、等等</span></pre></td></tr><tr><td data-num="110"></td><td><pre>          handleData<span class="token punctuation">(</span>rowDatas<span class="token punctuation">,</span>entry<span class="token punctuation">.</span>getHeader<span class="token punctuation">.</span>getTableName<span class="token punctuation">,</span>rowChange<span class="token punctuation">.</span>getEventType<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">"没有拉取到数据，3s后继续拉取...."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token comment">// 拉取数据的操作等待 3s 后再执行</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="118"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="三-往kafka中写数据"><a class="anchor" href="#三-往kafka中写数据">#</a> 三、往 kafka 中写数据</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>KafkaProducer<span class="token punctuation">,</span> ProducerRecord<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  * @Description 定义一个 kafka 的工具类</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @create 2020-07-17 18:07:07</pre></td></tr><tr><td data-num="8"></td><td><pre>  */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">object</span> KafkaUtils <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">var</span> pops <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 设定 kafka 集群的地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  pops<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"hadoop105:9092,hadoop106:9092,hadoop107:9092"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 设定 key 的序列化器</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// 设定 value 的序列器</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  pops<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  pops<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">val</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>pops<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">def</span> sentToKafka<span class="token punctuation">(</span>topic<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token keyword">new</span> ProducerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="四-sparkstreaming读取kafka中的数据"><a class="anchor" href="#四-sparkstreaming读取kafka中的数据">#</a> 四、sparkStreaming 读取 kafka 中的数据</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>步骤说明：</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1.</span> 创建kafkaParams参数，参数中包含了</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">1.</span> kafka集群地址</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">2.</span> <span class="token keyword">key</span>和<span class="token keyword">value</span>的序列化器</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token number">3.</span> 消费者组id</pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">4.</span> 消费的<span class="token keyword">offset</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token number">5.</span> <span class="token keyword">offset</span>是否自动提交</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2.</span> 使用kafkautils创建直连的方式，sparkstreaming来连接kafka</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">3.</span> 需要传递的参数有：ssc<span class="token punctuation">(</span>streamingcontext<span class="token punctuation">)</span><span class="token punctuation">,</span>一致性，订阅的topic</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">4.</span> 对获取的输入流使用map进行处理，只要<span class="token keyword">value</span>，不要<span class="token keyword">key</span></pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>_</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>LocationStrategies<span class="token punctuation">.</span>PreferConsistent</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>ConsumerStrategies<span class="token punctuation">.</span>Subscribe</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="12"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="13"></td><td><pre>  * @create 2020-07-14 18:29:12</pre></td></tr><tr><td data-num="14"></td><td><pre>  */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">object</span> MyKafkaUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">val</span> kafkaParams <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token string">"bootstrap.servers"</span> <span class="token operator">-></span> ConfigUtils<span class="token punctuation">.</span>getProperties<span class="token punctuation">(</span><span class="token string">"gmall.properties"</span><span class="token punctuation">,</span> <span class="token string">"bootstrap.servers"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token string">"key.deserializer"</span> <span class="token operator">-></span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token string">"value.deserializer"</span> <span class="token operator">-></span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token string">"group.id"</span> <span class="token operator">-></span> ConfigUtils<span class="token punctuation">.</span>getProperties<span class="token punctuation">(</span><span class="token string">"gmall.properties"</span><span class="token punctuation">,</span> <span class="token string">"group.id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token string">"auto.offset.reset"</span> <span class="token operator">-></span> <span class="token string">"latest"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token string">"enable.auto.commit"</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">def</span> getKafkaStream<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">,</span> topic<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      ssc<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      PreferConsistent<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Set<span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="五-如何读取配置文件中的参数"><a class="anchor" href="#五-如何读取配置文件中的参数">#</a> 五、如何读取配置文件中的参数</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InputStream</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-07-15 11:06:43</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">object</span> ConfigUtils <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">def</span> getProperties<span class="token punctuation">(</span>fileName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span>configName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 1. 获取类的加载器并获取一个资源输入流</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">val</span> is<span class="token operator">:</span> InputStream <span class="token operator">=</span> ConfigUtils<span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getClassLoader<span class="token punctuation">.</span>getResourceAsStream<span class="token punctuation">(</span>fileName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 2. 获取一个配置文件的对象</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">val</span> ps <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 3. 配置文件对象加载这个输入流</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    ps<span class="token punctuation">.</span>load<span class="token punctuation">(</span>is<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 4. 配置对象可以获取配置文件中的配置信息</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    ps<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span>configName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 测试是否能获取到配置信息</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    println<span class="token punctuation">(</span>getProperties<span class="token punctuation">(</span><span class="token string">"gmall.properties"</span><span class="token punctuation">,</span> <span class="token string">"bootstrap.servers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token comment">// hadoop105:9092,hadoop106:9092,hadoop107:9092</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="六-公共的代码的封装"><a class="anchor" href="#六-公共的代码的封装">#</a> 六、公共的代码的封装</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>将sparkstreaming公共的代码进行封装成一个trait，创建的sparkstreaming类只要要继承这个trait，实现run方法。</pre></td></tr><tr><td data-num="2"></td><td><pre>封装的内容有：</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1.</span> sparkstreaming环境对象streamingcontext创建</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2.</span> 采集器开启</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3.</span> 线程的阻塞</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">4.</span> run方式就是获取流以后的具体数据处理</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-07-17 18:35:06</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">trait</span> BaseAPP <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">def</span> run<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">val</span> SparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"OrderApp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>SparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    run<span class="token punctuation">(</span>ssc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 6. 启动采集器</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 7. 阻塞 main 进程停止</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  </pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="七-sparkstreaming双流join"><a class="anchor" href="#七-sparkstreaming双流join">#</a> 七、sparkstreaming 双流 join</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>app</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>Constant</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>OrderDetail<span class="token punctuation">,</span> OrderInfo<span class="token punctuation">,</span> SaleDetail<span class="token punctuation">,</span> UserInfo<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>EsUtil<span class="token punctuation">,</span> MyKafkaUtil<span class="token punctuation">,</span> MyslqUtil<span class="token punctuation">,</span> RedisUtils<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>json4s<span class="token punctuation">.</span></span>DefaultFormats</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>json4s<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span></span>Serialization</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Jedis</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="19"></td><td><pre>  **</pre></td></tr><tr><td data-num="20"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="21"></td><td><pre>  * @create 2020-07-21 16:05:41</pre></td></tr><tr><td data-num="22"></td><td><pre>  */</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">object</span> SaleApp <span class="token keyword">extends</span> BaseAPP <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token comment">// 1. 定义一个方法，用来获取两个流</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token keyword">val</span> <span class="token punctuation">(</span>infoStream<span class="token punctuation">,</span>detailStream<span class="token punctuation">)</span> <span class="token operator">=</span> getOrderInfoAndOrderDetailStream<span class="token punctuation">(</span>ssc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token comment">// 2. 双流 join</span></pre></td></tr><tr><td data-num="31"></td><td><pre>     <span class="token keyword">val</span> fullJoinStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>SaleDetail<span class="token punctuation">]</span> <span class="token operator">=</span> fullJoin<span class="token punctuation">(</span>infoStream<span class="token punctuation">,</span>detailStream<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>     <span class="token comment">// 3. 在数据中添加 user_info 数据</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">val</span> SaleDetailStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>SaleDetail<span class="token punctuation">]</span> <span class="token operator">=</span> addUserInfo<span class="token punctuation">(</span>fullJoinStream<span class="token punctuation">,</span>ssc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>     <span class="token comment">// 4. 将结果写到 es 中</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    sendToEs<span class="token punctuation">(</span>SaleDetailStream<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>   <span class="token comment">// 5. 测试</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    SaleDetailStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre> </pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    * 将数据写到 es 中，通过获取已有数据的 uid，然后取 mysql 中读取数据，并放置流中</pre></td></tr><tr><td data-num="47"></td><td><pre>    * @param fullJoinStream</pre></td></tr><tr><td data-num="48"></td><td><pre>    */</pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">def</span> addUserInfo<span class="token punctuation">(</span>fullJoinStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>SaleDetail<span class="token punctuation">]</span><span class="token punctuation">,</span>ssc<span class="token operator">:</span>StreamingContext<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    fullJoinStream<span class="token punctuation">.</span>transform<span class="token punctuation">(</span> rdd <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token comment">// 1. 读取指定 mysql 表中数据</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token keyword">val</span> Readrdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>UserInfo<span class="token punctuation">]</span> <span class="token operator">=</span> MyslqUtil<span class="token punctuation">.</span>ReadMySQLData<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span><span class="token string">"user_info"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token comment">// 2. 对数据进行转换，用于和原来的 RDD 进行 join</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token keyword">val</span> useInfoRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserInfo<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> Readrdd<span class="token punctuation">.</span>map<span class="token punctuation">(</span>user <span class="token keyword">=></span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token comment">// 3. 将 saleDetail 转换成 kv，然后和 user 进行 join，补齐 user 的信息</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token keyword">val</span> detailRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> SaleDetail<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdd<span class="token punctuation">.</span>map<span class="token punctuation">(</span>saleDetail <span class="token keyword">=></span> <span class="token punctuation">(</span>saleDetail<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>saleDetail<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token comment">// 4. RDD 进行 join</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      detailRDD<span class="token punctuation">.</span>join<span class="token punctuation">(</span>useInfoRDD<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token punctuation">.</span>map<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>          <span class="token keyword">case</span> <span class="token punctuation">(</span>userId<span class="token punctuation">,</span><span class="token punctuation">(</span>saleDetail<span class="token punctuation">,</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            saleDetail<span class="token punctuation">.</span>mergeUserInfo<span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    * @param infoStream</pre></td></tr><tr><td data-num="75"></td><td><pre>    * @param detailStream</pre></td></tr><tr><td data-num="76"></td><td><pre>    */</pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token keyword">def</span> fullJoin<span class="token punctuation">(</span>infoStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span><span class="token punctuation">,</span> detailStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token comment">// 将 info 的数据缓存到 redis 中</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">def</span> cacheOrderInfoToRedis<span class="token punctuation">(</span>client<span class="token operator">:</span> Jedis<span class="token punctuation">,</span> orderInfo<span class="token operator">:</span> OrderInfo<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      <span class="token comment">/**</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        * orderinfo 在 redis 中的缓存信息</pre></td></tr><tr><td data-num="82"></td><td><pre>        * key : "order_info :" + orderInfo.id</pre></td></tr><tr><td data-num="83"></td><td><pre>        * value : orderInfo 一条数据</pre></td></tr><tr><td data-num="84"></td><td><pre>        */</pre></td></tr><tr><td data-num="85"></td><td><pre>      client<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"order_info :"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span>id<span class="token punctuation">,</span> Serialization<span class="token punctuation">.</span>write<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">(</span>DefaultFormats<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">def</span> cacheOrderDetailToRedis<span class="token punctuation">(</span>client<span class="token operator">:</span> Jedis<span class="token punctuation">,</span> orderDetail<span class="token operator">:</span> OrderDetail<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      client<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"orderDetail:"</span> <span class="token operator">+</span> orderDetail<span class="token punctuation">.</span>order_id <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> orderDetail<span class="token punctuation">.</span>id<span class="token punctuation">,</span> Serialization<span class="token punctuation">.</span>write<span class="token punctuation">(</span>orderDetail<span class="token punctuation">)</span><span class="token punctuation">(</span>DefaultFormats<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token comment">// 1. 对 rdd 进行转换，因为只有 kv 类型的数据才能进行 join</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token keyword">val</span> mapInfoStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> OrderInfo<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> infoStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>info <span class="token keyword">=></span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>id<span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">val</span> mapDetailStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> OrderDetail<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> detailStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>detail <span class="token keyword">=></span> <span class="token punctuation">(</span>detail<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>detail<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token comment">// 2. 对流进行 join，join 时是按照相同 key 会 join 在一起。而且是一条一条的 join, 一个订单会对应多个订单详情表</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token comment">// (order_id1,(订单 1，详情 1))，(order_id1,(订单 1，详情 2))</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token comment">// 为了提高效率，使用一个分区的数据同时进行计算</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>    mapInfoStream<span class="token punctuation">.</span>fullOuterJoin<span class="token punctuation">(</span>mapDetailStream<span class="token punctuation">)</span><span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>it <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>      <span class="token comment">// 1. 获取 redis 的连接，因为需要从 redis 中获取数据</span></pre></td></tr><tr><td data-num="102"></td><td><pre>      <span class="token keyword">val</span> client<span class="token operator">:</span> Jedis <span class="token operator">=</span> RedisUtils<span class="token punctuation">.</span>getClient</pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token keyword">val</span> result <span class="token operator">=</span> it<span class="token punctuation">.</span>flatMap <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        <span class="token comment">//info 和 detail 都有数据</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">case</span> <span class="token punctuation">(</span>order_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>Some<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span>orderDetail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span></pre></td></tr><tr><td data-num="107"></td><td><pre>          <span class="token comment">// 1. 将 info 数据写到缓存中，orderinfo 是对象，需要解析为 json 字符串</span></pre></td></tr><tr><td data-num="108"></td><td><pre>          cacheOrderInfoToRedis<span class="token punctuation">(</span>client<span class="token punctuation">,</span> orderInfo<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre>          <span class="token comment">// 2. 将数据进行合并</span></pre></td></tr><tr><td data-num="110"></td><td><pre>          <span class="token keyword">val</span> infoDetail<span class="token operator">:</span> SaleDetail <span class="token operator">=</span> SaleDetail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderInfo<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderDetail<span class="token punctuation">(</span>orderDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre>          <span class="token comment">// 3. 从 redis 中获取 detail 的数据</span></pre></td></tr><tr><td data-num="112"></td><td><pre>          <span class="token comment">/**</span></pre></td></tr><tr><td data-num="113"></td><td><pre>            * orderDetails 在 redis 中的缓存信息</pre></td></tr><tr><td data-num="114"></td><td><pre>            * key ： orderDetail + orderInfo.id + orderDetail.id</pre></td></tr><tr><td data-num="115"></td><td><pre>            * value: orderDetail 一条数据</pre></td></tr><tr><td data-num="116"></td><td><pre>            */</pre></td></tr><tr><td data-num="117"></td><td><pre>          <span class="token keyword">val</span> details<span class="token operator">:</span> util<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token string">"orderDetail:"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">":*"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="118"></td><td><pre>          <span class="token comment">// 创建一个集合来接收 detalis</span></pre></td></tr><tr><td data-num="119"></td><td><pre>          <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConversions<span class="token punctuation">.</span>_</pre></td></tr><tr><td data-num="120"></td><td><pre>          <span class="token keyword">var</span> saleDetails <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">[</span>SaleDetail<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="121"></td><td><pre>          saleDetails<span class="token punctuation">.</span>add<span class="token punctuation">(</span>infoDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="122"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>detail <span class="token keyword">&lt;-</span> details<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>            <span class="token comment">// 将字符串转换为样例类</span></pre></td></tr><tr><td data-num="124"></td><td><pre>            <span class="token keyword">val</span> obj<span class="token operator">:</span> OrderDetail <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>detail<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="125"></td><td><pre>            <span class="token comment">// 从缓存中删除已经被使用的数据</span></pre></td></tr><tr><td data-num="126"></td><td><pre>            client<span class="token punctuation">.</span>del<span class="token punctuation">(</span>detail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="127"></td><td><pre>            <span class="token comment">// 将数据进行合并</span></pre></td></tr><tr><td data-num="128"></td><td><pre>            <span class="token keyword">val</span> saleDetail <span class="token operator">=</span> SaleDetail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderInfo<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderDetail<span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="129"></td><td><pre>            saleDetails<span class="token punctuation">.</span>add<span class="token punctuation">(</span>saleDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="130"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>          saleDetails</pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="134"></td><td><pre>          * orderinfo 有数据，但是 detail 没有数据</pre></td></tr><tr><td data-num="135"></td><td><pre>          */</pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token keyword">case</span> <span class="token punctuation">(</span>order_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>Some<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span></pre></td></tr><tr><td data-num="137"></td><td><pre>          <span class="token comment">// 1. 将 info 数据写到缓存中，orderinfo 是对象，需要解析为 json 字符串</span></pre></td></tr><tr><td data-num="138"></td><td><pre>          cacheOrderInfoToRedis<span class="token punctuation">(</span>client<span class="token punctuation">,</span> orderInfo<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="139"></td><td><pre>          <span class="token comment">// 2. 从 redis 中获取 detail 的数据</span></pre></td></tr><tr><td data-num="140"></td><td><pre>          <span class="token comment">/**</span></pre></td></tr><tr><td data-num="141"></td><td><pre>            * orderDetails 在 redis 中的缓存信息</pre></td></tr><tr><td data-num="142"></td><td><pre>            * key ： orderDetail + orderInfo.id + orderDetail.id</pre></td></tr><tr><td data-num="143"></td><td><pre>            * value: orderDetail 一条数据</pre></td></tr><tr><td data-num="144"></td><td><pre>            */</pre></td></tr><tr><td data-num="145"></td><td><pre>          <span class="token keyword">val</span> details<span class="token operator">:</span> util<span class="token punctuation">.</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token string">"orderDetail:"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">":*"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="146"></td><td><pre>          <span class="token comment">// 创建一个集合来接收 detalis</span></pre></td></tr><tr><td data-num="147"></td><td><pre>          <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConversions<span class="token punctuation">.</span>_</pre></td></tr><tr><td data-num="148"></td><td><pre>          <span class="token keyword">var</span> saleDetails <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">[</span>SaleDetail<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="149"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>detail <span class="token keyword">&lt;-</span> details<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>            <span class="token comment">// 将字符串转换为样例类</span></pre></td></tr><tr><td data-num="151"></td><td><pre>            <span class="token keyword">val</span> obj<span class="token operator">:</span> OrderDetail <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>detail<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="152"></td><td><pre>            <span class="token comment">// 从缓存中删除已经被使用的数据</span></pre></td></tr><tr><td data-num="153"></td><td><pre>            client<span class="token punctuation">.</span>del<span class="token punctuation">(</span>detail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="154"></td><td><pre>            <span class="token comment">// 将数据进行合并</span></pre></td></tr><tr><td data-num="155"></td><td><pre>            <span class="token keyword">val</span> saleDetail <span class="token operator">=</span> SaleDetail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderInfo<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderDetail<span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="156"></td><td><pre>            saleDetails<span class="token punctuation">.</span>add<span class="token punctuation">(</span>saleDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="157"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>          saleDetails</pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token keyword">case</span> <span class="token punctuation">(</span>order_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>None<span class="token punctuation">,</span> Some<span class="token punctuation">(</span>orderDetail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span></pre></td></tr><tr><td data-num="161"></td><td><pre>          <span class="token comment">// 1. 从 redis 缓存中读取 info 的数据</span></pre></td></tr><tr><td data-num="162"></td><td><pre>          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"order_info :"</span> <span class="token operator">+</span> orderDetail<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="163"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>            <span class="token comment">// 将 detail 的数据写入缓存中</span></pre></td></tr><tr><td data-num="165"></td><td><pre>            cacheOrderDetailToRedis<span class="token punctuation">(</span>client<span class="token punctuation">,</span> orderDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="166"></td><td><pre>            List<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="167"></td><td><pre>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>            <span class="token keyword">val</span> info <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>value<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="169"></td><td><pre>            <span class="token keyword">val</span> saleDetail <span class="token operator">=</span> SaleDetail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderInfo<span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span>mergeOrderDetail<span class="token punctuation">(</span>orderDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="170"></td><td><pre>            List<span class="token punctuation">(</span>saleDetail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="171"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>      client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="174"></td><td><pre>      result</pre></td></tr><tr><td data-num="175"></td><td><pre></pre></td></tr><tr><td data-num="176"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="183"></td><td><pre>    * 获取 info 流和 detail 流</pre></td></tr><tr><td data-num="184"></td><td><pre>    * @param ssc streamingcontext 对象</pre></td></tr><tr><td data-num="185"></td><td><pre>    * @return</pre></td></tr><tr><td data-num="186"></td><td><pre>    */</pre></td></tr><tr><td data-num="187"></td><td><pre>  <span class="token keyword">def</span> getOrderInfoAndOrderDetailStream<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token comment">// 第一步：获取 topic_order_info 的流，并将数据封装成样例类</span></pre></td></tr><tr><td data-num="189"></td><td><pre>    <span class="token keyword">val</span> infoStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>Constant<span class="token punctuation">.</span>TOPIC_ORDER_INFO<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="190"></td><td><pre>      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>json <span class="token keyword">=></span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>json<span class="token punctuation">,</span>classOf<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    <span class="token comment">// 第二步：获取 topic_order_detail 的流，并将数据封装成样例类</span></pre></td></tr><tr><td data-num="192"></td><td><pre>    <span class="token keyword">val</span> detailStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span> Constant<span class="token punctuation">.</span>TOPIC_ORDER_DETAIL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="193"></td><td><pre>      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>json <span class="token keyword">=></span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>json<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token punctuation">(</span>infoStream<span class="token punctuation">,</span>detailStream<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="195"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="八-sparkstreaming的数据写到mysql"><a class="anchor" href="#八-sparkstreaming的数据写到mysql">#</a> 八、sparkstreaming 的数据写到 mysql</h2><pre><code>
</code></pre><h2 id="九-sparkstreaming的数据写到elasticsearch"><a class="anchor" href="#九-sparkstreaming的数据写到elasticsearch">#</a> 九、sparkstreaming 的数据写到 elasticsearch</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>searchbox<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>JestClient<span class="token punctuation">,</span> JestClientFactory<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>searchbox<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>HttpClientConfig</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>searchbox<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>Bulk<span class="token punctuation">,</span> Index<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="9"></td><td><pre>  **</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @create 2020-07-20 14:58:11</pre></td></tr><tr><td data-num="12"></td><td><pre>  */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">object</span> EsUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    *  1. 获取 es 的客户端</pre></td></tr><tr><td data-num="17"></td><td><pre>    *     a、创建一个工厂对象</pre></td></tr><tr><td data-num="18"></td><td><pre>    *     b、es 的配置参数</pre></td></tr><tr><td data-num="19"></td><td><pre>    *     c、通过工厂对象 + 配置参数 创建 es 的对象</pre></td></tr><tr><td data-num="20"></td><td><pre>    *</pre></td></tr><tr><td data-num="21"></td><td><pre>    */</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">val</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> JestClientFactory</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">//es 的 url</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">val</span> esurl <span class="token operator">=</span> <span class="token string">"http://hadoop105:9200"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">val</span> conf<span class="token operator">:</span> HttpClientConfig <span class="token operator">=</span> <span class="token keyword">new</span> HttpClientConfig<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>esurl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">.</span>connTimeout<span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 连接延迟时间</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">.</span>readTimeout<span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 获取数据延迟时间</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">.</span>maxTotalConnection<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 最大的连接数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">.</span>multiThreaded<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 是否启动多线程</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  factory<span class="token punctuation">.</span>setHttpClientConfig<span class="token punctuation">(</span>conf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    * 向 es 中添加多条数据</pre></td></tr><tr><td data-num="37"></td><td><pre>    * @param index index</pre></td></tr><tr><td data-num="38"></td><td><pre>    * @param sources 多条数据源</pre></td></tr><tr><td data-num="39"></td><td><pre>    */</pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">def</span> insertBulk<span class="token punctuation">(</span>index<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>sources<span class="token operator">:</span>Iterator<span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 创建 es 的客户端</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">val</span> client<span class="token operator">:</span> JestClient <span class="token operator">=</span> factory<span class="token punctuation">.</span>getObject</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 构建一个 bulk，配置 index 和 type</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">var</span> bulkBuilder<span class="token operator">:</span> Bulk<span class="token punctuation">.</span>Builder <span class="token operator">=</span> <span class="token keyword">new</span> Bulk<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">.</span>defaultIndex<span class="token punctuation">(</span>index<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token punctuation">.</span>defaultType<span class="token punctuation">(</span><span class="token string">"_doc"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 遍历多个数据源，使用模式匹配的方式</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    sources<span class="token punctuation">.</span>foreach<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token comment">// 如果传了 document_id，则使用，如果没有传递，则随机生成一个 document_id</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span>id <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>source<span class="token punctuation">)</span> <span class="token keyword">=></span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">val</span> action <span class="token operator">=</span> <span class="token keyword">new</span> Index<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token comment">// 添加 action</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        bulkBuilder<span class="token punctuation">.</span>addAction<span class="token punctuation">(</span>action<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token keyword">case</span> source <span class="token keyword">=></span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">val</span> action<span class="token operator">:</span> Index<span class="token punctuation">.</span>Builder <span class="token operator">=</span> <span class="token keyword">new</span> Index<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>source<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        bulkBuilder<span class="token punctuation">.</span>addAction<span class="token punctuation">(</span>action<span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">// 执行</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    client<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>bulkBuilder<span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">// 关闭客户端</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    client<span class="token punctuation">.</span>shutdownClient<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    * 往 es 中写单条数据</pre></td></tr><tr><td data-num="68"></td><td><pre>    * @param index index</pre></td></tr><tr><td data-num="69"></td><td><pre>    * @param source 数据源，具体添加的数据</pre></td></tr><tr><td data-num="70"></td><td><pre>    * @param id document_id</pre></td></tr><tr><td data-num="71"></td><td><pre>    *</pre></td></tr><tr><td data-num="72"></td><td><pre>    */</pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token keyword">def</span> insertSingle<span class="token punctuation">(</span>index <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>source<span class="token operator">:</span>Object<span class="token punctuation">,</span>id <span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">val</span> client<span class="token operator">:</span> JestClient <span class="token operator">=</span> factory<span class="token punctuation">.</span>getObject</pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="78"></td><td><pre>      * 2. 往 es 中写数据</pre></td></tr><tr><td data-num="79"></td><td><pre>      */</pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">val</span> action<span class="token operator">:</span> Index <span class="token operator">=</span> <span class="token keyword">new</span> Index<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>source<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token punctuation">.</span>index<span class="token punctuation">(</span>index<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token punctuation">.</span>`<span class="token keyword">type</span>`<span class="token punctuation">(</span><span class="token string">"_doc"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token punctuation">.</span>id<span class="token punctuation">(</span>id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>    client<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>action<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      * 3. 关闭客户端的连接</pre></td></tr><tr><td data-num="90"></td><td><pre>      */</pre></td></tr><tr><td data-num="91"></td><td><pre>    client<span class="token punctuation">.</span>shutdownClient<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token keyword">case</span>  <span class="token keyword">class</span>  User<span class="token punctuation">(</span>name <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    * 将封装好的数据发往 es 中</pre></td></tr><tr><td data-num="98"></td><td><pre>    * @param fullJoinStream</pre></td></tr><tr><td data-num="99"></td><td><pre>    */</pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token keyword">def</span> sendToEs<span class="token punctuation">(</span>fullJoinStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>SaleDetail<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token comment">// 1. 将数据写到 es 中</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    fullJoinStream<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>      rdd<span class="token punctuation">.</span>foreachPartition<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        it <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>          EsUtil<span class="token punctuation">.</span>insertBulk<span class="token punctuation">(</span><span class="token string">"gmall_sale_detail"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>map<span class="token punctuation">(</span>detail <span class="token keyword">=></span> <span class="token punctuation">(</span>detail<span class="token punctuation">.</span>order_id <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> detail<span class="token punctuation">.</span>order_detail_id<span class="token punctuation">,</span> detail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>      <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="十-sparkstreaming的数据写到hbase"><a class="anchor" href="#十-sparkstreaming的数据写到hbase">#</a> 十、sparkstreaming 的数据写到 hbase</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 5. 将新增 mid 的详情写到 hbase 中。</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token keyword">import</span>  <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>phoenix<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>_</pre></td></tr><tr><td data-num="3"></td><td><pre>      rdd<span class="token punctuation">.</span>saveToPhoenix<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"GMALL_DAU"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        Seq<span class="token punctuation">(</span><span class="token string">"MID"</span><span class="token punctuation">,</span> <span class="token string">"UID"</span><span class="token punctuation">,</span> <span class="token string">"APPID"</span><span class="token punctuation">,</span> <span class="token string">"AREA"</span><span class="token punctuation">,</span> <span class="token string">"OS"</span><span class="token punctuation">,</span> <span class="token string">"CHANNEL"</span><span class="token punctuation">,</span> <span class="token string">"LOGTYPE"</span><span class="token punctuation">,</span> <span class="token string">"VERSION"</span><span class="token punctuation">,</span> <span class="token string">"TS"</span><span class="token punctuation">,</span> <span class="token string">"LOGDATE"</span><span class="token punctuation">,</span> <span class="token string">"LOGHOUR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        zkUrl <span class="token operator">=</span> Some<span class="token punctuation">(</span><span class="token string">"hadoop105,hadoop106,hadoop107:2181"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="十一-如何连接redis"><a class="anchor" href="#十一-如何连接redis">#</a> 十一、如何连接 redis</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>Jedis<span class="token punctuation">,</span> JedisPool<span class="token punctuation">,</span> JedisPoolConfig<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  * @Description 获取与 redis 的连接</pre></td></tr><tr><td data-num="7"></td><td><pre>  **</pre></td></tr><tr><td data-num="8"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @create 2020-07-15 16:24:08</pre></td></tr><tr><td data-num="10"></td><td><pre>  */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">object</span> RedisUtils <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> JedisPoolConfig</pre></td></tr><tr><td data-num="14"></td><td><pre>  conf<span class="token punctuation">.</span>setMaxIdle<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token comment">// 连接池中最大的空闲连接数量</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  conf<span class="token punctuation">.</span>setMinIdle<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 连接池中最小的空闲连接数量</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  conf<span class="token punctuation">.</span>setMaxTotal<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 最大的连接数量</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  conf<span class="token punctuation">.</span>setBlockWhenExhausted<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 没有可用的连接时是否等待</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  conf<span class="token punctuation">.</span>setMaxWaitMillis<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">// 最大的等待时间</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  conf<span class="token punctuation">.</span>setTestOnCreate<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 测试是否连接</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  conf<span class="token punctuation">.</span>setTestOnBorrow<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 每次获得连接的进行测试</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  conf<span class="token punctuation">.</span>setTestOnReturn<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">// 验证连接池的属性</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">val</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> JedisPool<span class="token punctuation">(</span>conf<span class="token punctuation">,</span><span class="token string">"hadoop105"</span><span class="token punctuation">,</span><span class="token number">8000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">def</span> getClient <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 从连接池中获取一个连接</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    pool<span class="token punctuation">.</span>getResource</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token comment">/*</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   测试是否能够连接 redis 并且是否可以写数据</pre></td></tr><tr><td data-num="31"></td><td><pre>    */</pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 获取一个客户端</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">val</span> client<span class="token operator">:</span> Jedis <span class="token operator">=</span> getClient</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 使用客户端往 redis 中写数据</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    client<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"k2"</span><span class="token punctuation">,</span><span class="token string">"lianzp"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 关闭连接</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 关闭连接池</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    pool<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="十二-sparkstreaming如何连接mysql"><a class="anchor" href="#十二-sparkstreaming如何连接mysql">#</a> 十二、SparkStreaming 如何连接 mysql</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>realtime<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserInfo</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  * @Description SparkStreaming 使用 jdbc 的方式连接 mysql</pre></td></tr><tr><td data-num="11"></td><td><pre>  **</pre></td></tr><tr><td data-num="12"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="13"></td><td><pre>  * @create 2020-07-21 20:27:52</pre></td></tr><tr><td data-num="14"></td><td><pre>  */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">object</span> MyslqUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">val</span> url <span class="token operator">=</span> ConfigUtils<span class="token punctuation">.</span>getProperties<span class="token punctuation">(</span><span class="token string">"gmall.properties"</span><span class="token punctuation">,</span><span class="token string">"url"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">val</span> password <span class="token operator">=</span>  ConfigUtils<span class="token punctuation">.</span>getProperties<span class="token punctuation">(</span><span class="token string">"gmall.properties"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">val</span> user <span class="token operator">=</span>  ConfigUtils<span class="token punctuation">.</span>getProperties<span class="token punctuation">(</span><span class="token string">"gmall.properties"</span><span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">val</span> props <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  props<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  props<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">def</span> ReadMySQLData<span class="token punctuation">(</span>ssc <span class="token operator">:</span> StreamingContext<span class="token punctuation">,</span>tableName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">// 构建 sparkSession 对象</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">.</span>config<span class="token punctuation">(</span>ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>getConf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 读取指定路径下的数据，默认按行读取</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>jdbc<span class="token punctuation">(</span>url<span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> props<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">.</span>as<span class="token punctuation">[</span>UserInfo<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">.</span>rdd</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="十二-es中的数据如何写到前端"><a class="anchor" href="#十二-es中的数据如何写到前端">#</a> 十二、es 中的数据如何写到前端</h2><h3 id="1-需求分析"><a class="anchor" href="#1-需求分析">#</a> 1. 需求分析</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> <span class="token string">'思想'</span>：将数据写给前端，首先需要通过mybaits创建一个接口，前端通过这个接口，来访问数据。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span> <span class="token string">'实现步骤'</span>：</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">1.</span> 获取es的客户端</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">2.</span> 创建查询的对象</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token number">3.</span> 执行查询</pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">4.</span> 获取数据并对数据进行解析</pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token number">5.</span> 将解析后的数据发送到网页上进行展示</pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token number">6.</span> 前端对接发送到网页中的数据，实现数据展示。</pre></td></tr></table></figure><ul><li>第一步：需求分析</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. ' 用户的需求 '：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       用户输入关键词和时间，查询这天的</pre></td></tr><tr><td data-num="3"></td><td><pre>       <span class="token number">1.</span> 男女比例：男生和女生的比例</pre></td></tr><tr><td data-num="4"></td><td><pre>       <span class="token number">2.</span> 年龄比例数据：不同年龄段的用户数量</pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token number">3.</span> 同时展示当天的数据明细。</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">-- 2. ' 案例 '：</span></pre></td></tr><tr><td data-num="7"></td><td><pre>       如用户查询：<span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">21</span>这天，小米手机订单销售情况，需要的数据有：</pre></td></tr><tr><td data-num="8"></td><td><pre>       <span class="token number">1.</span> 男女比例</pre></td></tr><tr><td data-num="9"></td><td><pre>       <span class="token number">2.</span> 购买的年龄端分布情况</pre></td></tr><tr><td data-num="10"></td><td><pre>       <span class="token number">3.</span> 订单详情信息。</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">-- 3. 实现方式</span></pre></td></tr><tr><td data-num="12"></td><td><pre>       <span class="token number">1.</span> 如何获取es中的数据</pre></td></tr><tr><td data-num="13"></td><td><pre>          a、连接es</pre></td></tr><tr><td data-num="14"></td><td><pre>          b、通过dsl的语法来获取数据</pre></td></tr><tr><td data-num="15"></td><td><pre>       <span class="token number">2.</span> 如何将获取的数据转换为对应的数据结构 </pre></td></tr><tr><td data-num="16"></td><td><pre>          数据包含：</pre></td></tr><tr><td data-num="17"></td><td><pre>          a、男女比例的数据</pre></td></tr><tr><td data-num="18"></td><td><pre>          b、分年龄段聚合的数据</pre></td></tr><tr><td data-num="19"></td><td><pre>          c、订单详情的数据明细</pre></td></tr><tr><td data-num="20"></td><td><pre>       <span class="token number">3.</span> 数据如何发送到网页中</pre></td></tr><tr><td data-num="21"></td><td><pre>          a、通过mybaits的数据的相应的方式。</pre></td></tr></table></figure><p>![image-20200722144734688](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722144734.png)</p><p>![image-20200722144700964](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722144708.png)</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 4. 在 kibana 中使用 dsl 实现如上的需求为：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     <span class="token string">'需求1：统计男女比例数据分析'</span>：</pre></td></tr><tr><td data-num="3"></td><td><pre>     GET  gmall_sale_detail<span class="token operator">/</span>_search</pre></td></tr><tr><td data-num="4"></td><td><pre>&#123;</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token string">"query"</span>: &#123;</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token string">"bool"</span>: &#123;</pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token string">"filter"</span>: &#123;</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"term"</span>: &#123;</pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token string">"dt"</span>: <span class="token string">"2020-07-22"</span>  <span class="token comment">-- 获取哪一天的数据</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num="11"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">,</span> <span class="token string">"must"</span>: <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        &#123;<span class="token string">"match"</span>: &#123;</pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token string">"sku_name"</span>: <span class="token string">"小米手机"</span> <span class="token comment">-- 查询产品，是模糊查询，采用了中文 ik 的分词器</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        &#125;&#125;</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="18"></td><td><pre>  &#125;<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token string">"aggs"</span>: &#123;</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token string">"group_by_user_gender"</span>: &#123;  <span class="token comment">-- 分组的名字</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token string">"terms"</span>: &#123;</pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token string">"field"</span>: <span class="token string">"user_gender"</span><span class="token punctuation">,</span> <span class="token comment">-- 按照什么进行分组</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token string">"size"</span>: <span class="token number">2</span>               <span class="token comment">-- 分组后的条目数量，假如可以分为 10 个组时，设定分组 size 为 2，则剩余 8 个组为进入其他组</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="25"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="26"></td><td><pre>  &#125;<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token string">"from"</span>: <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token comment">-- 数据展示时，会将聚合前数据进行展示，也就是过滤出来数据，from 表示从几个开始展示</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token string">"size"</span>: <span class="token number">3</span>     <span class="token comment">--  表示从 from 开始，展示多少条数据</span></pre></td></tr><tr><td data-num="29"></td><td><pre>&#125;</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token string">'需求2'</span>：统计购买这些产品不同年龄端的数据。我们的做法是：</pre></td></tr><tr><td data-num="32"></td><td><pre>          通过dsl的查询语句，得到同一天购买指定商品的同一年龄的数据，如：</pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">21</span>，购买有小米手机关键字的订单中各个年龄的数据。</pre></td></tr><tr><td data-num="34"></td><td><pre>          等待拿到了这个数据以后，再对数据进行区间判断，计算出每个年龄端的数量。</pre></td></tr></table></figure><p>&lt;img src=&quot;<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722182739.png&quot; alt=&quot;image-20200722182738113&quot; style=&quot;zoom:50%;&quot; /&gt;</p><h3 id="2-具体步骤"><a class="anchor" href="#2-具体步骤">#</a> 2. 具体步骤</h3><h4 id="21-第一步获取es的客户端-解析数据-并将数据写给controller"><a class="anchor" href="#21-第一步获取es的客户端-解析数据-并将数据写给controller">#</a> 2.1 第一步：获取 es 的客户端、解析数据、并将数据写给 controller</h4><p>在<mark> gmall-publisher</mark> 项目中的<mark> service</mark> 包中<mark> PublisherService 接口</mark>中定义一个<mark>抽象方法</mark>，指定获取数据类型以及需要传递的参数</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 参数分析：见参数说明</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 2. 返回值类型说明：</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token number">1.</span><span class="token string">'希望返回的数据'</span>：</pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">1.</span> 查询数据的总数量：“total”：<span class="token number">4995</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token number">2.</span> 分组后聚合的数据：</pre></td></tr><tr><td data-num="6"></td><td><pre>                    男女的聚合数据：genderAgg：Map<span class="token punctuation">(</span><span class="token string">"f"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">2381</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">2614</span><span class="token punctuation">)</span> <span class="token string">'性别-> 数量'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    年龄分布聚合数据：ageAgg ：Map<span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token string">'年龄->数量'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token number">3.</span> 详情数据：detail:List<span class="token punctuation">(</span>Map<span class="token punctuation">(</span>一条数据<span class="token punctuation">)</span>，Map<span class="token punctuation">(</span>一条数据<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    一条数据：</pre></td></tr><tr><td data-num="10"></td><td><pre>                    order_detail_id <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"30293"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    user_age <span class="token operator">-</span><span class="token operator">></span> <span class="token number">17</span></pre></td></tr><tr><td data-num="12"></td><td><pre>       <span class="token number">2.</span> <span class="token string">'那么这些数据我们都需要'</span>：</pre></td></tr><tr><td data-num="13"></td><td><pre>            男女的聚合数据:total <span class="token operator">+</span> gendetAgg <span class="token operator">+</span> detail</pre></td></tr><tr><td data-num="14"></td><td><pre>            年龄分布聚合数据:total <span class="token operator">+</span> ageAgg <span class="token operator">+</span> detail</pre></td></tr><tr><td data-num="15"></td><td><pre>       <span class="token number">3.</span> <span class="token string">'返回值类型'</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span>“total”：<span class="token number">4995</span>，</pre></td></tr><tr><td data-num="17"></td><td><pre>                              genderAgg：Map<span class="token punctuation">(</span><span class="token string">"f"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">2381</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">2614</span><span class="token punctuation">)</span>，</pre></td></tr><tr><td data-num="18"></td><td><pre>                              detail:List<span class="token punctuation">(</span>Map<span class="token punctuation">(</span>一条数据<span class="token punctuation">)</span>，Map<span class="token punctuation">(</span>一条数据<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     *</pre></td></tr><tr><td data-num="3"></td><td><pre>     * @param dt 查询具体哪一天的数据</pre></td></tr><tr><td data-num="4"></td><td><pre>     * @param keyWords 查询的关键词</pre></td></tr><tr><td data-num="5"></td><td><pre>     * @param aggField 分组的字段</pre></td></tr><tr><td data-num="6"></td><td><pre>     * @param aggCount 分组的组数</pre></td></tr><tr><td data-num="7"></td><td><pre>     * @param startPage 查询哪一页</pre></td></tr><tr><td data-num="8"></td><td><pre>     * @param sizePerPage 查询后每页的数据的数量</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>   Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> getSaleDetailAndAgg<span class="token punctuation">(</span>String dt<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                               String keyWords<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                               String aggField<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                               <span class="token keyword">int</span> aggCount<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                               <span class="token keyword">int</span> startPage<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                               <span class="token keyword">int</span> sizePerPage</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>在<mark> gmall-publisher</mark> 项目中的<mark> service</mark> 包中<mark> PublisherImpService 实现类</mark>中实现上面接口的抽象方法</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 分析 ： 创建一个 util 包，在包中创建 esUtil 类</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   在esUtil工具类中：</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">1.</span> 创建一个获取es客户端的方法</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">2.</span> 创建一个获取dsl语句的方法</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 2. 通过 esUtil 获取 es 的客户端和查询语句</span></pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gmallpublisher<span class="token punctuation">.</span>utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>searchbox<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>JestClient<span class="token punctuation">,</span> JestClientFactory<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>searchbox<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>HttpClientConfig</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>searchbox<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>Bulk<span class="token punctuation">,</span> Index<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-07-20 14:58:11</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">object</span> EsUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    *  1. 获取 es 的客户端</pre></td></tr><tr><td data-num="16"></td><td><pre>    *     a、创建一个工厂对象</pre></td></tr><tr><td data-num="17"></td><td><pre>    *     b、es 的配置参数</pre></td></tr><tr><td data-num="18"></td><td><pre>    *     c、通过工厂对象 + 配置参数 创建 es 的对象</pre></td></tr><tr><td data-num="19"></td><td><pre>    */</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">val</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> JestClientFactory</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">//es 的 url</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">val</span> esurl <span class="token operator">=</span> <span class="token string">"http://hadoop105:9200"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">val</span> conf<span class="token operator">:</span> HttpClientConfig <span class="token operator">=</span> <span class="token keyword">new</span> HttpClientConfig<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span>esurl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">.</span>connTimeout<span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 连接延迟时间</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">.</span>readTimeout<span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 获取数据延迟时间</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">.</span>maxTotalConnection<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 最大的连接数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">.</span>multiThreaded<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 是否启动多线程</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  factory<span class="token punctuation">.</span>setHttpClientConfig<span class="token punctuation">(</span>conf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">def</span> getESClient<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 创建 es 的客户端</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    factory<span class="token punctuation">.</span>getObject</pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">def</span> getDSL<span class="token punctuation">(</span>dt <span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>             keyWords <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>             aggField <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>             aggCount <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>             startPage <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>             sizePerPage <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>   s<span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="44"></td><td><pre>     |&#123;</pre></td></tr><tr><td data-num="45"></td><td><pre>     |  "query": &#123;</pre></td></tr><tr><td data-num="46"></td><td><pre>     |    "bool": &#123;</pre></td></tr><tr><td data-num="47"></td><td><pre>     |      "filter": &#123;</pre></td></tr><tr><td data-num="48"></td><td><pre>     |        "term": &#123;</pre></td></tr><tr><td data-num="49"></td><td><pre>     |          "dt": $&#123;dt&#125;</pre></td></tr><tr><td data-num="50"></td><td><pre>     |        &#125;</pre></td></tr><tr><td data-num="51"></td><td><pre>     |      &#125;</pre></td></tr><tr><td data-num="52"></td><td><pre>     |      , "must": [</pre></td></tr><tr><td data-num="53"></td><td><pre>     |        &#123;"match": &#123;</pre></td></tr><tr><td data-num="54"></td><td><pre>     |          "sku_name": $&#123;keyWords&#125;</pre></td></tr><tr><td data-num="55"></td><td><pre>     |        &#125;&#125;</pre></td></tr><tr><td data-num="56"></td><td><pre>     |      ]</pre></td></tr><tr><td data-num="57"></td><td><pre>     |    &#125;</pre></td></tr><tr><td data-num="58"></td><td><pre>     |  &#125;,</pre></td></tr><tr><td data-num="59"></td><td><pre>     |  "aggs": &#123;</pre></td></tr><tr><td data-num="60"></td><td><pre>     |    "group_by_$&#123;aggField&#125;": &#123;</pre></td></tr><tr><td data-num="61"></td><td><pre>     |      "terms": &#123;</pre></td></tr><tr><td data-num="62"></td><td><pre>     |        "field": $&#123;aggField&#125;,</pre></td></tr><tr><td data-num="63"></td><td><pre>     |        "size": $&#123;aggCount&#125;</pre></td></tr><tr><td data-num="64"></td><td><pre>     |      &#125;</pre></td></tr><tr><td data-num="65"></td><td><pre>     |    &#125;</pre></td></tr><tr><td data-num="66"></td><td><pre>     |  &#125;,</pre></td></tr><tr><td data-num="67"></td><td><pre>     |  "from": $&#123;(startPage - 1)*sizePerPage&#125;,</pre></td></tr><tr><td data-num="68"></td><td><pre>     |  "size": $&#123;sizePerPage&#125;</pre></td></tr><tr><td data-num="69"></td><td><pre>     |&#125;</pre></td></tr><tr><td data-num="70"></td><td><pre>   """<span class="token punctuation">.</span>stripMargin</pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 代码实现，具体的步骤：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       <span class="token number">1.</span> 获取es的客户端</pre></td></tr><tr><td data-num="3"></td><td><pre>       <span class="token number">2.</span> 获取查询的对象</pre></td></tr><tr><td data-num="4"></td><td><pre>       <span class="token number">3.</span> 执行查询并返回查询的结果，创建一个结果集合，用来接收这三个部分的数据</pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token number">4.</span> 解析total数据</pre></td></tr><tr><td data-num="6"></td><td><pre>       <span class="token number">5.</span> 解析聚合的数据</pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token number">1.</span> 创建一个集合来接收</pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token number">2.</span> 获取聚合的数据，是一个集合</pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token number">3.</span> 遍历集合，取出<span class="token keyword">key</span>和<span class="token keyword">value</span>，并把数据写到创建的集合中</pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token number">4.</span> 将集合写到结果的集合中</pre></td></tr><tr><td data-num="11"></td><td><pre>       <span class="token number">6.</span> 解析订单详情的数据</pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token number">1.</span> 创建一个集合来接收</pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token number">2.</span> 获取聚合的数据，是一个集合</pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token number">3.</span> 遍历集合，将一条数据作为一个整体，并把数据写到创建的集合中</pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token number">4.</span> 将集合写到结果的集合中</pre></td></tr><tr><td data-num="16"></td><td><pre>       <span class="token number">7.</span> 返回结果集合，那么结果集合中的数据为：</pre></td></tr><tr><td data-num="17"></td><td><pre>          （<span class="token string">"total"</span>：total，</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token string">"agg"</span>:（<span class="token keyword">key</span>：<span class="token keyword">value</span>，<span class="token keyword">key</span>，<span class="token keyword">value</span>，<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token string">"detail"</span>:<span class="token punctuation">(</span>Map<span class="token punctuation">(</span>一条数据<span class="token punctuation">)</span>，Map<span class="token punctuation">(</span>一条数据<span class="token punctuation">)</span>，<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li>代码实现</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     * Map (key,vaule) = (</pre></td></tr><tr><td data-num="3"></td><td><pre>     * “total”：4995，</pre></td></tr><tr><td data-num="4"></td><td><pre>     * genderAgg：Map ("f" -> 2381,"M"->2614)，</pre></td></tr><tr><td data-num="5"></td><td><pre>     * detail:List (Map (一条数据)，Map (一条数据))</pre></td></tr><tr><td data-num="6"></td><td><pre>     * )</pre></td></tr><tr><td data-num="7"></td><td><pre>     * @param dt 查询具体哪一天的数据</pre></td></tr><tr><td data-num="8"></td><td><pre>     * @param keyWords 查询的关键词</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @param aggField 分组的字段</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @param aggCount 分组的组数</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @param startPage 查询哪一页</pre></td></tr><tr><td data-num="12"></td><td><pre>     * @param sizePerPage 查询后每页的数据的数量</pre></td></tr><tr><td data-num="13"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="14"></td><td><pre>     */</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">getSaleDetailAndAgg</span><span class="token punctuation">(</span><span class="token class-name">String</span> dt<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                                                   <span class="token class-name">String</span> keyWords<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                                                   <span class="token class-name">String</span> aggField<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                                                   <span class="token keyword">int</span> aggCount<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                                                   <span class="token keyword">int</span> startPage<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                                                   <span class="token keyword">int</span> sizePerPage<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 1.  获取 es 的连接</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">JestClient</span> client <span class="token operator">=</span> <span class="token class-name">EsUtil</span><span class="token punctuation">.</span><span class="token function">getESClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 2. 创建查询的对象</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 2.1 获取 dsl 语句</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">String</span> dsl <span class="token operator">=</span> <span class="token class-name">EsUtil</span><span class="token punctuation">.</span><span class="token function">getDSL</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> keyWords<span class="token punctuation">,</span> aggField<span class="token punctuation">,</span> aggCount<span class="token punctuation">,</span> startPage<span class="token punctuation">,</span> sizePerPage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 2.2 创建查询的对象</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">Search</span> search <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Search<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>dsl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">"gmall_sale_detail"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">addType</span><span class="token punctuation">(</span><span class="token string">"_doc"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 3. 执行查询，并返回查询的结果，当前的结果和 kibana 中显示的数据一致，我们现在需要对数据进行转换</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 然后将转换后的数据发送给 controller。</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token class-name">SearchResult</span> searchResult <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 创建一个集合来接收最后的结果。</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 4. 解析数据</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// 4.1 解析 total 数据</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">Long</span> total <span class="token operator">=</span> searchResult<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// 将解析的数据加入到集合中</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total"</span><span class="token punctuation">,</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 4.2. 解析聚合数据</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// 4.2.1 创建一个集合来接收聚合数据</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> agg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// 4.2.1 获取聚合的数据</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TermsAggregation<span class="token punctuation">.</span>Entry</span><span class="token punctuation">></span></span> buckets <span class="token operator">=</span> searchResult</pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getTermsAggregation</span><span class="token punctuation">(</span><span class="token string">"group_by_"</span> <span class="token operator">+</span> aggField<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token comment">// 4.2.3 将数据的 key 和 value 取出，放进一个 map 集合中</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TermsAggregation<span class="token punctuation">.</span>Entry</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token class-name">Long</span> value <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            agg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 4.2.4 将获取的数据写到 result 中</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"agg"</span><span class="token punctuation">,</span>agg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// 4.3 解析订单详情数据</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token comment">// 4.3.1 创建一个集合来接收详情数据</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> detail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token comment">// 4..2 获取被击中的数据</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">,</span> <span class="token class-name">Void</span><span class="token punctuation">></span><span class="token punctuation">></span></span> hits <span class="token operator">=</span> searchResult<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token comment">// 4.2.2 遍历获取的数据</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">,</span> <span class="token class-name">Void</span><span class="token punctuation">></span></span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token class-name">HashMap</span> source <span class="token operator">=</span> hit<span class="token punctuation">.</span>source<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            detail<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 4.2.3 将订单详情数据写到 result 结果中。</span></pre></td></tr><tr><td data-num="70"></td><td><pre>       result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">,</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 将封装好的数据发送给 controller</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="22-通过controller对数据进行输出"><a class="anchor" href="#22-通过controller对数据进行输出">#</a> 2.2 通过 controller 对数据进行输出</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 分析：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       <span class="token string">'1. 获取网页访问提供的参数'</span>：</pre></td></tr><tr><td data-num="3"></td><td><pre>            通过网页post请求，输入指定的地址和提供指定的参数，那么在controller定义一个方法，只要这个方法处理的请求的路径和</pre></td></tr><tr><td data-num="4"></td><td><pre>       网页输入的地址一致，那么就能获取网页提供的参数。</pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token string">'2. 返回请求的结果'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>             根据网页请求的数据（主要是指参数），对es的数据进行处理，最后将数据返回给到用户访问的页面位置。</pre></td></tr><tr><td data-num="7"></td><td><pre>             </pre></td></tr><tr><td data-num="8"></td><td><pre>             http:<span class="token comment">//localhost:8070/sale_detail?dt=2019-05-20&amp;&amp;startPage=1&amp;&amp;size=5&amp;&amp;keyword = 手机小米</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">-- 2. 具体的实现步骤</span></pre></td></tr><tr><td data-num="10"></td><td><pre>          <span class="token number">1.</span> 获取用户从网页提供的参数</pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token number">2.</span> 对从es中获取的数据进行处理、封装、最后返回结果</pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token number">3.</span> 用户在页面就可以看到请求的数据。</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">-- 3. 需返回给用户的数据</span></pre></td></tr><tr><td data-num="14"></td><td><pre>         用户需要返回的数据如下图片所示</pre></td></tr></table></figure><p>![image-20200722202841153](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200722202904.png)</p><pre><code>
</code></pre><h2 id="十二-小知识点"><a class="anchor" href="#十二-小知识点">#</a> 十二、小知识点</h2><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//1. json 对象转换为字符串</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     <span class="token keyword">val</span> context<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span>toJSONString</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//2. json 字符串转换为样例类</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>json<span class="token punctuation">,</span>Classof<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//3. 对象转 json 字符串</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	Serialization<span class="token punctuation">.</span>write<span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">(</span>DefaultFormats<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">4.</span> option和either的用法</pre></td></tr></table></figure></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2020-08-07 17:58:18" itemprop="dateModified" datetime="2020-08-07T17:58:18+08:00">2020-08-07</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Miyazono 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Miyazono 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Miyazono 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/big-data/flink/%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/">https://github.com/Mayizono/miyazono.github.io/big-data/flink/模块总结/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/big-data/flink/7_%E5%AE%9E%E6%97%B6%E9%A2%84%E8%AD%A6/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicli3sbvtj20zk0m8x6p.jpg" title="未命名"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div><div class="item right"><a href="/big-data/spark/2.Spark%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BC%96%E7%A8%8B/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciszlczyj20zk0m816d.jpg" title="未命名"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">模块总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E5%88%B0mysql%E4%B8%AD"><span class="toc-number">1.1.</span> <span class="toc-text">一、业务数据如何到 mysql 中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-canal%E7%9B%91%E6%8E%A7mysql%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81%E5%88%B0kafka"><span class="toc-number">1.2.</span> <span class="toc-text">二、canal 监控 mysql 数据发送到 kafka</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%BE%80kafka%E4%B8%AD%E5%86%99%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.</span> <span class="toc-text">三、往 kafka 中写数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-sparkstreaming%E8%AF%BB%E5%8F%96kafka%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.</span> <span class="toc-text">四、sparkStreaming 读取 kafka 中的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">五、如何读取配置文件中的参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E5%85%AC%E5%85%B1%E7%9A%84%E4%BB%A3%E7%A0%81%E7%9A%84%E5%B0%81%E8%A3%85"><span class="toc-number">1.6.</span> <span class="toc-text">六、公共的代码的封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-sparkstreaming%E5%8F%8C%E6%B5%81join"><span class="toc-number">1.7.</span> <span class="toc-text">七、sparkstreaming 双流 join</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-sparkstreaming%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%99%E5%88%B0mysql"><span class="toc-number">1.8.</span> <span class="toc-text">八、sparkstreaming 的数据写到 mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-sparkstreaming%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%99%E5%88%B0elasticsearch"><span class="toc-number">1.9.</span> <span class="toc-text">九、sparkstreaming 的数据写到 elasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81-sparkstreaming%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%99%E5%88%B0hbase"><span class="toc-number">1.10.</span> <span class="toc-text">十、sparkstreaming 的数据写到 hbase</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-%E5%A6%82%E4%BD%95%E8%BF%9E%E6%8E%A5redis"><span class="toc-number">1.11.</span> <span class="toc-text">十一、如何连接 redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-sparkstreaming%E5%A6%82%E4%BD%95%E8%BF%9E%E6%8E%A5mysql"><span class="toc-number">1.12.</span> <span class="toc-text">十二、SparkStreaming 如何连接 mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-es%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E5%86%99%E5%88%B0%E5%89%8D%E7%AB%AF"><span class="toc-number">1.13.</span> <span class="toc-text">十二、es 中的数据如何写到前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.13.1.</span> <span class="toc-text">1. 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.13.2.</span> <span class="toc-text">2. 具体步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#21-%E7%AC%AC%E4%B8%80%E6%AD%A5%E8%8E%B7%E5%8F%96es%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF-%E8%A7%A3%E6%9E%90%E6%95%B0%E6%8D%AE-%E5%B9%B6%E5%B0%86%E6%95%B0%E6%8D%AE%E5%86%99%E7%BB%99controller"><span class="toc-number">1.13.2.1.</span> <span class="toc-text">2.1 第一步：获取 es 的客户端、解析数据、并将数据写给 controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-%E9%80%9A%E8%BF%87controller%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%BE%93%E5%87%BA"><span class="toc-number">1.13.2.2.</span> <span class="toc-text">2.2 通过 controller 对数据进行输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-%E5%B0%8F%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.14.</span> <span class="toc-text">十二、小知识点</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">25</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/amehime" title="https:&#x2F;&#x2F;github.com&#x2F;amehime" class="item github"><i class="ic i-github"></i></a> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9hbWVoaW1l" title="https:&#x2F;&#x2F;twitter.com&#x2F;amehime"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyODg2ODIz" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;12886823"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9hbWVoaW1l" title="https:&#x2F;&#x2F;about.me&#x2F;amehime"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/big-data/flink/7_%E5%AE%9E%E6%97%B6%E9%A2%84%E8%AD%A6/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/big-data/spark/2.Spark%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BC%96%E7%A8%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/4.%20Spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E2%80%94%E2%80%94%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/5.Spark%E4%B9%8BWordCount/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flink/" title="分类于 Flink">Flink</a></div><span><a href="/big-data/flink/1_Nginx/" title="负载均衡Nginx的使用">负载均衡Nginx的使用</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/hadoop/hadoop/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/2.Spark%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BC%96%E7%A8%8B/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flume/" title="分类于 Flume">Flume</a></div><span><a href="/big-data/flume/Flume%E7%BB%83%E4%B9%A0%E9%A2%98/" title="Flume练习题">Flume练习题</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/1.Spark%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/3_ElasticSearch/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/6.SparkSQL/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flink/" title="分类于 Flink">Flink</a></div><span><a href="/big-data/flink/2_Canal/" title="CDC Canal的使用">CDC Canal的使用</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">359k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:26</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"big-data/flink/模块总结/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->