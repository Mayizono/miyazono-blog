<!-- build time:Tue Sep 07 2021 18:21:09 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/big-data/spark/4.%20Spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E2%80%94%E2%80%94%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/"><title>| Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"></h1><div class="meta"><span class="item" title="创建时间：2021-08-31 18:42:35"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-31T18:42:35+08:00">2021-08-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>33k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>30 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicliierfjj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclxfdlttj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipet8c1a2j20zk0m8kct.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeyvx1d4j20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicit31ffoj20zk0m8naf.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/big-data/spark/4.%20Spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E2%80%94%E2%80%94%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><h1 id="spark实战项目电商指标统计"><a class="anchor" href="#spark实战项目电商指标统计">#</a> Spark 实战项目 —— 电商指标统计</h1><hr><h2 id="一-引言"><a class="anchor" href="#一-引言">#</a> 一、引言</h2><p>​ 在实战项目中，根据不同的需求进行编程，由于需求不同，核心的计算逻辑会不同，但是其他的一些代码，如获取环境变量、读取文件等等操作是固定。本次我们采用编写框架的模式来完成我们的需求，这样的优势有：</p><blockquote><ol><li>代码的扩展性强；</li><li>减少代码的冗余；</li><li>将相同的功能进行封装，降低代码的耦合度；</li><li>将代码进行分层次，代码的逻辑看起来就非常的清晰。</li></ol></blockquote><p>采用框架的方式，在企业实际生产环境中是非常有优势的，希望大家能够学以致用。</p><h3 id="11-框架设计原理"><a class="anchor" href="#11-框架设计原理">#</a> 1.1 框架设计原理</h3><p>​ 框架设计思想可以采取两种模式，一种是 MVC，另外一种是三层架构，由于我们这里没有页面展示的需求，所以我们暂时采取三层架构的方式。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 三层架构的概念</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  	<span class="token number">1.</span> Controller:控制层，封装调度作用，数据的流转过程</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2.</span> Service: 服务层，封装实际的计算逻辑</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token number">3.</span> DAO ：<span class="token keyword">Data</span> Access Object<span class="token punctuation">,</span>数据访问对象，专门用于和一些关系型数据互相访问，用来和数据源的连接</pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">-- 2. 调用的顺序</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   按照下面图示。</pre></td></tr><tr><td data-num="8"></td><td><pre>   </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">-- 3. 架构中一些其他的内容</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token number">1.</span> bean ： 用来封装一个bean类，对数据的一些封装，采用样例类，声明在包对象中</pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token number">2.</span> helper：辅助类，如累加器类</pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token number">3.</span> Apllication ： 应用程序，主程序</pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token number">4.</span> Util : 工具类</pre></td></tr></table></figure><p>![image-20200610231235344](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200610231235.png)</p><h3 id="12-框架搭建"><a class="anchor" href="#12-框架搭建">#</a> 1.2 框架搭建</h3><p>![image-20200610232755157](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200610232755.png)</p><h4 id="121-util"><a class="anchor" href="#121-util">#</a> 1.2.1 Util</h4><h5 id="1211-envutils"><a class="anchor" href="#1211-envutils">#</a> 1.2.1.1 EnvUtils</h5><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 如何实现三层框架共享数据呢？</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token number">1.</span> 实现原理：在当前线程中创建一个内存，将共享数据存放在这个内存中，这样三层架构均可以使用。</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">2.</span> 实现方式：</pre></td></tr><tr><td data-num="4"></td><td><pre>      a、在线程中一直就保留着可以共享数据的空间</pre></td></tr><tr><td data-num="5"></td><td><pre>      b、JDK API 提供了一个工具类，可以直接访问这个空间</pre></td></tr><tr><td data-num="6"></td><td><pre>      c、只要调用这个工具类<span class="token punctuation">(</span>ThreadLocal<span class="token punctuation">)</span>将数据存入到共享数据中，也可以从这个内存中调用共享内存中的数据</pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token number">3.</span> 具体的步骤：</pre></td></tr><tr><td data-num="8"></td><td><pre>      a、<span class="token string">"创建"</span>一个共享数据 ： 案例如下：</pre></td></tr><tr><td data-num="9"></td><td><pre>         <span class="token string">"private val scLocal = new ThreadLocal[SparkContext] "</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      b、将共享数据<span class="token string">"放进"</span>共享空间中</pre></td></tr><tr><td data-num="11"></td><td><pre>         <span class="token string">"scLocal.set(sc)"</span>    </pre></td></tr><tr><td data-num="12"></td><td><pre>      c、从当前线程的共享空间中<span class="token string">"获取"</span>共享数据</pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token string">"scLocal.get()"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      d、将共享数据从共享空间中<span class="token string">"清除"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         <span class="token string">"scLocal.remove()"</span></pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="7"></td><td><pre>  * *</pre></td></tr><tr><td data-num="8"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @create 2020-06-09 14:00:02</pre></td></tr><tr><td data-num="10"></td><td><pre>  */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">object</span> EnvUtils <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// 创建一个共享数据</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> scLocal <span class="token operator">=</span> <span class="token keyword">new</span> ThreadLocal<span class="token punctuation">[</span>SparkContext<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// 获取环境对象</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">def</span> getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 从当前线程的共享空间中获取环境对象</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">var</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> scLocal<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"SparkApplication"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      scLocal<span class="token punctuation">.</span>set<span class="token punctuation">(</span>sc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    sc</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// 清除对象</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">def</span> clean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// 将共享内存中的数据清除</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    scLocal<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="1212-propertiesutil"><a class="anchor" href="#1212-propertiesutil">#</a> 1.2.1.2 PropertiesUtil</h5><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 动态获取连接的资源，将需要连接的资源配置文件放置在配置文件中，从配置文件中读取连接需要的资源，这样，当我们需要更换连接的资源时，只要修改配置文件即可。</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>这种思想是非常重要的，类似hadoop的RM，将资源和计算分离开，做资源的调度，扩展起来就非常的方便。</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ResourceBundle</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="7"></td><td><pre>  * *</pre></td></tr><tr><td data-num="8"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @create 2020-05-23 23:37:44</pre></td></tr><tr><td data-num="10"></td><td><pre>  */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">object</span> PropertiesUtil <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// 绑定配置文件</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">val</span> summer<span class="token operator">:</span> ResourceBundle <span class="token operator">=</span> ResourceBundle<span class="token punctuation">.</span>getBundle<span class="token punctuation">(</span><span class="token string">"summers"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">def</span> getValue<span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 传入一个 key，返回一个 value</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    summer<span class="token punctuation">.</span>getString<span class="token punctuation">(</span>key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="122-core"><a class="anchor" href="#122-core">#</a> 1.2.2 core</h4><h5 id="1221-tapplication"><a class="anchor" href="#1221-tapplication">#</a> 1.2.2.1 TApplication</h5><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 主程序，是个特质，只需要传递执行的逻辑，获取环境和关闭环境自动完成</span></pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>InetAddress<span class="token punctuation">,</span> ServerSocket<span class="token punctuation">,</span> Socket<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>EnvUtils<span class="token punctuation">,</span> PropertiesUtil<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="10"></td><td><pre>  * *</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="12"></td><td><pre>  * @create 2020-05-22 19:33:39</pre></td></tr><tr><td data-num="13"></td><td><pre>  */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">trait</span> TApplication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">var</span> envdata<span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token keyword">null</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// 第一步：初始化环境</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">def</span> start<span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">(</span>op<span class="token operator">:</span> <span class="token keyword">=></span> <span class="token builtin">Unit</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">"Socket"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      envdata <span class="token operator">=</span> <span class="token keyword">new</span> Socket<span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span>getValue<span class="token punctuation">(</span><span class="token string">"serverhost"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">,</span> PropertiesUtil<span class="token punctuation">.</span>getValue<span class="token punctuation">(</span><span class="token string">"serverport"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">"ServerSocket"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      envdata <span class="token operator">=</span> <span class="token keyword">new</span> ServerSocket<span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span>getValue<span class="token punctuation">(</span><span class="token string">"serverport"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">"Spark"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      envdata <span class="token operator">=</span> EnvUtils<span class="token punctuation">.</span>getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 业务逻辑</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      op</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token keyword">case</span> ex<span class="token operator">:</span> Exception <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"op执行失败，原因是："</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span>getMessage<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 环境关闭</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">"ServerSocket"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">val</span> ServerSocket <span class="token operator">=</span> envdata<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>ServerSocket<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ServerSocket<span class="token punctuation">.</span>isClosed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        ServerSocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">"Socket"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token keyword">val</span> socket <span class="token operator">=</span> envdata<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>Socket<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socket<span class="token punctuation">.</span>isClosed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">"Spark"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>       EnvUtils<span class="token punctuation">.</span>clean<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="1222-tcontroller"><a class="anchor" href="#1222-tcontroller">#</a> 1.2.2.2 TController</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  * @Description 控制器，封装调度</pre></td></tr><tr><td data-num="5"></td><td><pre>  **</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @create 2020-06-08 21:52:39</pre></td></tr><tr><td data-num="8"></td><td><pre>  */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">trait</span> TController <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 执行控制</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">def</span> execute<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Unit</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="1223-tservice"><a class="anchor" href="#1223-tservice">#</a> 1.2.2.3 TService</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  * @Description 服务，封装逻辑</pre></td></tr><tr><td data-num="5"></td><td><pre>  **</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @create 2020-06-08 21:53:31</pre></td></tr><tr><td data-num="8"></td><td><pre>  */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">trait</span> TService <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 数据分析</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Any</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 数据分析</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data <span class="token operator">:</span><span class="token builtin">Any</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Any</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="1224-tdao"><a class="anchor" href="#1224-tdao">#</a> 1.2.2.4 TDAO</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>EnvUtils</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description 数据访问对象，专门负责和关系型数据如 mysql 之间的交互</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-06-08 21:53:56</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">trait</span> TDAO <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">def</span> readFile<span class="token punctuation">(</span>path <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> EnvUtils<span class="token punctuation">.</span>getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textFile<span class="token punctuation">(</span>path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    fileRDD</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="二-实战项目"><a class="anchor" href="#二-实战项目">#</a> 二 、 实战项目</h2><h3 id="21-项目思路"><a class="anchor" href="#21-项目思路">#</a> 2.1 项目思路</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 完成项目需求的步骤：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">1.</span> 分析原始数据的结构，包括数据的格式，数据的含义，数据之间的关系</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2.</span> 分析项目需求 <span class="token comment">-- 非常关键</span></pre></td></tr><tr><td data-num="4"></td><td><pre>       a、 数据的输入是什么</pre></td></tr><tr><td data-num="5"></td><td><pre>       b、 数据的输出是什么</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token number">3.</span> 步骤划分：</pre></td></tr><tr><td data-num="7"></td><td><pre>       a、根据原始数据的格式，朝着数据结果的输出一步一步的进行分解</pre></td></tr><tr><td data-num="8"></td><td><pre>       b、几大原则：</pre></td></tr><tr><td data-num="9"></td><td><pre>          缺什么，补什么；</pre></td></tr><tr><td data-num="10"></td><td><pre>          少什么，加什么，</pre></td></tr><tr><td data-num="11"></td><td><pre>          多什么，删什么。</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token number">4.</span> 完成比完美更重要，先完成需求，再优化</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token number">5.</span> 当出现的结果不是自己想要的时候，可以从后往前依次进行排查，排查的方式可以打印阶段计算结果，查看是否是自己想到的预期结果。 </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token number">6.</span> 一般我们会将原始数据的字段进行封装成样例类，相当于数据有了结构，同时可以封装一些方法，并可以进行模式匹配，数据也富有了含义，便于理解</pre></td></tr></table></figure><h3 id="22-原始数据"><a class="anchor" href="#22-原始数据">#</a> 2.2 原始数据</h3><p>![image-20200610235857840](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200610235857.png)</p><ul><li>数据说明</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 上面的数据图是从数据文件中截取的一部分内容，表示为电商网站的用户行为数据，主要包含用户的 4 种行为：搜索，点击，下单，支付。数据规则如下：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1.</span> 数据文件中每行数据采用<span class="token string">"下划线"</span>分隔数据</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2.</span> 每一行数据表示用户的一次行为，这个行为只能是<span class="token number">4</span>种行为的一种</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3.</span> 如果搜索关键字为<span class="token boolean">null</span><span class="token punctuation">,</span>表示数据不是搜索数据</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">4.</span> 如果点击的品类ID和产品ID为<span class="token operator">-</span><span class="token number">1</span>，表示数据不是点击数据</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">5.</span> 针对于下单行为，一次可以下单多个商品，所以品类ID和产品ID可以是多个，id之间采用逗号分隔，如果本次不是下单行为，则数据采用<span class="token boolean">null</span>表示</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">6.</span> 支付行为和下单行为类似</pre></td></tr></table></figure><ul><li>详细字段说明：</li></ul><table><thead><tr><th>编号</th><th>字段名称</th><th>字段类型</th><th>字段含义</th></tr></thead><tbody><tr><td>1</td><td>date</td><td>String</td><td>用户点击行为的日期</td></tr><tr><td>2</td><td>user_id</td><td>String</td><td>用户的 ID</td></tr><tr><td>3</td><td>session_id</td><td>String</td><td>Session 的 ID</td></tr><tr><td>4</td><td>page_id</td><td>String</td><td>某个页面的 ID</td></tr><tr><td>5</td><td>action_time</td><td>String</td><td>动作的时间点</td></tr><tr><td>6</td><td>search_keyword</td><td>String</td><td>用户搜索的关键词</td></tr><tr><td>7</td><td>click_category_id</td><td>String</td><td>某一个商品品类的 ID</td></tr><tr><td>8</td><td>click_product_id</td><td>String</td><td>某一个商品的 ID</td></tr><tr><td>9</td><td>order_category_ids</td><td>String</td><td>一次订单中所有品类的 ID 集合</td></tr><tr><td>10</td><td>order_product_ids</td><td>String</td><td>一次订单中所有商品的 ID 集合</td></tr><tr><td>11</td><td>pay_category_ids</td><td>String</td><td>一次支付中所有品类的 ID 集合</td></tr><tr><td>12</td><td>pay_product_ids</td><td>String</td><td>一次支付中所有商品的 ID 集合</td></tr><tr><td>13</td><td>city_id</td><td>String</td><td>城市 id</td></tr></tbody></table><h3 id="23-准备样例类"><a class="anchor" href="#23-准备样例类">#</a> 2.3 准备样例类</h3><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 用户访问动作表</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">case</span> <span class="token keyword">class</span> UserVisitAction<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    date<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户点击行为的日期</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    user_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户的 ID</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    session_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">//Session 的 ID</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    page_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某个页面的 ID</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    action_time<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 动作的时间点</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    search_keyword<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户搜索的关键词</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    click_category_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品品类的 ID</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    click_product_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品的 ID</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    order_category_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次订单中所有品类的 ID 集合</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    order_product_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次订单中所有商品的 ID 集合</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    pay_category_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次支付中所有品类的 ID 集合</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    pay_product_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次支付中所有商品的 ID 集合</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    city_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token comment">// 城市 id</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="24-需求1top10热门品类"><a class="anchor" href="#24-需求1top10热门品类">#</a> 2.4 需求 1：Top10 热门品类</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 需求具体说明</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1.</span> 分别统计每个品类点击的次数，下单的次数和支付的次数：</pre></td></tr><tr><td data-num="3"></td><td><pre>（品类，点击总数）（品类，下单总数）（品类，支付总数）</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2.</span> 先按照点击数排名，靠前的就排名高；如果点击数相同，再比较下单数；下单数再相同，就比较支付数。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3.</span> 取Top10</pre></td></tr></table></figure><h4 id="241-数据结构分析"><a class="anchor" href="#241-数据结构分析">#</a> 2.4.1 数据结构分析</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">--</span> 原始数据：    </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">//2019-07-27_   ==> 日期     0</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 73_          ==> 用户 ID   1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">//d79508b4-66bf-4410-a5bb-f67a8831610f_  ==> 会话 ID  2</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 45_          ==> 页面 ID   3</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 2019-07-27 19:47:55_   ==> 动作时间  4</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//null_        ==> 搜索     5</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 9_           ==> 点击品类 ID，不是则为 - 1     6</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 51_          ==> 点击产品 ID，不是则为 - 1     7</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//null_        ==> 下单品类 ID，不是则为 null   8</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//null_        ==> 下单产品 ID，不是则为 null   9</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">//null_        ==> 支付品类 ID，不是则为 null   10</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//null_        ==> 支付产品 ID ，不是则为 null  11</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 6            ==> 城市 ID，不是则为 null       12</span></pre></td></tr></table></figure><h4 id="242-数据结果分析"><a class="anchor" href="#242-数据结果分析">#</a> 2.4.2 数据结果分析</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 最后结果：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1.</span> <span class="token punctuation">(</span>品类，<span class="token punctuation">(</span>clickCount<span class="token punctuation">,</span>orderCont<span class="token punctuation">,</span>payCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2.</span>  多个品类之间，按照clickCount<span class="token punctuation">,</span>orderCont<span class="token punctuation">,</span>payCount的大小依次进行排序，然后取排名的前<span class="token number">10</span>名。</pre></td></tr></table></figure><h4 id="245-实现步骤"><a class="anchor" href="#245-实现步骤">#</a> 2.4.5 实现步骤</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 具体实现步骤</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1.</span> 数据进行切分，根据每条数据是哪种行为，将数据转换为：</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token punctuation">(</span>品类，<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> : 点击行为</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token punctuation">(</span>品类，<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> : 下单行为</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token punctuation">(</span>品类，<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> : 支付行为</pre></td></tr><tr><td data-num="6"></td><td><pre>   </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2.</span> 按照品类进行分组聚合:</pre></td></tr><tr><td data-num="8"></td><td><pre>   品类，<span class="token punctuation">(</span>clickCount<span class="token punctuation">,</span>orderCont<span class="token punctuation">,</span>payCount<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">3.</span> 排序取前<span class="token number">10</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">-- 数据来龙去脉分析清楚以后，写代码都是分分钟的事情</span></pre></td></tr></table></figure><h4 id="226-代码实现"><a class="anchor" href="#226-代码实现">#</a> 2.2.6 代码实现</h4><p>![image-20200611014414036](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611014414.png)</p><h5 id="2261-bean"><a class="anchor" href="#2261-bean">#</a> 2.2.6.1 bean</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="5"></td><td><pre>  **</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @create 2020-06-11 0:48:41</pre></td></tr><tr><td data-num="8"></td><td><pre>  */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">object</span> bean <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 用户访问动作表</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">case</span> <span class="token keyword">class</span> UserVisitAction<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                              date<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户点击行为的日期</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                              user_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户的 ID</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                              session_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">//Session 的 ID</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                              page_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某个页面的 ID</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                              action_time<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 动作的时间点</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                              search_keyword<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户搜索的关键词</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                              click_category_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品品类的 ID</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                              click_product_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品的 ID</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                              order_category_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次订单中所有品类的 ID 集合</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                              order_product_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次订单中所有商品的 ID 集合</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                              pay_category_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次支付中所有品类的 ID 集合</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                              pay_product_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次支付中所有商品的 ID 集合</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                              city_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token comment">// 城市 id</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                            <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2262-hotcategorytop10applicationreview"><a class="anchor" href="#2262-hotcategorytop10applicationreview">#</a> 2.2.6.2 HotCategoryTOP10ApplicationReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>application</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>HotCategoryTop10ControllerReview</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TApplication</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description 应用程序启动层</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-06-11 0:35:53</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">object</span> HotCategoryTOP10ApplicationReview  <span class="token keyword">extends</span> App <span class="token keyword">with</span>   TApplication<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  start<span class="token punctuation">(</span><span class="token string">"Spark"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> hotCategoryTop10ControllerReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategoryTop10ControllerReview</pre></td></tr><tr><td data-num="17"></td><td><pre>    hotCategoryTop10ControllerReview<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2263-hotcategorytop10controllerreview"><a class="anchor" href="#2263-hotcategorytop10controllerreview">#</a> 2.2.6.3 HotCategoryTop10ControllerReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>HotCategoryTop10ServiceReview</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TController</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description  控制层</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-06-11 0:36:40</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">class</span> HotCategoryTop10ControllerReview <span class="token keyword">extends</span>  TController<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategoryTop10ServiceReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategoryTop10ServiceReview</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">val</span> result<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> hotCategoryTop10ServiceReview<span class="token punctuation">.</span>analysis<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    result<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2264-hotcategorytop10daoreview"><a class="anchor" href="#2264-hotcategorytop10daoreview">#</a> 2.2.6.4 HotCategoryTop10DAOReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserVisitAction</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TDAO</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  * @Description  资源连接层</pre></td></tr><tr><td data-num="9"></td><td><pre>  * *</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @create 2020-06-11 0:38:25</pre></td></tr><tr><td data-num="12"></td><td><pre>  */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">class</span> HotCategoryTop10DAOReview <span class="token keyword">extends</span> TDAO <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">def</span> getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 读取路径下的数据</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> readFile<span class="token punctuation">(</span><span class="token string">"input/user_visit_action.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 将数据封装对象</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      data <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">val</span> datasArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        UserVisitAction<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2265-hotcategorytop10servicereview"><a class="anchor" href="#2265-hotcategorytop10servicereview">#</a> 2.2.6.5 HotCategoryTop10ServiceReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>HotCategoryTop10DAOReview</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TService</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  * @Description  计算逻辑层</pre></td></tr><tr><td data-num="12"></td><td><pre>  **</pre></td></tr><tr><td data-num="13"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="14"></td><td><pre>  * @create 2020-06-11 0:37:41</pre></td></tr><tr><td data-num="15"></td><td><pre>  */</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">class</span> HotCategoryTop10ServiceReview  <span class="token keyword">extends</span>  TService<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategoryTop10DAOReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategoryTop10DAOReview</pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 获取数据，数据已经被封装成一个一个的对象</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">val</span> UserRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> hotCategoryTop10DAOReview<span class="token punctuation">.</span>getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">//1. 数据进行切分，根据每条数据是哪种行为，将数据转换为：</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">//   (品类，(1,0,0)) : 点击行为</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">//   (品类，(0,1,0)) : 下单行为</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">//   (品类，(0,0,1)) : 支付行为</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">val</span> cagegoryToOneRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>UserBean <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>UserBean<span class="token punctuation">.</span>click_category_id <span class="token operator">!=</span> <span class="token string">"-1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        List<span class="token punctuation">(</span><span class="token punctuation">(</span>UserBean<span class="token punctuation">.</span>click_category_id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>UserBean<span class="token punctuation">.</span>order_category_ids <span class="token operator">!=</span> <span class="token string">"null"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">val</span> ids<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserBean<span class="token punctuation">.</span>order_category_ids<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>        ids<span class="token punctuation">.</span>map<span class="token punctuation">(</span>id <span class="token keyword">=></span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>UserBean<span class="token punctuation">.</span>pay_category_ids <span class="token operator">!=</span> <span class="token string">"null"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">val</span> ids<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserBean<span class="token punctuation">.</span>pay_category_ids<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        ids<span class="token punctuation">.</span>map<span class="token punctuation">(</span>id <span class="token keyword">=></span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        Nil</pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">//2. 按照品类进行分组聚合:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">//   品类，(clickCount,orderCont,payCount)</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">val</span> categorySumRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> cagegoryToOneRDD<span class="token punctuation">.</span>reduceByKey <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>click<span class="token punctuation">,</span> order<span class="token punctuation">,</span> pay<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>click1<span class="token punctuation">,</span> order1<span class="token punctuation">,</span> pay1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">(</span>click <span class="token operator">+</span> click1<span class="token punctuation">,</span> order <span class="token operator">+</span> order1<span class="token punctuation">,</span> pay <span class="token operator">+</span> pay1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">//3. 排序取前 10</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">val</span> result<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> categorySumRDD<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    result</pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>计算结果如下</li></ul><p>![](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611014759.png)</p><h4 id="227-优化使用累加器"><a class="anchor" href="#227-优化使用累加器">#</a> 2.2.7 优化：使用累加器</h4><h5 id="2271-更新bean"><a class="anchor" href="#2271-更新bean">#</a> 2.2.7.1 更新 bean</h5><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 添加新的样例类 HotCagetoryBean</span></pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="5"></td><td><pre>  **</pre></td></tr><tr><td data-num="6"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="7"></td><td><pre>  * @create 2020-06-11 0:48:41</pre></td></tr><tr><td data-num="8"></td><td><pre>  */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">object</span> bean <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 用户访问动作表</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">case</span> <span class="token keyword">class</span> HotCagetoryBean<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>                              category_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品品类的 ID</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                              <span class="token keyword">var</span> clickCount<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token comment">// 点击的次数</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                              <span class="token keyword">var</span> orderCount<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token comment">// 下单的次数</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                              <span class="token keyword">var</span> payCount<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token comment">// 支付的次数</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>                            <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// 用户访问动作表</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">case</span> <span class="token keyword">class</span> UserVisitAction<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                              date<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户点击行为的日期</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                              user_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户的 ID</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                              session_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">//Session 的 ID</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                              page_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某个页面的 ID</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                              action_time<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 动作的时间点</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                              search_keyword<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 用户搜索的关键词</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                              click_category_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品品类的 ID</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                              click_product_id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 某一个商品的 ID</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                              order_category_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次订单中所有品类的 ID 集合</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                              order_product_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次订单中所有商品的 ID 集合</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                              pay_category_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次支付中所有品类的 ID 集合</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                              pay_product_ids<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token comment">// 一次支付中所有商品的 ID 集合</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                              city_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token comment">// 城市 id</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                            <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2272-累加器-hotcategorytop10accumulatorreview"><a class="anchor" href="#2272-累加器-hotcategorytop10accumulatorreview">#</a> 2.2.7.2 累加器 ： HotCategoryTop10AccumulatorReview</h5><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 因为是统计出现的次数，然后进行累加，所以我们可以使用累加器的方式，从而减少 shuffle 的阶段。</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 累加器重点</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">1.</span> 明确编程累加器的步骤，声明类加器，注册累加器，使用累加器，获取累加器的值</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token number">2.</span> 明确<span class="token number">6</span>个重写方法的作用</pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">3.</span> 明确累加器输入的值和输出值的数据，从而必须知道输入值的类型和输出值的类型 </pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">-- 总结：</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  在写累加器的时候出现如下情况：</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token number">1.</span> 更新<span class="token keyword">add</span>方法时，数据累加出现错误，最后执行结果为<span class="token number">0</span>，发现是</pre></td></tr><tr><td data-num="11"></td><td><pre>     bean<span class="token punctuation">.</span>clickCount <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span> 写成了 bean<span class="token punctuation">.</span>clickCount <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token number">2.</span> 进行数据累加时，发现通不过，原来的是封装的HotCagetoryBean，属性均是val类型，不可变，需改为var类型</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>helper</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>HotCagetoryBean</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>AccumulatorV2</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="10"></td><td><pre>  **</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="12"></td><td><pre>  * @create 2020-06-11 1:52:29</pre></td></tr><tr><td data-num="13"></td><td><pre>  */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">class</span> HotCategoryTop10AccumulatorReview  <span class="token keyword">extends</span> AccumulatorV2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span>HotCagetoryBean<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  in: 品类，行为</pre></td></tr><tr><td data-num="18"></td><td><pre>  out: 品类，HotCagetoryBean</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategoryMap <span class="token operator">=</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span>HotCagetoryBean<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> isZero<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> hotCategoryMap<span class="token punctuation">.</span>isEmpty</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AccumulatorV2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> HotCagetoryBean<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">new</span> HotCategoryTop10AccumulatorReview</pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> hotCategoryMap<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  add 操作是在同一个 executor 中的操作，将 executor 中的所有数据一个一个进行累加，然后将累加以后的计算结果返回给</pre></td></tr><tr><td data-num="33"></td><td><pre>  Driver。</pre></td></tr><tr><td data-num="34"></td><td><pre>   */</pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> add<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">val</span> category<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>_1</pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">val</span> action<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>_2</pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 判断当前的品类在当前的集合中是否存在，如果存在，value，如果没有，则创建对应的 value</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">val</span> bean<span class="token operator">:</span> HotCagetoryBean <span class="token operator">=</span> hotCategoryMap<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>category<span class="token punctuation">,</span>HotCagetoryBean<span class="token punctuation">(</span>category<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 根据行为的不同，更新当前累加器的值</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    action <span class="token keyword">match</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">case</span> <span class="token string">"click"</span> <span class="token keyword">=></span> bean<span class="token punctuation">.</span>clickCount <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token keyword">case</span> <span class="token string">"order"</span> <span class="token keyword">=></span> bean<span class="token punctuation">.</span>orderCount <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">case</span> <span class="token string">"pay"</span>   <span class="token keyword">=></span> bean<span class="token punctuation">.</span>payCount <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token keyword">case</span> _ <span class="token keyword">=></span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">// 更新当前 cagetory 的 value 值</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    hotCategoryMap<span class="token punctuation">(</span>category<span class="token punctuation">)</span> <span class="token operator">=</span> bean</pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  merge 操作是在 driver 端完成，所有的 executor 将自己的计算结果，也就是累加器返回给 driver，那么在 driver 端</pre></td></tr><tr><td data-num="59"></td><td><pre>  就会多个累加器，此方法就是实现在 driver 将累加器进行两两合并，得到最后的结果</pre></td></tr><tr><td data-num="60"></td><td><pre>   */</pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> merge<span class="token punctuation">(</span>other<span class="token operator">:</span> AccumulatorV2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> HotCagetoryBean<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    other<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foreach<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span>category<span class="token punctuation">,</span>bean<span class="token punctuation">)</span> <span class="token keyword">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">val</span> value<span class="token operator">:</span> HotCagetoryBean <span class="token operator">=</span> hotCategoryMap<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>category<span class="token punctuation">,</span>HotCagetoryBean<span class="token punctuation">(</span>category<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>        value<span class="token punctuation">.</span>clickCount <span class="token operator">+=</span> bean<span class="token punctuation">.</span>clickCount</pre></td></tr><tr><td data-num="69"></td><td><pre>        value<span class="token punctuation">.</span>orderCount <span class="token operator">+=</span> bean<span class="token punctuation">.</span>orderCount</pre></td></tr><tr><td data-num="70"></td><td><pre>        value<span class="token punctuation">.</span>payCount <span class="token operator">+=</span> bean<span class="token punctuation">.</span>payCount</pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        hotCategoryMap<span class="token punctuation">(</span>category<span class="token punctuation">)</span> <span class="token operator">=</span> value</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  返回累加器的值</pre></td></tr><tr><td data-num="81"></td><td><pre>   */</pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> value<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> HotCagetoryBean<span class="token punctuation">]</span> <span class="token operator">=</span> hotCategoryMap</pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2273-更新hotcategorytop10servicereview"><a class="anchor" href="#2273-更新hotcategorytop10servicereview">#</a> 2.2.7.3 更新 HotCategoryTop10ServiceReview</h5><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 总结：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token number">1.</span> 在进行累加器处理时，使用了map算子，错误，应该使用foreach就行，挨个遍历数据</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>HotCagetoryBean</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>HotCategoryTop10DAOReview</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>helper<span class="token punctuation">.</span></span>HotCategoryTop10AccumulatorReview</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TService</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>EnvUtils</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="15"></td><td><pre>  **</pre></td></tr><tr><td data-num="16"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="17"></td><td><pre>  * @create 2020-06-11 0:37:41</pre></td></tr><tr><td data-num="18"></td><td><pre>  */</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">class</span> HotCategoryTop10ServiceReview  <span class="token keyword">extends</span>  TService<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategoryTop10DAOReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategoryTop10DAOReview</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 1. 获取数据</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> hotCategoryTop10DAOReview<span class="token punctuation">.</span>readFile<span class="token punctuation">(</span><span class="token string">"input/user_visit_action.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 2. 创建累加器</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">val</span> acc <span class="token operator">=</span> <span class="token keyword">new</span> HotCategoryTop10AccumulatorReview</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 3. 注册累加器</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    EnvUtils<span class="token punctuation">.</span>getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>register<span class="token punctuation">(</span>acc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>       fileRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>data <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">val</span> datas<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>datas<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"-1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        acc<span class="token punctuation">.</span>add<span class="token punctuation">(</span>datas<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"click"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>datas<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>  <span class="token operator">!=</span> <span class="token string">"null"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">val</span> ids<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span>datas<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        ids<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>id <span class="token keyword">=></span> acc<span class="token punctuation">.</span>add<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>datas<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token operator">!=</span> <span class="token string">"null"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">val</span> ids<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span>datas<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        ids<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>id <span class="token keyword">=></span> acc<span class="token punctuation">.</span>add<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">"pay"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">//3. 获取累加器的值，排序取前 10</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">val</span> HotCagetoryMap<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> HotCagetoryBean<span class="token punctuation">]</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span>value</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 4. 排序取前 10</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">val</span> reslut<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> HotCagetoryMap<span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span>category<span class="token punctuation">,</span> bean<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token punctuation">(</span>category<span class="token punctuation">,</span> <span class="token punctuation">(</span>bean<span class="token punctuation">.</span>clickCount<span class="token punctuation">,</span> bean<span class="token punctuation">.</span>orderCount<span class="token punctuation">,</span> bean<span class="token punctuation">.</span>payCount<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">.</span>Tuple3<span class="token punctuation">(</span>Ordering<span class="token punctuation">.</span><span class="token builtin">Long</span><span class="token punctuation">.</span>reverse<span class="token punctuation">,</span> Ordering<span class="token punctuation">.</span><span class="token builtin">Long</span><span class="token punctuation">.</span>reverse<span class="token punctuation">,</span> Ordering<span class="token punctuation">.</span><span class="token builtin">Long</span><span class="token punctuation">.</span>reverse<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    reslut</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2274-其余结构不变"><a class="anchor" href="#2274-其余结构不变">#</a> 2.2.7.4 其余结构不变</h5><h5 id="2275-运行结果"><a class="anchor" href="#2275-运行结果">#</a> 2.2.7.5 运行结果</h5><p>![image-20200611094610570](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611094610.png)</p><h4 id="228-需求1总结"><a class="anchor" href="#228-需求1总结">#</a> 2.2.8 需求 1 总结</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 总结：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>在写累加器的时候出现如下情况：</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">1.</span> 在进行累加器处理时，使用了map算子，错误，应该使用foreach就行，挨个遍历数据</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">2.</span> 更新<span class="token keyword">add</span>方法时，数据累加出现错误，最后执行结果为<span class="token number">0</span>，发现是</pre></td></tr><tr><td data-num="5"></td><td><pre>     bean<span class="token punctuation">.</span>clickCount <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span> 写成了 bean<span class="token punctuation">.</span>clickCount <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">3.</span> 进行数据累加时，发现通不过，原来的是封装的HotCagetoryBean，属性均是val类型，不可变，需改为var类型</pre></td></tr></table></figure><h3 id="25-需求2top10热门品类中每个品类的top10活跃点击session统计"><a class="anchor" href="#25-需求2top10热门品类中每个品类的top10活跃点击session统计">#</a> 2.5 需求 2：Top10 热门品类中每个品类的 Top10 活跃点击 Session 统计</h3><h4 id="251-数据结构"><a class="anchor" href="#251-数据结构">#</a> 2.5.1 数据结构</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 需求 1 的计算结果</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6120</span><span class="token punctuation">,</span><span class="token number">1672</span><span class="token punctuation">,</span><span class="token number">1259</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6119</span><span class="token punctuation">,</span><span class="token number">1767</span><span class="token punctuation">,</span><span class="token number">1196</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6098</span><span class="token punctuation">,</span><span class="token number">1776</span><span class="token punctuation">,</span><span class="token number">1244</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6095</span><span class="token punctuation">,</span><span class="token number">1740</span><span class="token punctuation">,</span><span class="token number">1218</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6093</span><span class="token punctuation">,</span><span class="token number">1781</span><span class="token punctuation">,</span><span class="token number">1202</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6079</span><span class="token punctuation">,</span><span class="token number">1752</span><span class="token punctuation">,</span><span class="token number">1231</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6074</span><span class="token punctuation">,</span><span class="token number">1796</span><span class="token punctuation">,</span><span class="token number">1252</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6045</span><span class="token punctuation">,</span><span class="token number">1736</span><span class="token punctuation">,</span><span class="token number">1230</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6044</span><span class="token punctuation">,</span><span class="token number">1722</span><span class="token punctuation">,</span><span class="token number">1158</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6036</span><span class="token punctuation">,</span><span class="token number">1781</span><span class="token punctuation">,</span><span class="token number">1161</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="252-数据结果分析"><a class="anchor" href="#252-数据结果分析">#</a> 2.5.2 数据结果分析</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> 统计上面<span class="token number">10</span>个品类中，每个品类，按照<span class="token keyword">session</span>进行分组，按照统计次数从大到小进行排序，然后取出前<span class="token number">10</span>的<span class="token keyword">session</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span> 说明，同一个<span class="token keyword">session</span>中会执行多个操作，比如点击、下单、支付等操作，那么就说明在一个<span class="token keyword">session</span>中，一个品类会出现多次。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span> 希望得到的结果：</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token punctuation">(</span>品类，Iterator<span class="token punctuation">(</span><span class="token punctuation">(</span>session1<span class="token punctuation">,</span>count1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>session2<span class="token punctuation">,</span>count2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="253-实现步骤"><a class="anchor" href="#253-实现步骤">#</a> 2.5.3 实现步骤</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> 获取需求<span class="token number">1</span>结果的top10的品类</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span> 过滤数据，</pre></td></tr><tr><td data-num="3"></td><td><pre>   a、首先过滤不是点击的数据</pre></td></tr><tr><td data-num="4"></td><td><pre>   b、过滤点击数据中，品类不在top10品类中的数据</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3.</span> 进行数据结构转换，将数据转换成:</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token string">"(品类-session，1)"</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">4.</span> 分组聚合</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token string">"(品类-session，count)"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">5.</span> 结构转换</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token string">"(品类, (session，count))"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">6.</span> 按照品类分组</pre></td></tr><tr><td data-num="12"></td><td><pre>     <span class="token string">"(品类，Iterator((session1,count1),(session2,count2)....))"</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">7.</span> 结构转换，对<span class="token keyword">value</span>进行排序，然后取<span class="token keyword">value</span>排名的前<span class="token number">10</span></pre></td></tr></table></figure><h4 id="254-代码实现"><a class="anchor" href="#254-代码实现">#</a> 2.5.4 代码实现</h4><h5 id="2541-hotcategorysessiontop10applicationreview"><a class="anchor" href="#2541-hotcategorysessiontop10applicationreview">#</a> 2.5.4.1 HotCategorySessionTOP10ApplicationReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>application</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>HotCategorySessionop10ControllerReview</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TApplication</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-06-11 0:35:53</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">object</span> HotCategorySessionTOP10ApplicationReview  <span class="token keyword">extends</span> App <span class="token keyword">with</span>  TApplication<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  start<span class="token punctuation">(</span><span class="token string">"Spark"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> hotCategorySessionop10ControllerReview <span class="token operator">=</span> <span class="token keyword">new</span>  HotCategorySessionop10ControllerReview</pre></td></tr><tr><td data-num="17"></td><td><pre>    hotCategorySessionop10ControllerReview<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2542-hotcategorysessionop10controllerreview"><a class="anchor" href="#2542-hotcategorysessionop10controllerreview">#</a> 2.5.4.2 HotCategorySessionop10ControllerReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>HotCategorySessionTop10ServiceReview<span class="token punctuation">,</span> HotCategoryTop10ServiceReview<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TController</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="9"></td><td><pre>  * *</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @create 2020-06-11 0:36:40</pre></td></tr><tr><td data-num="12"></td><td><pre>  */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">class</span> HotCategorySessionop10ControllerReview <span class="token keyword">extends</span> TController <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategorySessionTop10ServiceReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategorySessionTop10ServiceReview</pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategoryTop10ServiceReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategoryTop10ServiceReview</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">val</span> data<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> hotCategoryTop10ServiceReview<span class="token punctuation">.</span>analysis<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">val</span> result<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> hotCategorySessionTop10ServiceReview<span class="token punctuation">.</span>analysis<span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    result<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2543-hotcategorysessiontop10daoreview"><a class="anchor" href="#2543-hotcategorysessiontop10daoreview">#</a> 2.5.4.3 HotCategorySessionTop10DAOReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserVisitAction</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TDAO</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="9"></td><td><pre>  * *</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @create 2020-06-11 0:38:25</pre></td></tr><tr><td data-num="12"></td><td><pre>  */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">class</span> HotCategorySessionTop10DAOReview <span class="token keyword">extends</span> TDAO <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">def</span> getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 读取路径下的数据</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> readFile<span class="token punctuation">(</span><span class="token string">"input/user_visit_action.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 将数据封装对象</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      data <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">val</span> datasArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        UserVisitAction<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2544-hotcategorysessiontop10servicereview"><a class="anchor" href="#2544-hotcategorysessiontop10servicereview">#</a> 2.5.4.4 HotCategorySessionTop10ServiceReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token punctuation">&#123;</span>HotCategorySessionTop10DAOReview<span class="token punctuation">,</span> HotCategoryTop10DAOReview<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TService</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="11"></td><td><pre>  **</pre></td></tr><tr><td data-num="12"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="13"></td><td><pre>  * @create 2020-06-11 0:37:41</pre></td></tr><tr><td data-num="14"></td><td><pre>  */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">class</span> HotCategorySessionTop10ServiceReview  <span class="token keyword">extends</span>  TService<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> hotCategorySessionTop10DAOReview <span class="token operator">=</span> <span class="token keyword">new</span> HotCategorySessionTop10DAOReview</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 获取将数据封装成对象的数据</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">val</span> UserRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> hotCategorySessionTop10DAOReview<span class="token punctuation">.</span>getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">//    1. 获取需求 1 结果的 top10 的品类</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">val</span> datas<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">val</span> categoryList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> datas<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">//      2. 过滤数据</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">//   a、首先过滤不是点击的数据</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">//   b、过滤点击数据中，品类不在 top10 品类中的数据</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">val</span> clickSession<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Userbean <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>      Userbean<span class="token punctuation">.</span>click_category_id <span class="token operator">!=</span> <span class="token string">"-1"</span> <span class="token operator">&amp;&amp;</span> categoryList<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>Userbean<span class="token punctuation">.</span>click_category_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//    3. 进行数据结构转换，将数据转换成:</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">//      "(品类 & amp;session，1)"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> clickSession<span class="token punctuation">.</span>map<span class="token punctuation">(</span>Userbean <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">(</span>Userbean<span class="token punctuation">.</span>click_category_id <span class="token operator">+</span> <span class="token string">"&amp;"</span> <span class="token operator">+</span> Userbean<span class="token punctuation">.</span>session_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">//    4. 分组聚合</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">//      "(品类 & amp;session，count)"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">val</span> reduceRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">//    5. 结构转换</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">//      "(品类，(session，count))"</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">val</span> mapRDD1<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> reduceRDD<span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">val</span> array<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">//    6. 按照品类分组</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">//      "(品类，Iterator ((session1,count1),(session2,count2)....))"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">val</span> groupByRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD1<span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">//    7. 结构转换，对 value 进行排序，然后取 value 排名的前 10</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> groupByRDD<span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>iter <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      iter<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">.</span><span class="token builtin">Int</span><span class="token punctuation">.</span>reverse<span class="token punctuation">)</span><span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    resultRDD</pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2545-运行结果"><a class="anchor" href="#2545-运行结果">#</a> 2.5.4.5 运行结果</h5><p>![image-20200611103715005](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611103715.png)</p><h4 id="255-优化使用广播变量"><a class="anchor" href="#255-优化使用广播变量">#</a> 2.5.5 优化：使用广播变量</h4><blockquote><p>仅修改一下 HotCategorySessionTop10ServiceReview 代码即可</p></blockquote><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 广播变量</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> broadCast<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> EnvUtils<span class="token punctuation">.</span>getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>categoryList<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//      2. 过滤数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//   a、首先过滤不是点击的数据</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//   b、过滤点击数据中，品类不在 top10 品类中的数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">val</span> clickSession<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Userbean <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">// 获取广播变量的值</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      Userbean<span class="token punctuation">.</span>click_category_id <span class="token operator">!=</span> <span class="token string">"-1"</span> <span class="token operator">&amp;&amp;</span> broadCast<span class="token punctuation">.</span>value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>Userbean<span class="token punctuation">.</span>click_category_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="256-需求2总结"><a class="anchor" href="#256-需求2总结">#</a> 2.5.6 需求 2 总结</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 在进行数据组合时，分割符和原始数据的分隔符一致，导致后面进行数据切分时，数据产生了丢失。</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  开始是：<span class="token string">"(品类-session，count)"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  修正后：<span class="token string">"(品类&amp;session，count)"</span></pre></td></tr></table></figure><h3 id="26-需求3页面单跳转换率统计"><a class="anchor" href="#26-需求3页面单跳转换率统计">#</a> 2.6 需求 3：页面单跳转换率统计</h3><h4 id="261-数据结构"><a class="anchor" href="#261-数据结构">#</a> 2.6.1 数据结构</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">--</span> 原始数据：    </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">//2019-07-27_   ==> 日期     0</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 73_          ==> 用户 ID   1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">//d79508b4-66bf-4410-a5bb-f67a8831610f_  ==> 会话 ID  2</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 45_          ==> 页面 ID   3</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 2019-07-27 19:47:55_   ==> 动作时间  4</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//null_        ==> 搜索     5</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 9_           ==> 点击品类 ID，不是则为 - 1     6</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 51_          ==> 点击产品 ID，不是则为 - 1     7</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//null_        ==> 下单品类 ID，不是则为 null   8</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//null_        ==> 下单产品 ID，不是则为 null   9</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">//null_        ==> 支付品类 ID，不是则为 null   10</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//null_        ==> 支付产品 ID ，不是则为 null  11</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 6            ==> 城市 ID，不是则为 null       12</span></pre></td></tr></table></figure><h4 id="262-数据结果分析"><a class="anchor" href="#262-数据结果分析">#</a> 2.6.2 数据结果分析</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 需求分析</span></pre></td></tr><tr><td data-num="2"></td><td><pre> 什么是页面单跳转换率?</pre></td></tr><tr><td data-num="3"></td><td><pre> a、在一次会话中，用户会多次且反复执行搜索、点击、下单、支付等操作</pre></td></tr><tr><td data-num="4"></td><td><pre> b、在一次会话中，执行的操作是按照时间依次进行</pre></td></tr><tr><td data-num="5"></td><td><pre> c、转换率就是：假如A页面一共被访问n次，从A页面直接跳转B页面的次数为m次，那么A到B页面的转换率pageFlowRate<span class="token operator">=</span>n<span class="token operator">/</span>m</pre></td></tr><tr><td data-num="6"></td><td><pre> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">-- 希望得到的结果是：</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"id1-id2"</span><span class="token punctuation">,</span>pageFlowRate<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"id1-id3"</span><span class="token punctuation">,</span>pageFlowRate<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><h4 id="263-实现步骤"><a class="anchor" href="#263-实现步骤">#</a> 2.6.3 实现步骤</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> 根据需求可知，页面转换率是指在同一次会话中才有效</pre></td></tr><tr><td data-num="2"></td><td><pre>   统计每个页面id出现的次数</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2.</span> 按照<span class="token keyword">session</span>进行分组，</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token punctuation">(</span><span class="token keyword">session</span><span class="token punctuation">,</span>List<span class="token punctuation">(</span>bean1<span class="token punctuation">,</span>bean2<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3.</span> 对<span class="token keyword">value</span>值进行结构转换</pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">3.1</span> 按照时间进行升序排序</pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token number">3.2</span> 对数据进行转换</pre></td></tr><tr><td data-num="8"></td><td><pre>       <span class="token punctuation">(</span>页面id1<span class="token punctuation">,</span>页面id2<span class="token punctuation">,</span>页面id3<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>）</pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token number">3.3</span> 对数据进行关联</pre></td></tr><tr><td data-num="10"></td><td><pre>       <span class="token punctuation">(</span><span class="token punctuation">(</span>id1<span class="token operator">-</span>id2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id2<span class="token operator">-</span>id3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">4.</span> 对<span class="token number">3</span>的结果数据进行数据转换，将<span class="token keyword">key</span>去掉，只保留<span class="token keyword">value</span>，并进行扁平化</pre></td></tr><tr><td data-num="12"></td><td><pre>     <span class="token punctuation">(</span><span class="token punctuation">(</span>id1<span class="token operator">-</span>id2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id2<span class="token operator">-</span>id3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">5.</span> 按照<span class="token keyword">key</span>进行分组聚合</pre></td></tr><tr><td data-num="14"></td><td><pre>     <span class="token punctuation">(</span><span class="token punctuation">(</span>id1<span class="token operator">-</span>id2<span class="token punctuation">)</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     <span class="token punctuation">(</span><span class="token punctuation">(</span>id2<span class="token operator">-</span>id3<span class="token punctuation">)</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">6.</span> 获取转换率</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">(</span><span class="token punctuation">(</span>id1<span class="token operator">-</span>id2<span class="token punctuation">)</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     <span class="token number">6.1</span> 获取id1被访问的总次数</pre></td></tr><tr><td data-num="19"></td><td><pre>     <span class="token number">6.2</span> 使用count<span class="token operator">/</span>总次数就是转换率</pre></td></tr></table></figure><h4 id="264-代码实现"><a class="anchor" href="#264-代码实现">#</a> 2.6.4 代码实现</h4><h5 id="2641-pageflowapplicationreview"><a class="anchor" href="#2641-pageflowapplicationreview">#</a> 2.6.4.1 PageFlowApplicationReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>application</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>PageFlowControllerReview</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TApplication</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="8"></td><td><pre>  **</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-06-11 0:35:53</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">object</span> PageFlowApplicationReview  <span class="token keyword">extends</span> App <span class="token keyword">with</span>   TApplication<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  start<span class="token punctuation">(</span><span class="token string">"Spark"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> pageFlowControllerReview <span class="token operator">=</span> <span class="token keyword">new</span> PageFlowControllerReview</pre></td></tr><tr><td data-num="17"></td><td><pre>    pageFlowControllerReview<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2642-pageflowcontrollerreview"><a class="anchor" href="#2642-pageflowcontrollerreview">#</a> 2.6.4.2 PageFlowControllerReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>PageFlowServiceReview</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TController</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="8"></td><td><pre>  * *</pre></td></tr><tr><td data-num="9"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @create 2020-06-11 0:36:40</pre></td></tr><tr><td data-num="11"></td><td><pre>  */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">class</span> PageFlowControllerReview <span class="token keyword">extends</span> TController <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> pageFlowServiceReview <span class="token operator">=</span> <span class="token keyword">new</span> PageFlowServiceReview</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    pageFlowServiceReview<span class="token punctuation">.</span>analysis<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">//    result.foreach(println)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2643-pageflowdaoreview"><a class="anchor" href="#2643-pageflowdaoreview">#</a> 2.6.4.3 PageFlowDAOReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserVisitAction</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TDAO</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="9"></td><td><pre>  * *</pre></td></tr><tr><td data-num="10"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="11"></td><td><pre>  * @create 2020-06-11 0:38:25</pre></td></tr><tr><td data-num="12"></td><td><pre>  */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">class</span> PageFlowDAOReview <span class="token keyword">extends</span> TDAO <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">def</span> getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 读取路径下的数据</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> readFile<span class="token punctuation">(</span><span class="token string">"input/user_visit_action.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 将数据封装对象</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      data <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">val</span> datasArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        UserVisitAction<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          datasArray<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2644-pageflowservicereview"><a class="anchor" href="#2644-pageflowservicereview">#</a> 2.6.4.4 PageFlowServiceReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>PageFlowDAOReview</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TService</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="11"></td><td><pre>  **</pre></td></tr><tr><td data-num="12"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="13"></td><td><pre>  * @create 2020-06-11 0:37:41</pre></td></tr><tr><td data-num="14"></td><td><pre>  */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">class</span> PageFlowServiceReview  <span class="token keyword">extends</span>  TService<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> pageFlowDAOReview <span class="token operator">=</span> <span class="token keyword">new</span> PageFlowDAOReview</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">//    1. 根据需求可知，页面转换率是指在同一次会话中才有效</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//    统计每个页面 id 出现的次数</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">val</span> UserRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> pageFlowDAOReview<span class="token punctuation">.</span>getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    UserRDD<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">val</span> pageIDCount<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>page_id<span class="token punctuation">)</span><span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>_<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">//    2. 按照 session 进行分组，</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">//    (session,List(bean1,bean2,...))</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">val</span> groupByRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>session_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">//    3. 对 value 值进行结构转换</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">val</span> pageIDSToOneRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> groupByRDD<span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>iter <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token comment">//   3.1 按照时间进行升序排序</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token keyword">val</span> sortByList<span class="token operator">:</span> List<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> iter<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>action_time<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token comment">//   3.2 对数据进行转换</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token comment">//      (页面 id1, 页面 id2, 页面 id3...）</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">val</span> pageIdList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortByList<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>page_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token comment">//  3.3 对数据进行关联</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token comment">//      ((id1-id2),1),((id2-id3),1)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">val</span> zipPageIDList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pageIdList<span class="token punctuation">.</span>zip<span class="token punctuation">(</span>pageIdList<span class="token punctuation">.</span>tail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token keyword">val</span> mapPageIdList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> zipPageIDList<span class="token punctuation">.</span>map<span class="token punctuation">(</span>tuple <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">(</span>tuple<span class="token punctuation">.</span>_1 <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> tuple<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>     mapPageIdList</pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">//    4. 对 3 的结果数据进行数据转换，将 key 去掉，只保留 value，并进行扁平化</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">//    ((id1-id2),1),((id2-id3),1)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">val</span> flatMapRD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pageIDSToOneRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>iter <span class="token keyword">=></span> iter<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    println<span class="token punctuation">(</span>flatMapRD<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">//    5. 按照 key 进行分组聚合</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">//      ((id1-id2),count)</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">//    ((id2-id3),count)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">val</span> pageFlowCountRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatMapRD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">//    6. 获取转换率</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    pageFlowCountRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token keyword">case</span><span class="token punctuation">(</span>ids<span class="token punctuation">,</span>count<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token comment">//      ((id1-id2),count)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token comment">//    6.1 获取 id1 被访问的总次数</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">val</span> idArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ids<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> pageIDCount<span class="token punctuation">.</span>toMap<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>idArray<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token comment">//    6.2 使用 count / 总次数就是转换率</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        println<span class="token punctuation">(</span><span class="token string">"页面id：【"</span> <span class="token operator">+</span> ids <span class="token operator">+</span> <span class="token string">"】的转换率为："</span> <span class="token operator">+</span> count<span class="token punctuation">.</span>toDouble<span class="token operator">/</span>sum <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2645-运行结果"><a class="anchor" href="#2645-运行结果">#</a> 2.6.4.5 运行结果</h5><p>![image-20200611115202176](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611115202.png)</p><h4 id="264-指定页面转换率"><a class="anchor" href="#264-指定页面转换率">#</a> 2.6.4 指定页面转换率</h4><blockquote><p>在实际开发情况中，我们只需要一些指定的页面流转率。</p></blockquote><p>![image-20200611115320274](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611115320.png)</p><h5 id="2641-修改pageflowservicereview"><a class="anchor" href="#2641-修改pageflowservicereview">#</a> 2.6.4.1 修改 PageFlowServiceReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>PageFlowDAOReview</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TService</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>EnvUtils</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="13"></td><td><pre>  **</pre></td></tr><tr><td data-num="14"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="15"></td><td><pre>  * @create 2020-06-11 0:37:41</pre></td></tr><tr><td data-num="16"></td><td><pre>  */</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">class</span> PageFlowServiceReview  <span class="token keyword">extends</span>  TService<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> pageFlowDAOReview <span class="token operator">=</span> <span class="token keyword">new</span> PageFlowDAOReview</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">//    1. 根据需求可知，页面转换率是指在同一次会话中才有效</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 1.1 指定的页面 id,(1-2,2-3,3-4...,6-7)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>     <span class="token keyword">val</span> pageid <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">val</span> pageFlowIDs<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> pageid<span class="token punctuation">.</span>zip<span class="token punctuation">(</span>pageid<span class="token punctuation">.</span>tail<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>tuple <span class="token keyword">=></span> tuple<span class="token punctuation">.</span>_1 <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> tuple<span class="token punctuation">.</span>_2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">val</span> broadCast<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> EnvUtils<span class="token punctuation">.</span>getEnv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>pageFlowIDs<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">//  1.2 先过滤掉不需要统计的页面 id，统计剩余页面 id 出现的次数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">val</span> UserRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> pageFlowDAOReview<span class="token punctuation">.</span>getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    UserRDD<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">val</span> pageIDCount<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD</pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>bean<span class="token keyword">=></span>pageid<span class="token punctuation">.</span>init<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>bean<span class="token punctuation">.</span>page_id<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>page_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>_<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      collect<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">//    2. 按照 session 进行分组，</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">//    (session,List(bean1,bean2,...))</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">val</span> groupByRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserRDD<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>session_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">//    3. 对 value 值进行结构转换</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">val</span> pageIDSToOneRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> groupByRDD<span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>iter <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token comment">//   3.1 按照时间进行升序排序</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">val</span> sortByList<span class="token operator">:</span> List<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> iter<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>action_time<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token comment">//   3.2 对数据进行转换</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token comment">//      (页面 id1, 页面 id2, 页面 id3...）</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token keyword">val</span> pageIdList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortByList<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>page_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token comment">//  3.3 对数据进行关联</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token comment">//      ((id1-id2),1),((id2-id3),1)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token keyword">val</span> zipPageIDList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pageIdList<span class="token punctuation">.</span>zip<span class="token punctuation">(</span>pageIdList<span class="token punctuation">.</span>tail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token keyword">val</span> mapPageIdList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> zipPageIDList<span class="token punctuation">.</span>map<span class="token punctuation">(</span>tuple <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">(</span>tuple<span class="token punctuation">.</span>_1 <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> tuple<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token comment">// 3.4 过滤掉不需要统计的页面流转</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token keyword">val</span> filtPageIDList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapPageIdList<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>tuple <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        broadCast<span class="token punctuation">.</span>value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>tuple<span class="token punctuation">.</span>_1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      filtPageIDList</pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment">//    4. 对 3 的结果数据进行数据转换，将 key 去掉，只保留 value，并进行扁平化</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">//    ((id1-id2),1),((id2-id3),1)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">val</span> flatMapRD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pageIDSToOneRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>iter <span class="token keyword">=></span> iter<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">//    5. 按照 key 进行分组聚合</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment">//      ((id1-id2),count)</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">//    ((id2-id3),count)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">val</span> pageFlowCountRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatMapRD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">//    6. 获取转换率</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    pageFlowCountRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>      <span class="token keyword">case</span><span class="token punctuation">(</span>ids<span class="token punctuation">,</span>count<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token comment">//      ((id1-id2),count)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">//    6.1 获取 id1 被访问的总次数</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">val</span> idArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ids<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> pageIDCount<span class="token punctuation">.</span>toMap<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>idArray<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token comment">//    6.2 使用 count / 总次数就是转换率</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        println<span class="token punctuation">(</span><span class="token string">"页面id：【"</span> <span class="token operator">+</span> ids <span class="token operator">+</span> <span class="token string">"】的转换率为："</span> <span class="token operator">+</span> count<span class="token punctuation">.</span>toDouble<span class="token operator">/</span>sum <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2642-运行结果"><a class="anchor" href="#2642-运行结果">#</a> 2.6.4.2 运行结果</h5><p>![image-20200611120819130](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611120819.png)</p><h4 id="265-需求3总结"><a class="anchor" href="#265-需求3总结">#</a> 2.6.5 需求 3 总结</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 计算转换率的时候算子使用错误，使用 map 没有结果，后来更换成 foreach 就可以了。</span></pre></td></tr></table></figure><h3 id="27-需求4-统计页面id的平均停留时间"><a class="anchor" href="#27-需求4-统计页面id的平均停留时间">#</a> 2.7 需求 4 ：统计页面 id 的平均停留时间</h3><h4 id="271-数据结构"><a class="anchor" href="#271-数据结构">#</a> 2.7.1 数据结构</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">--</span> 原始数据：    </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">//2019-07-27_   ==> 日期     0</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 73_          ==> 用户 ID   1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">//d79508b4-66bf-4410-a5bb-f67a8831610f_  ==> 会话 ID  2</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 45_          ==> 页面 ID   3</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 2019-07-27 19:47:55_   ==> 动作时间  4</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//null_        ==> 搜索     5</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 9_           ==> 点击品类 ID，不是则为 - 1     6</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 51_          ==> 点击产品 ID，不是则为 - 1     7</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//null_        ==> 下单品类 ID，不是则为 null   8</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//null_        ==> 下单产品 ID，不是则为 null   9</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">//null_        ==> 支付品类 ID，不是则为 null   10</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//null_        ==> 支付产品 ID ，不是则为 null  11</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 6            ==> 城市 ID，不是则为 null       12</span></pre></td></tr></table></figure><h4 id="272-需求结果分析"><a class="anchor" href="#272-需求结果分析">#</a> 2.7.2 需求结果分析</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 需求分析：</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token number">1.</span> 单页面id的平均停留时间，是以一个<span class="token keyword">session</span>会话为单位，计算在一个<span class="token keyword">session</span>中页面A停留时间，然后将所有会话中页面A的停留时间汇总，除于这个页面id出现的次数，就是平均停留时间。</pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token number">2.</span> 但是在一个会话的最后一个页面id只有行为时间，没有停留时间，则最后一个页面id的停留时间则忽略不计</pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token number">3.</span> 统计个数时，最后一个id也不计数</pre></td></tr></table></figure><h4 id="273-实现步骤"><a class="anchor" href="#273-实现步骤">#</a> 2.7.3 实现步骤</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> 按<span class="token keyword">session</span>进行分组</pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token punctuation">(</span><span class="token keyword">session</span><span class="token punctuation">,</span>Iterator<span class="token punctuation">(</span>bean1<span class="token punctuation">,</span>bean2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2.</span> 对分组的<span class="token keyword">value</span>进行操作</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">2.1</span> 根据时间升序排序，再进行结构转换</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token punctuation">(</span>pageid1，time1<span class="token punctuation">)</span>，<span class="token punctuation">(</span>pageid2，time2<span class="token punctuation">)</span>，<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">2.2</span> 拉链数据</pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">(</span><span class="token punctuation">(</span>pageid1，time1<span class="token punctuation">)</span>，<span class="token punctuation">(</span>pageid2，time2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span>pageid2，time2<span class="token punctuation">)</span>，<span class="token punctuation">(</span>pageid3，time3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token number">2.3</span> 结构转换</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">(</span>pageid1，time2<span class="token operator">-</span>time1<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span>pageid2，time3 <span class="token operator">-</span> time2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">3.</span> 对<span class="token number">2</span>的结果数据，结构转换</pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token punctuation">(</span><span class="token keyword">session</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>pageid1，time2<span class="token operator">-</span>time1<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span>pageid2，time3 <span class="token operator">-</span> time2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token operator">=</span><span class="token operator">=</span><span class="token operator">></span>  <span class="token punctuation">(</span>pageid1，time2<span class="token operator">-</span>time1<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span>pageid2，time3 <span class="token operator">-</span> time2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">4.</span> 分组</pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">(</span>pageid1，Iterator<span class="token punctuation">(</span>time2<span class="token operator">-</span>time1<span class="token punctuation">,</span>time2<span class="token operator">-</span>time1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">5.</span> 结构转换</pre></td></tr><tr><td data-num="16"></td><td><pre>     <span class="token punctuation">(</span>pageid1，<span class="token punctuation">(</span>timeSum<span class="token operator">/</span>Count<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="274-代码实现"><a class="anchor" href="#274-代码实现">#</a> 2.7.4 代码实现</h4><blockquote><p>说明：在需求 3 的基础上，修改 PageFlowServiceReview 代码逻辑即可，其余代码不需要做任何的改动</p></blockquote><h5 id="2741-修改pageflowservicereview"><a class="anchor" href="#2741-修改pageflowservicereview">#</a> 2.7.4.1 修改 PageFlowServiceReview</h5><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>service</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>bean</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>core<span class="token punctuation">.</span>hotcategorytop10review<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>PageFlowDAOReview</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>TService</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>summer<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>EnvUtils</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  * @Description</pre></td></tr><tr><td data-num="15"></td><td><pre>  **</pre></td></tr><tr><td data-num="16"></td><td><pre>  * @author lianzhipeng</pre></td></tr><tr><td data-num="17"></td><td><pre>  * @create 2020-06-11 0:37:41</pre></td></tr><tr><td data-num="18"></td><td><pre>  */</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">class</span> PageFlowServiceReview  <span class="token keyword">extends</span>  TService<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">val</span> pageFlowDAOReview <span class="token operator">=</span> <span class="token keyword">new</span> PageFlowDAOReview</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">val</span> UserActionRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span> <span class="token operator">=</span> pageFlowDAOReview<span class="token punctuation">.</span>getUserVisitAction<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token comment">// 1. 按 session 进行分组 (session,Iterator (bean1,bean2...))</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">val</span> groupByRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>bean<span class="token punctuation">.</span>UserVisitAction<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserActionRDD<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>session_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>     <span class="token comment">// 2. 对分组的 value 进行操作</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">val</span> sessionPageIdRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> groupByRDD<span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>iter <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token comment">//  2.1 结构转换，根据时间进行升序排序 (pageid1，time1)，(pageid2，time2)，.....</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">val</span> dataFormat <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">val</span> sortByList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>action <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">val</span> action_time<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> action<span class="token punctuation">.</span>action_time</pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">val</span> time<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> dataFormat<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>action_time<span class="token punctuation">)</span><span class="token punctuation">.</span>getTime</pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">(</span>action<span class="token punctuation">.</span>page_id<span class="token punctuation">,</span> time<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token comment">// 2.2 拉链数据  ((pageid1，time1)，(pageid2，time2)),  ((pageid2，time2)，(pageid3，time3))...</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">val</span> zipList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortByList<span class="token punctuation">.</span>zip<span class="token punctuation">(</span>sortByList<span class="token punctuation">.</span>tail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token comment">// 2.3 结构转换  (pageid1，time2-time1),  (pageid2，time3 - time2), ...</span></pre></td></tr><tr><td data-num="46"></td><td><pre>     <span class="token keyword">val</span> zipMapList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> zipList<span class="token punctuation">.</span>map <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>id1<span class="token punctuation">,</span> time1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>id2<span class="token punctuation">,</span> time2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token punctuation">(</span>id1<span class="token punctuation">,</span> time2 <span class="token operator">-</span> time1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>      zipMapList</pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">//3. 对 2 的结果数据，结构转换</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">//(session, (pageid1，time2-time1),  (pageid2，time3 - time2), ...)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">// ==>  (pageid1，time2-time1),  (pageid2，time3 - time2), ...</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">val</span> pageIdTimeRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sessionPageIdRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>iter<span class="token keyword">=></span>iter<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 4. 分组  (pageid1，Iterator (time2-time1,time2-time1,...),</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">val</span> pageidTimeRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pageIdTimeRDD<span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>   <span class="token comment">//  5. 结构转换  (pageid1，(timeSum/Count))</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    pageidTimeRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token keyword">case</span><span class="token punctuation">(</span>pageID<span class="token punctuation">,</span>iter<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token keyword">val</span> count<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> iter<span class="token punctuation">.</span>size</pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token keyword">val</span> timeSum<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> iter<span class="token punctuation">.</span>sum</pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>        println<span class="token punctuation">(</span><span class="token string">"页面id："</span> <span class="token operator">+</span> pageID <span class="token operator">+</span> <span class="token string">",访问次数："</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">",平均停留时间："</span> <span class="token operator">+</span> timeSum<span class="token operator">/</span>count<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">+</span> <span class="token string">"毫秒"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token keyword">override</span> <span class="token keyword">def</span> analysis<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="2745-运行结果"><a class="anchor" href="#2745-运行结果">#</a> 2.7.4.5 运行结果</h5><p>![image-20200611182010445](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611182010.png)</p><h4 id="275-需求4总结"><a class="anchor" href="#275-需求4总结">#</a> 2.7.5 需求 4 总结</h4><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 时间格式转换成时间戳</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">val</span> dataFormat <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">val</span> action_time<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> action<span class="token punctuation">.</span>action_time</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">val</span> time<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> dataFormat<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>action_time<span class="token punctuation">)</span><span class="token punctuation">.</span>getTime</pre></td></tr></table></figure><h2 id="三-项目总结"><a class="anchor" href="#三-项目总结">#</a> 三 、项目总结</h2><h3 id="31-踩过的坑"><a class="anchor" href="#31-踩过的坑">#</a> 3.1 踩过的坑</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 总结 1：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>在写累加器的时候出现如下情况：</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">1.</span> 在获取遍历累加器的值时，使用了map算子，错误，应该使用foreach，因为map不是行动算子，不会执行遍历的操作</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">2.</span> 更新<span class="token keyword">add</span>方法时，数据累加出现错误，最后执行结果为<span class="token number">0</span>，发现是</pre></td></tr><tr><td data-num="5"></td><td><pre>     bean<span class="token punctuation">.</span>clickCount <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span> 写成了 bean<span class="token punctuation">.</span>clickCount <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">3.</span> 进行数据累加时，发现通不过，原来的是封装的HotCagetoryBean，属性均是val类型，不可变，需改为var类型</pre></td></tr><tr><td data-num="7"></td><td><pre>   </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">-- 总结 2：</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token number">1.</span> 在进行数据组合时，分割符和原始数据的分隔符一致，导致后面进行数据切分时，数据产生了丢失。</pre></td></tr><tr><td data-num="10"></td><td><pre>      开始是：<span class="token string">"(品类-session，count)"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      修正后：<span class="token string">"(品类&amp;session，count)"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">-- 总结 3：</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token number">1.</span> 计算转换率的时候算子使用错误，使用map没有结果，后来更换成foreach就可以了，因为map不是行动算子，不会执行遍历的操作。</pre></td></tr><tr><td data-num="15"></td><td><pre>   </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">-- 总结 4：</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token number">1.</span> 时间格式转换成时间戳，一定不要写错</pre></td></tr><tr><td data-num="18"></td><td><pre>      yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd HH:mm:ss:代表将时间转换为<span class="token number">24</span>小时制<span class="token punctuation">,</span>例: <span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">15</span>:<span class="token number">24</span>:<span class="token number">21</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd hh:mm:ss:代表将时间转换为<span class="token number">12</span>小时制<span class="token punctuation">,</span>例: <span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">03</span>:<span class="token number">24</span>:<span class="token number">21</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   </pre></td></tr><tr><td data-num="21"></td><td><pre>        val dataFormat <span class="token operator">=</span> new SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd hh:mm:ss"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        val action_time: String <span class="token operator">=</span> <span class="token keyword">action</span><span class="token punctuation">.</span>action_time</pre></td></tr><tr><td data-num="23"></td><td><pre>        val <span class="token keyword">time</span>: Long <span class="token operator">=</span> dataFormat<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>action_time<span class="token punctuation">)</span><span class="token punctuation">.</span>getTime</pre></td></tr></table></figure><p>![image-20200611154033754](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200611154033.png)</p><h3 id="32-逻辑及优化总结"><a class="anchor" href="#32-逻辑及优化总结">#</a> 3.2 逻辑及优化总结</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 逻辑部分：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token number">1.</span> 弄清楚数据来源和最终结果数据</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">2.</span> 梳理好中间各个实现步骤</pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">3.</span> 清楚各个算子之间的作用以及目的</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token number">4.</span> 逻辑梳理完成以后，完成代码是很简单的事情</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">-- 优化</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token number">1.</span> 尽量减少使用有shuffle阶段的算子，如果一定需要有，尽量减少shuffle阶段数据的Io</pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token number">2.</span> 可以考虑使用累加器来减少shuffle</pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token number">3.</span> 逻辑代码层次拆分，逻辑控制层、逻辑执行层、资源连接层，且所有层共享的数据，放置在线程的共享内存中</pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token number">4.</span> 原始数据使用样例类进行封装，减少代码的耦合</pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token number">5.</span> 如果涉及到Driver向每个executor传递数据量大的对象，那么采用广播变量的方式，减少IO</pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token number">6.</span> 如果涉及到一个变量重复使用，考虑变量的持久化，cache <span class="token operator">+</span> <span class="token keyword">checkPoint</span> </pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token number">7.</span> 两个map之间的合并方式一定要学会，在实际开发过程中，使用的场景很多</pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token number">8.</span> 使用累加器的时候，特别注意，如果算子执行两次，那么结果会累计计算两次</pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token number">9.</span> 排查错误时，自下而上进行排查，可以打印阶段性计算结果，看看是否是自己预期的结果。</pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token number">10.</span> 数据一般先进行过滤，再进行计算，减少数据的传输</pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token number">11.</span> reduceBykey不一定会有shuffle阶段。</pre></td></tr></table></figure></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2020-06-11 21:25:42" itemprop="dateModified" datetime="2020-06-11T21:25:42+08:00">2020-06-11</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Miyazono 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Miyazono 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Miyazono 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/big-data/spark/4.%20Spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E2%80%94%E2%80%94%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/">https://github.com/Mayizono/miyazono.github.io/big-data/spark/4. Spark实战项目——电商指标统计/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/big-data/spark/3.Spark%E7%BC%96%E7%A8%8B2/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclga70tsj20zk0m84mr.jpg" title="未命名"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div><div class="item right"><a href="/big-data/spark/5.Spark%E4%B9%8BWordCount/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipexe4oykj20zk0m87ji.jpg" title="未命名"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">Spark 实战项目 —— 电商指标统计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%BC%95%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">一、引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 框架设计原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 框架搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#121-util"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">1.2.1 Util</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1211-envutils"><span class="toc-number">1.1.2.1.1.</span> <span class="toc-text">1.2.1.1 EnvUtils</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1212-propertiesutil"><span class="toc-number">1.1.2.1.2.</span> <span class="toc-text">1.2.1.2 PropertiesUtil</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#122-core"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">1.2.2 core</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1221-tapplication"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">1.2.2.1 TApplication</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1222-tcontroller"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">1.2.2.2 TController</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1223-tservice"><span class="toc-number">1.1.2.2.3.</span> <span class="toc-text">1.2.2.3 TService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1224-tdao"><span class="toc-number">1.1.2.2.4.</span> <span class="toc-text">1.2.2.4 TDAO</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.2.</span> <span class="toc-text">二 、 实战项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E9%A1%B9%E7%9B%AE%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 项目思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 原始数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E5%87%86%E5%A4%87%E6%A0%B7%E4%BE%8B%E7%B1%BB"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 准备样例类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-%E9%9C%80%E6%B1%821top10%E7%83%AD%E9%97%A8%E5%93%81%E7%B1%BB"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 需求 1：Top10 热门品类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#241-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">2.4.1 数据结构分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#242-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">2.4.2 数据结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#245-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">2.4.5 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#226-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">2.2.6 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2261-bean"><span class="toc-number">1.2.4.4.1.</span> <span class="toc-text">2.2.6.1 bean</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2262-hotcategorytop10applicationreview"><span class="toc-number">1.2.4.4.2.</span> <span class="toc-text">2.2.6.2 HotCategoryTOP10ApplicationReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2263-hotcategorytop10controllerreview"><span class="toc-number">1.2.4.4.3.</span> <span class="toc-text">2.2.6.3 HotCategoryTop10ControllerReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2264-hotcategorytop10daoreview"><span class="toc-number">1.2.4.4.4.</span> <span class="toc-text">2.2.6.4 HotCategoryTop10DAOReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2265-hotcategorytop10servicereview"><span class="toc-number">1.2.4.4.5.</span> <span class="toc-text">2.2.6.5 HotCategoryTop10ServiceReview</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#227-%E4%BC%98%E5%8C%96%E4%BD%BF%E7%94%A8%E7%B4%AF%E5%8A%A0%E5%99%A8"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">2.2.7 优化：使用累加器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2271-%E6%9B%B4%E6%96%B0bean"><span class="toc-number">1.2.4.5.1.</span> <span class="toc-text">2.2.7.1 更新 bean</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2272-%E7%B4%AF%E5%8A%A0%E5%99%A8-hotcategorytop10accumulatorreview"><span class="toc-number">1.2.4.5.2.</span> <span class="toc-text">2.2.7.2 累加器 ： HotCategoryTop10AccumulatorReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2273-%E6%9B%B4%E6%96%B0hotcategorytop10servicereview"><span class="toc-number">1.2.4.5.3.</span> <span class="toc-text">2.2.7.3 更新 HotCategoryTop10ServiceReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2274-%E5%85%B6%E4%BD%99%E7%BB%93%E6%9E%84%E4%B8%8D%E5%8F%98"><span class="toc-number">1.2.4.5.4.</span> <span class="toc-text">2.2.7.4 其余结构不变</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2275-%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.4.5.5.</span> <span class="toc-text">2.2.7.5 运行结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#228-%E9%9C%80%E6%B1%821%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">2.2.8 需求 1 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25-%E9%9C%80%E6%B1%822top10%E7%83%AD%E9%97%A8%E5%93%81%E7%B1%BB%E4%B8%AD%E6%AF%8F%E4%B8%AA%E5%93%81%E7%B1%BB%E7%9A%84top10%E6%B4%BB%E8%B7%83%E7%82%B9%E5%87%BBsession%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5 需求 2：Top10 热门品类中每个品类的 Top10 活跃点击 Session 统计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#251-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">2.5.1 数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#252-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">2.5.2 数据结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#253-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">2.5.3 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#254-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">2.5.4 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2541-hotcategorysessiontop10applicationreview"><span class="toc-number">1.2.5.4.1.</span> <span class="toc-text">2.5.4.1 HotCategorySessionTOP10ApplicationReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2542-hotcategorysessionop10controllerreview"><span class="toc-number">1.2.5.4.2.</span> <span class="toc-text">2.5.4.2 HotCategorySessionop10ControllerReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2543-hotcategorysessiontop10daoreview"><span class="toc-number">1.2.5.4.3.</span> <span class="toc-text">2.5.4.3 HotCategorySessionTop10DAOReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2544-hotcategorysessiontop10servicereview"><span class="toc-number">1.2.5.4.4.</span> <span class="toc-text">2.5.4.4 HotCategorySessionTop10ServiceReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2545-%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.5.4.5.</span> <span class="toc-text">2.5.4.5 运行结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#255-%E4%BC%98%E5%8C%96%E4%BD%BF%E7%94%A8%E5%B9%BF%E6%92%AD%E5%8F%98%E9%87%8F"><span class="toc-number">1.2.5.5.</span> <span class="toc-text">2.5.5 优化：使用广播变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#256-%E9%9C%80%E6%B1%822%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.5.6.</span> <span class="toc-text">2.5.6 需求 2 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#26-%E9%9C%80%E6%B1%823%E9%A1%B5%E9%9D%A2%E5%8D%95%E8%B7%B3%E8%BD%AC%E6%8D%A2%E7%8E%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.2.6.</span> <span class="toc-text">2.6 需求 3：页面单跳转换率统计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#261-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">2.6.1 数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#262-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">2.6.2 数据结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#263-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">2.6.3 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#264-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">2.6.4 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2641-pageflowapplicationreview"><span class="toc-number">1.2.6.4.1.</span> <span class="toc-text">2.6.4.1 PageFlowApplicationReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2642-pageflowcontrollerreview"><span class="toc-number">1.2.6.4.2.</span> <span class="toc-text">2.6.4.2 PageFlowControllerReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2643-pageflowdaoreview"><span class="toc-number">1.2.6.4.3.</span> <span class="toc-text">2.6.4.3 PageFlowDAOReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2644-pageflowservicereview"><span class="toc-number">1.2.6.4.4.</span> <span class="toc-text">2.6.4.4 PageFlowServiceReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2645-%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.6.4.5.</span> <span class="toc-text">2.6.4.5 运行结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#264-%E6%8C%87%E5%AE%9A%E9%A1%B5%E9%9D%A2%E8%BD%AC%E6%8D%A2%E7%8E%87"><span class="toc-number">1.2.6.5.</span> <span class="toc-text">2.6.4 指定页面转换率</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2641-%E4%BF%AE%E6%94%B9pageflowservicereview"><span class="toc-number">1.2.6.5.1.</span> <span class="toc-text">2.6.4.1 修改 PageFlowServiceReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2642-%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.6.5.2.</span> <span class="toc-text">2.6.4.2 运行结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#265-%E9%9C%80%E6%B1%823%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.6.6.</span> <span class="toc-text">2.6.5 需求 3 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#27-%E9%9C%80%E6%B1%824-%E7%BB%9F%E8%AE%A1%E9%A1%B5%E9%9D%A2id%E7%9A%84%E5%B9%B3%E5%9D%87%E5%81%9C%E7%95%99%E6%97%B6%E9%97%B4"><span class="toc-number">1.2.7.</span> <span class="toc-text">2.7 需求 4 ：统计页面 id 的平均停留时间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#271-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">2.7.1 数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#272-%E9%9C%80%E6%B1%82%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">2.7.2 需求结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#273-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">2.7.3 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#274-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.7.4.</span> <span class="toc-text">2.7.4 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2741-%E4%BF%AE%E6%94%B9pageflowservicereview"><span class="toc-number">1.2.7.4.1.</span> <span class="toc-text">2.7.4.1 修改 PageFlowServiceReview</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2745-%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.7.4.2.</span> <span class="toc-text">2.7.4.5 运行结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#275-%E9%9C%80%E6%B1%824%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.7.5.</span> <span class="toc-text">2.7.5 需求 4 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.</span> <span class="toc-text">三 、项目总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 踩过的坑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E9%80%BB%E8%BE%91%E5%8F%8A%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 逻辑及优化总结</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">23</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/amehime" title="https:&#x2F;&#x2F;github.com&#x2F;amehime" class="item github"><i class="ic i-github"></i></a> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9hbWVoaW1l" title="https:&#x2F;&#x2F;twitter.com&#x2F;amehime"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyODg2ODIz" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;12886823"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9hbWVoaW1l" title="https:&#x2F;&#x2F;about.me&#x2F;amehime"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/big-data/spark/3.Spark%E7%BC%96%E7%A8%8B2/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/big-data/spark/5.Spark%E4%B9%8BWordCount/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/3.Spark%E7%BC%96%E7%A8%8B2/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/6_%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/3_ElasticSearch/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flume/" title="分类于 Flume">Flume</a></div><span><a href="/big-data/flume/Flume/" title="Flume基础学习">Flume基础学习</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/4_Kibana/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/6.SparkSQL/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/2_Canal/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/1.Spark%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/2.Spark%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BC%96%E7%A8%8B/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/" title="未命名">未命名</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">324k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:54</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"big-data/spark/4. Spark实战项目——电商指标统计/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->