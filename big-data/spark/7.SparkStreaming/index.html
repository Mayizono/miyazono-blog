<!-- build time:Tue Aug 31 2021 19:41:45 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/big-data/spark/7.SparkStreaming/"><title>| Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"></h1><div class="meta"><span class="item" title="创建时间：2021-08-31 18:42:35"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-31T18:42:35+08:00">2021-08-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>9.4k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>9 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclgrvbd6j20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicljgocqbj20zk0m8e81.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicitspjpbj20zk0m81ky.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giph47e9vtj20zk0m8x6l.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipesrnqv3j20zk0m8ava.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/big-data/spark/7.SparkStreaming/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><h1 id="sparkstreaming"><a class="anchor" href="#sparkstreaming">#</a> SparkStreaming</h1><hr><h2 id="一-sparkstreaming-介绍"><a class="anchor" href="#一-sparkstreaming-介绍">#</a> 一、SparkStreaming 介绍</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--0. 几个概念</span></pre></td></tr><tr><td data-num="2"></td><td><pre>         a、<span class="token string">'实时'</span>：数据处理的延迟，以毫秒级进行响应</pre></td></tr><tr><td data-num="3"></td><td><pre>         b、<span class="token string">'离线'</span>：数据处理的延迟，以小时、天、月、年为级别响应</pre></td></tr><tr><td data-num="4"></td><td><pre>         c、<span class="token string">'批处理'</span>：数据处理的方式，一次处理一批数据</pre></td></tr><tr><td data-num="5"></td><td><pre>         d、<span class="token string">'流式处理'</span>：数据处理的方式，和水流相似，来一条数据处理一条数据，来一点处理一点，一个一个的处理。</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">--1. 什么是 SparkStreaming</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         a、流式数据处理，但是实际情况是无法到达真正流式处理，因为底层还是RDD，不能来一条数据处理一条数据</pre></td></tr><tr><td data-num="8"></td><td><pre>            那样IO会非常多。</pre></td></tr><tr><td data-num="9"></td><td><pre>         b、接收来自kafka、flume、Twitter等框架的数据</pre></td></tr><tr><td data-num="10"></td><td><pre>         c、是<span class="token string">"准实时""微批次"</span>数据处理引擎，使用类似RDD算子进行数据处理，这里的处理的方法称为原语，数据处理的逻辑</pre></td></tr><tr><td data-num="11"></td><td><pre>            是相对比较简单的，如果处理的逻辑很复杂，计算时间就会比较长，那么就不能算是准实时的处理</pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token string">"实时数仓将是未来的方向"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         d、<span class="token string">'处理的数据结果集'</span>可以发送到hdfs、mysql等一些框架中进存储。</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">--2. 基本流程</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         a、内部使用离散化流：用DStream表示。</pre></td></tr><tr><td data-num="16"></td><td><pre>         b、DStream是随时间推移而收到数据的序列，在内部，每个时间区间收到的数据作为RDD存在</pre></td></tr><tr><td data-num="17"></td><td><pre>         c、DStream是作为这些RDD所组成的序列</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">--3. 和 SparkCore/SparkSQL 之间的区别</span></pre></td></tr><tr><td data-num="20"></td><td><pre>         a、从环境对象上的区别：</pre></td></tr><tr><td data-num="21"></td><td><pre>             SparkCore  <span class="token comment">--> SparkContext, 使用 sc 表示</span></pre></td></tr><tr><td data-num="22"></td><td><pre>             SparkSQL <span class="token comment">--> SparkSeeion，内部是对 SparkContext 的封装，使用 spark 表示</span></pre></td></tr><tr><td data-num="23"></td><td><pre>             SparkStreaming<span class="token comment">--> StreamingContext, 内部是对 SparkContext 的封装</span></pre></td></tr><tr><td data-num="24"></td><td><pre>         b、处理抽象的区别：</pre></td></tr><tr><td data-num="25"></td><td><pre>             SparkCore <span class="token comment">--> RDD</span></pre></td></tr><tr><td data-num="26"></td><td><pre>             SparkSQL <span class="token comment">-->  DataFrame / DataSet</span></pre></td></tr><tr><td data-num="27"></td><td><pre>             SparkStreaming <span class="token comment">--> DStream</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token comment">-- 4. 关键词：</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          在SparkStreaming中：</pre></td></tr><tr><td data-num="31"></td><td><pre>          a、准实时</pre></td></tr><tr><td data-num="32"></td><td><pre>          b、微批次</pre></td></tr><tr><td data-num="33"></td><td><pre>          c、采集周期：每采集一次数据，就会生成一个RDD</pre></td></tr><tr><td data-num="34"></td><td><pre>          d、DStream</pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">--5. 框架图</span></pre></td></tr><tr><td data-num="37"></td><td><pre>           a、在executor中有一个采集器，通过采集器，按照采集周期从指定的地方进行采集数据</pre></td></tr><tr><td data-num="38"></td><td><pre>           b、生成的rdd传递给到Driver端，driver端的StreamingContext用来处理所有数据的Spark作业。</pre></td></tr><tr><td data-num="39"></td><td><pre>           c、底层就封装成了RDD，后面的数据处理流程就和SparkCore处理的流程一致。</pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">--6. 背压机制：</span></pre></td></tr><tr><td data-num="42"></td><td><pre>           a、背景：</pre></td></tr><tr><td data-num="43"></td><td><pre>               由于数据是源源不断向采集器中发送，那么当生产数据的速度<span class="token operator">></span>数据处理的速度时，就会产生背压。</pre></td></tr><tr><td data-num="44"></td><td><pre>           b、解决方法：</pre></td></tr><tr><td data-num="45"></td><td><pre>               在spark1<span class="token punctuation">.</span><span class="token number">5</span>之前：</pre></td></tr><tr><td data-num="46"></td><td><pre>                   通过参数“spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>maxRate”来限制接收器接收数据的效率，但是当生产数据的速度 <span class="token operator">></span> 设定接收                    数据的速度，且集群处理数据的速度<span class="token operator">></span>设定接收数据的速度，那么则产生了性能的浪费。</pre></td></tr><tr><td data-num="47"></td><td><pre>               Spark1<span class="token punctuation">.</span><span class="token number">5</span>以后：</pre></td></tr><tr><td data-num="48"></td><td><pre>                   通过参数“spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>backpressure<span class="token punctuation">.</span>enabled”动态的协调数据的接收速率和资源处理能力。</pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>           c、背压机制：根据jobSchedule返回作业的执行信息来动态调整接收器接收数据的速度。</pre></td></tr></table></figure><p>![image-20200617020834367](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200617020835.png)</p><p>![image-20200714002519802](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200714002526.png)</p><h2 id="二-dstream入门"><a class="anchor" href="#二-dstream入门">#</a> 二、DStream 入门</h2><h3 id="21-连接sparkcontext"><a class="anchor" href="#21-连接sparkcontext">#</a> 2.1 连接 SparkContext</h3><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 连接 SparkStreaming</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"sparkStreaming"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      1. 方法：StreamingContext (形参)</pre></td></tr><tr><td data-num="5"></td><td><pre>      2. 形参：</pre></td></tr><tr><td data-num="6"></td><td><pre>        形参 1：conf: SparkConf：spark 配置对象</pre></td></tr><tr><td data-num="7"></td><td><pre>        形参 2：batchDuration: Duration：采集时间</pre></td></tr><tr><td data-num="8"></td><td><pre>     */</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="22-案例"><a class="anchor" href="#22-案例">#</a> 2.2 案例</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. Spark 从 socket 中获取数据：一行一行的获取</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 2. Driver 程序执行时，streaming 处理过程不能结束</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 3. 采集器在正常情况下启动后就不应该停止，除非特殊情况</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">-- 4. 采集器位于一个 executor 中，是一个线程，执行时需要一个核，如果设定的总核数为 1 时，那么在运行时因为没有核数，所以不会有打印结果，所以 sparkStreaming 使用的核数至少为 2 个</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 5. print () 方法，默认是打印 10 行结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">-- 6. netcat 的指令：</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      在Windows下：nc <span class="token operator">-</span>lp <span class="token number">9999</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      在linux下： nc <span class="token operator">-</span>lk <span class="token number">9999</span></pre></td></tr></table></figure><ul><li>导入依赖</li></ul><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spark-streaming_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><ul><li>代码实现</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"sparkStreaming"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 需求：使用 netcat 工具向 9999 端口不断的发送数据，通过 SparkStreaming 读取端口数据并统计不同单词出现的次数</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 1. 获取 netcat 工具 9999 端口的连接，并开始接收数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 从 socket 中获取数据：一行一行的获取</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">val</span> socketDS<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 2. 数据处理</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">val</span> wordDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> socketDS<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">val</span> wordToSumDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> wordDS<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _ <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 3. 打印数据</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    wordToSumDS<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 4. Driver 程序执行时，streaming 处理过程不能结束</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 采集器在正常情况下启动后就不应该停止，除非特殊情况</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 启动采集器</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 等待采集器的结束</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><ul><li>wordcount 解析</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a、采集周期时间之间，每一个采集周期生成一个RDD，按照时间的顺序依次进行</pre></td></tr><tr><td data-num="2"></td><td><pre>b、在每一个采集周期内，会执行wordcount计算，最终得出:统计出每一个采集周期时间的wordcount</pre></td></tr></table></figure><h2 id="三-dstream的创建"><a class="anchor" href="#三-dstream的创建">#</a> 三、Dstream 的创建</h2><h3 id="31-rdd队列"><a class="anchor" href="#31-rdd队列">#</a> 3.1 RDD 队列</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 1. 队列：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       a、使用场景：测试</pre></td></tr><tr><td data-num="3"></td><td><pre>       b、实现方式: 通过ssc<span class="token punctuation">.</span>queueStream<span class="token punctuation">(</span>queueOfRDDs<span class="token punctuation">)</span>创建DStream，每一个推送这个队列的RDD，都会作为一个DStream处理</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span>  sparkconf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"stream"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkconf<span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 创建一个队列对象，队列中存放的是 RDD</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">val</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> mutable<span class="token punctuation">.</span>Queue<span class="token punctuation">[</span>RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 通过队列创建 DStream</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">val</span> queueDS<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>queueStream<span class="token punctuation">(</span>queue<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    queueDS<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 启动采集器</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>       <span class="token comment">// 这个操作之所以放在这个位置，是为了模拟流式的感觉，数据源源不断的生产</span></pre></td></tr><tr><td data-num="14"></td><td><pre>       <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token comment">// 循环创建 rdd</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token keyword">val</span> rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>List<span class="token punctuation">(</span>i<span class="token punctuation">.</span>toString<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token comment">// 将 RDD 存放到队列中</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          queue<span class="token punctuation">.</span>enqueue<span class="token punctuation">(</span>rdd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token comment">// 当前线程休眠 1 秒</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span>         </pre></td></tr><tr><td data-num="21"></td><td><pre>       <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 等待采集器的结束</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="32-textfilestream"><a class="anchor" href="#32-textfilestream">#</a> 3.2 textFileStream</h3><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"textFileStream"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 从文件中读取数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">val</span> textDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>textFileStream<span class="token punctuation">(</span><span class="token string">"in"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    textDS<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 启动采集器</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 等待采集器的结束</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="33-diy采集器"><a class="anchor" href="#33-diy采集器">#</a> 3.3 DIY 采集器</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1. 自定义采集器</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">--2. 什么情况下需要自定采集器呢？</span></pre></td></tr><tr><td data-num="3"></td><td><pre>         比如从mysql、hbase中读取数据。</pre></td></tr><tr><td data-num="4"></td><td><pre>         采集器的作用是从指定的地方，按照采集周期对数据进行采集。</pre></td></tr><tr><td data-num="5"></td><td><pre>         目前有：采集kafka、采集netcat工具的指定端口的数据、采集文件目录中的数据等</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">--3. 自定义采集器的步骤，模仿 socketTextStream</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         a、自定采集器类，继承extends，并指定数据泛型，同时对父类的属性赋值，指定数据存储的级别</pre></td></tr><tr><td data-num="8"></td><td><pre>         b、重写onStart和onStop方法</pre></td></tr><tr><td data-num="9"></td><td><pre>            onStart:采集器的如何启动</pre></td></tr><tr><td data-num="10"></td><td><pre>            onStop:采集的如何停止</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"DIY"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 获取采集的流</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">val</span> ds<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>receiverStream<span class="token punctuation">(</span><span class="token keyword">new</span> MyReciver<span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    ds<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 继承 extends Reciver，并指定数据泛型，同时对父类的属性赋值，指定数据存储的级别</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">class</span> MyReciver<span class="token punctuation">(</span>host<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Receiver<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>StorageLevel<span class="token punctuation">.</span>MEMORY_ONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">var</span> socket<span class="token operator">:</span> Socket <span class="token operator">=</span> _</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">def</span> receive <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     <span class="token comment">// 获取输入流</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token keyword">val</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> BufferedReader<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">new</span> InputStreamReader<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          socket<span class="token punctuation">.</span>getInputStream<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token string">"UTF-8"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">// 设定一个间接变量</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">var</span> s<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 按行读取数据</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        s <span class="token operator">=</span> reader<span class="token punctuation">.</span>readLine<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token comment">// 将数据进行封装</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          store<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 1. 启动采集器</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">override</span> <span class="token keyword">def</span> onStart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      socket <span class="token operator">=</span> <span class="token keyword">new</span> Socket<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token keyword">new</span> Thread<span class="token punctuation">(</span><span class="token string">"Socket Receiver"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        setDaemon<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          receive</pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">// 2. 停止采集器</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">override</span> <span class="token keyword">def</span> onStop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      socket <span class="token operator">=</span> <span class="token keyword">null</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="34-kafka数据源重点"><a class="anchor" href="#34-kafka数据源重点">#</a> 3.4 kafka 数据源【重点】</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- DirectAPI：是由计算的 Executor 来主动消费 Kafka 的数据，速度由自身控制。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 配置信息基本上是固定写法</span></pre></td></tr></table></figure><ul><li>实现方式</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// TODO Spark 环境</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// SparkStreaming 使用核数最少是 2 个</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">val</span> sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"streaming"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// TODO 使用 SparkStreaming 读取 Kafka 的数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// Kafka 的配置信息</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">val</span> kafkaPara<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      ConsumerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG <span class="token operator">-></span> <span class="token string">"hadoop105:9092,hadoop106:9092,hadoop107:9092"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      ConsumerConfig<span class="token punctuation">.</span>GROUP_ID_CONFIG <span class="token operator">-></span> <span class="token string">"atguigu"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token string">"key.deserializer"</span> <span class="token operator">-></span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token string">"value.deserializer"</span> <span class="token operator">-></span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        ssc<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Set<span class="token punctuation">(</span><span class="token string">"atguigu"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaPara<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 获取数据，key 是 null，value 是真实的数据</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">val</span> valueDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> kafkaDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>record <span class="token keyword">=></span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   </pre></td></tr><tr><td data-num="25"></td><td><pre>    valueDStream<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 等待采集器的结束</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="四-dstream的转换"><a class="anchor" href="#四-dstream的转换">#</a> 四、DStream 的转换</h2><h3 id="41-介绍"><a class="anchor" href="#41-介绍">#</a> 4.1 介绍</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1. Dstream：DStream 的操作和 RDD 类似，Transformations（转换）和 Output Operations（输出）</span></pre></td></tr><tr><td data-num="2"></td><td><pre>         a、Transformations（转换）:类似RDD的转换算子，还有一些比较特殊的原语：</pre></td></tr><tr><td data-num="3"></td><td><pre>                                  updateStateByKey<span class="token punctuation">(</span><span class="token punctuation">)</span>、transform<span class="token punctuation">(</span><span class="token punctuation">)</span>以及各种Window相关的原语</pre></td></tr><tr><td data-num="4"></td><td><pre>         b、Output Operations（输出）：类似RDD的行动算子</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">--2. 转换分为：</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          a、无状态转换：计算结果完成以后，不会保存数据</pre></td></tr><tr><td data-num="8"></td><td><pre>          b、有状态转换：把中间的数据保存起来</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token comment">-- 3. 代码执行的位置：</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          a、rdd算子外的代码在driver端执行</pre></td></tr><tr><td data-num="12"></td><td><pre>          b、rdd算子内的代码在executor端执行</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>   "每一个采集周期会生产一个rdd</pre></td></tr></table></figure><h3 id="42-无状态转换"><a class="anchor" href="#42-无状态转换">#</a> 4.2 无状态转换</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1. 什么是无状态转换：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        就是将简单的RDD操作转化操作应用到每个批次上，也就是转化DStream每一个RDD。</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token comment">--2. 部分无状态转换的操作有</span></pre></td></tr><tr><td data-num="4"></td><td><pre>       map、flatmap、filter、repartition、reducebykey</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token comment">--3. 注意：</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      a、针对键值对的DStream操作，如reduceBykey需要添加<span class="token keyword">import</span> StreamingContext<span class="token punctuation">.</span>_才能在Scala中使用。</pre></td></tr><tr><td data-num="7"></td><td><pre>      b、reduceBykey会规约每一个时间区间中的数据，但是不会规约不同时间区间的数据</pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token comment">--4. 部分无状态转换算子如下：</span></pre></td></tr></table></figure><p>![image-20200622012037225](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200622012037.png)</p><h4 id="421-transform"><a class="anchor" href="#421-transform">#</a> 4.2.1 transform</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1. 方法：transform [U: ClassTag](transformFunc: RDD [T] => RDD [U]): DStream [U]</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">--2. 泛型：可以指定一个泛型，这个泛型则规定了转换后的 RDD 和 DStream 的类型</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">--3. 形参：是一个函数：transformFunc</span></pre></td></tr><tr><td data-num="4"></td><td><pre>             函数的形参：每个采集周期生成的RDD；</pre></td></tr><tr><td data-num="5"></td><td><pre>             函数的返回值：RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span>，返回一个RDD，RDD的数据类型和指定的泛型一致。</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">--4. 操作的作用：</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        每个采集周期生成的RDD都会调用一次这个操作。主要是进行RDD的转换，在转换的过程，可以对数据进行处理。</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">--5. 什么时候使用？</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        与采集周期相关的时候使用，这里主要的因为代码执行的次数有关</pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token comment">//code1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            transform<span class="token punctuation">(</span>rdd <span class="token operator">=</span><span class="token operator">></span> &#123;</pre></td></tr><tr><td data-num="12"></td><td><pre>             <span class="token comment">// code2</span></pre></td></tr><tr><td data-num="13"></td><td><pre>           rdd<span class="token punctuation">.</span>flatMap&#123;</pre></td></tr><tr><td data-num="14"></td><td><pre>             <span class="token comment">// code3</span></pre></td></tr><tr><td data-num="15"></td><td><pre>           &#125;</pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>       <span class="token string">"说明"</span>：</pre></td></tr><tr><td data-num="19"></td><td><pre>        code1：在driver中执行，只会执行<span class="token number">1</span>次</pre></td></tr><tr><td data-num="20"></td><td><pre>        code2：每一个采集周期会生产一个RDD，每生成一个RDD会执行一次</pre></td></tr><tr><td data-num="21"></td><td><pre>        code3：每一个RDD中的数据，会执行一次</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span> transformDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ds<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token keyword">val</span> value<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdd<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      value</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>![image-20200714011137027](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200714011137.png)</p><p>![image-20200714011247518](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200714011247.png)</p><h4 id="422-join"><a class="anchor" href="#422-join">#</a> 4.2.2 join</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 无状态转换操作之 join</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">1.</span> 操作：<span class="token keyword">join</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2.</span> 说明：必须是kv形式的RDD</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token number">3.</span> 作用：</pre></td></tr><tr><td data-num="5"></td><td><pre>       a、两个流之间的<span class="token keyword">join</span>需要两个流的批次大小一致，这样才能做到同时触发计算。</pre></td></tr><tr><td data-num="6"></td><td><pre>       b、计算过程就是对当前批次的两个流中各自的RDD进行<span class="token keyword">join</span>，与两个RDD的<span class="token keyword">join</span>效果相同。</pre></td></tr></table></figure><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"join"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">val</span> ds1<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">val</span> ds2<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">8888</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">val</span> ds11<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ds1<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">val</span> ds22<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ds2<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    ds11<span class="token punctuation">.</span>join<span class="token punctuation">(</span>ds22<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="43-有状态转换"><a class="anchor" href="#43-有状态转换">#</a> 4.3 有状态转换</h3><pre><code>有状态的转换：将spark每个采集周期处理结果保存起来，然后再一次数据的处理中可以继续使用
</code></pre><h4 id="431-updatestatebykey"><a class="anchor" href="#431-updatestatebykey">#</a> 4.3.1 updateStateByKey</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1. updateStateByKey (形参)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">--2. 泛型：[S: ClassTag]：指定缓冲区中数据的泛型和操作返回值的 v 返回值类型</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">--3. 形参：是一个函数，</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            函数有两个形参</pre></td></tr><tr><td data-num="5"></td><td><pre>                形参<span class="token number">1</span>：seq：Seq<span class="token punctuation">[</span>V<span class="token punctuation">]</span>：相同<span class="token keyword">key</span>的<span class="token keyword">value</span>的集合</pre></td></tr><tr><td data-num="6"></td><td><pre>                形参<span class="token number">2</span>：buffer：<span class="token keyword">Option</span><span class="token punctuation">[</span>S<span class="token punctuation">]</span>：缓冲区，相同<span class="token keyword">key</span>的缓冲区数据，有可能为空</pre></td></tr><tr><td data-num="7"></td><td><pre>            函数的返回值：<span class="token keyword">Option</span><span class="token punctuation">[</span>S<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">--4. 操作的返回值：DStream [(K, S)]：</span></pre></td></tr><tr><td data-num="9"></td><td><pre>       是一个新的DStream，其内部的RDD序列是由每个时间区间对应的<span class="token punctuation">(</span>键，状态<span class="token punctuation">)</span>对组成的</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">--5. 作用：</span></pre></td></tr><tr><td data-num="12"></td><td><pre>       计算的最后结果需要使用到前面的采集周期的计算结果，如计算wordcount</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">--6. 说明：</span></pre></td></tr><tr><td data-num="15"></td><td><pre>       a、用于键值对形式的DStream</pre></td></tr><tr><td data-num="16"></td><td><pre>       b、使用updateStateByKey需要对检查点目录进行配置，会使用检查点来保存状态</pre></td></tr></table></figure><p>![image-20200714012326922](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200714012326.png)</p><ul><li>代码实现</li></ul><figure class="highlight scala"><figcaption data-lang="scala"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 设置检查点的目录</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>setCheckpointDir<span class="token punctuation">(</span><span class="token string">"./ck"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">val</span> ds<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">val</span> stateDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ds<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateStateByKey <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">case</span> <span class="token punctuation">(</span>values<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 对相同 key 的 value 进行求和</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> values<span class="token punctuation">.</span>sum</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 将相同 key 的 value 计算结果保存到 buffer 中</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        Option<span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    stateDS<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="432-reducebykeyandwindow"><a class="anchor" href="#432-reducebykeyandwindow">#</a> 4.3.2 reduceByKeyandwindow</h4><p>![image-20200714012641927](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200714012641.png)</p><p>![image-20200714013055313](<span class="exturl" data-url="aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200714013055.png)</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2020-08-24 09:33:23" itemprop="dateModified" datetime="2020-08-24T09:33:23+08:00">2020-08-24</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Miyazono 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Miyazono 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Miyazono 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/big-data/spark/7.SparkStreaming/">https://github.com/Mayizono/miyazono.github.io/big-data/spark/7.SparkStreaming/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/big-data/spark/6.SparkSQL/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicitzannuj20zk0m8b29.jpg" title="未命名"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div><div class="item right"><a href="/big-data/spark/8.Spark%E5%86%85%E6%A0%B8/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclflwv2aj20zk0m84qp.jpg" title="未命名"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sparkstreaming"><span class="toc-number">1.</span> <span class="toc-text">SparkStreaming</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-sparkstreaming-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">一、SparkStreaming 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-dstream%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.</span> <span class="toc-text">二、DStream 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E8%BF%9E%E6%8E%A5sparkcontext"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 连接 SparkContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E6%A1%88%E4%BE%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-dstream%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">三、Dstream 的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-rdd%E9%98%9F%E5%88%97"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 RDD 队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-textfilestream"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 textFileStream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-diy%E9%87%87%E9%9B%86%E5%99%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 DIY 采集器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-kafka%E6%95%B0%E6%8D%AE%E6%BA%90%E9%87%8D%E7%82%B9"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 kafka 数据源【重点】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-dstream%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.</span> <span class="toc-text">四、DStream 的转换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E6%97%A0%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 无状态转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#421-transform"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1 transform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#422-join"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2 join</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-%E6%9C%89%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 有状态转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#431-updatestatebykey"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">4.3.1 updateStateByKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#432-reducebykeyandwindow"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">4.3.2 reduceByKeyandwindow</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">22</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">3</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/amehime" title="https:&#x2F;&#x2F;github.com&#x2F;amehime" class="item github"><i class="ic i-github"></i></a> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9hbWVoaW1l" title="https:&#x2F;&#x2F;twitter.com&#x2F;amehime"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyODg2ODIz" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;12886823"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9hbWVoaW1l" title="https:&#x2F;&#x2F;about.me&#x2F;amehime"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/big-data/spark/6.SparkSQL/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/big-data/spark/8.Spark%E5%86%85%E6%A0%B8/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/3.Spark%E7%BC%96%E7%A8%8B2/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/1_Nginx/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/4.%20Spark%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%E2%80%94%E2%80%94%E7%94%B5%E5%95%86%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/spark/7.SparkStreaming/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/3_ElasticSearch/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/6_%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/hadoop/hadoop/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/big-data/flink/5_%E6%97%A5%E6%B4%BB/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/big-data/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/big-data/flume/" title="分类于 Flume">Flume</a></div><span><a href="/big-data/flume/Flume/" title="Flume基础学习">Flume基础学习</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">311k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:43</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"big-data/spark/7.SparkStreaming/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->